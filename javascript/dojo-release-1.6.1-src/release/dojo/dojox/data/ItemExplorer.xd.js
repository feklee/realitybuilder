/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realitybuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.data.ItemExplorer"],["require","dijit.Tree"],["require","dijit.Dialog"],["require","dijit.Menu"],["require","dijit.form.ValidationTextBox"],["require","dijit.form.Textarea"],["require","dijit.form.Button"],["require","dijit.form.CheckBox"],["require","dijit.form.FilteringSelect"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.data.ItemExplorer"]){_4._hasResource["dojox.data.ItemExplorer"]=true;_4.provide("dojox.data.ItemExplorer");_4.require("dijit.Tree");_4.require("dijit.Dialog");_4.require("dijit.Menu");_4.require("dijit.form.ValidationTextBox");_4.require("dijit.form.Textarea");_4.require("dijit.form.Button");_4.require("dijit.form.CheckBox");_4.require("dijit.form.FilteringSelect");(function(){var _7=function(_8,_9,_a){var _b=_8.getValues(_9,_a);if(_b.length<2){_b=_8.getValue(_9,_a);}return _b;};_4.declare("dojox.data.ItemExplorer",_5.Tree,{useSelect:false,refSelectSearchAttr:null,constructor:function(_c){_4.mixin(this,_c);var _d=this;var _e={};var _f=this.rootModelNode={value:_e,id:"root"};this._modelNodeIdMap={};this._modelNodePropMap={};var _10=1;this.model={getRoot:function(_11){_11(_f);},mayHaveChildren:function(_12){return _12.value&&typeof _12.value=="object"&&!(_12.value instanceof Date);},getChildren:function(_13,_14,_15){var _16,_17,_18=_13.value;var _19=[];if(_18==_e){_14([]);return;}var _1a=_d.store&&_d.store.isItem(_18,true);if(_1a&&!_d.store.isItemLoaded(_18)){_d.store.loadItem({item:_18,onItem:function(_1b){_18=_1b;_1c();}});}else{_1c();}function _1c(){if(_1a){_16=_d.store.getAttributes(_18);_17=_18;}else{if(_18&&typeof _18=="object"){_17=_13.value;_16=[];for(var i in _18){if(_18.hasOwnProperty(i)&&i!="__id"&&i!="__clientId"){_16.push(i);}}}}if(_16){for(var key,k=0;key=_16[k++];){_19.push({property:key,value:_1a?_7(_d.store,_18,key):_18[key],parent:_17});}_19.push({addNew:true,parent:_17,parentNode:_13});}_14(_19);};},getIdentity:function(_1d){if(!_1d.id){if(_1d.addNew){_1d.property="--addNew";}_1d.id=_10++;if(_d.store){if(_d.store.isItem(_1d.value)){var _1e=_d.store.getIdentity(_1d.value);(_d._modelNodeIdMap[_1e]=_d._modelNodeIdMap[_1e]||[]).push(_1d);}if(_1d.parent){_1e=_d.store.getIdentity(_1d.parent)+"."+_1d.property;(_d._modelNodePropMap[_1e]=_d._modelNodePropMap[_1e]||[]).push(_1d);}}}return _1d.id;},getLabel:function(_1f){return _1f===_f?"Object Properties":_1f.addNew?(_1f.parent instanceof Array?"Add new value":"Add new property"):_1f.property+": "+(_1f.value instanceof Array?"("+_1f.value.length+" elements)":_1f.value);},onChildrenChange:function(_20){},onChange:function(_21){}};},postCreate:function(){this.inherited(arguments);_4.connect(this,"onClick",function(_22,_23){this.lastFocused=_23;if(_22.addNew){this._addProperty();}else{this._editProperty();}});var _24=new _5.Menu({targetNodeIds:[this.rootNode.domNode],id:"contextMenu"});_4.connect(_24,"_openMyself",this,function(e){var _25=_5.getEnclosingWidget(e.target);if(_25){var _26=_25.item;if(this.store.isItem(_26.value,true)&&!_26.parent){_4.forEach(_24.getChildren(),function(_27){_27.attr("disabled",(_27.label!="Add"));});this.lastFocused=_25;}else{if(_26.value&&typeof _26.value=="object"&&!(_26.value instanceof Date)){_4.forEach(_24.getChildren(),function(_28){_28.attr("disabled",(_28.label!="Add")&&(_28.label!="Delete"));});this.lastFocused=_25;}else{if(_26.property&&_4.indexOf(this.store.getIdentityAttributes(),_26.property)>=0){this.focusNode(_25);alert("Cannot modify an Identifier node.");}else{if(_26.addNew){this.focusNode(_25);}else{_4.forEach(_24.getChildren(),function(_29){_29.attr("disabled",(_29.label!="Edit")&&(_29.label!="Delete"));});this.lastFocused=_25;}}}}}});_24.addChild(new _5.MenuItem({label:"Add",onClick:_4.hitch(this,"_addProperty")}));_24.addChild(new _5.MenuItem({label:"Edit",onClick:_4.hitch(this,"_editProperty")}));_24.addChild(new _5.MenuItem({label:"Delete",onClick:_4.hitch(this,"_destroyProperty")}));_24.startup();},store:null,setStore:function(_2a){this.store=_2a;var _2b=this;if(this._editDialog){this._editDialog.destroyRecursive();delete this._editDialog;}_4.connect(_2a,"onSet",function(_2c,_2d,_2e,_2f){var _30,i,_31=_2b.store.getIdentity(_2c);_30=_2b._modelNodeIdMap[_31];if(_30&&(_2e===undefined||_2f===undefined||_2e instanceof Array||_2f instanceof Array||typeof _2e=="object"||typeof _2f=="object")){for(i=0;i<_30.length;i++){(function(_32){_2b.model.getChildren(_32,function(_33){_2b.model.onChildrenChange(_32,_33);});})(_30[i]);}}_30=_2b._modelNodePropMap[_31+"."+_2d];if(_30){for(i=0;i<_30.length;i++){_30[i].value=_2f;_2b.model.onChange(_30[i]);}}});this.rootNode.setChildItems([]);},setItem:function(_34){(this._modelNodeIdMap={})[this.store.getIdentity(_34)]=[this.rootModelNode];this._modelNodePropMap={};this.rootModelNode.value=_34;var _35=this;this.model.getChildren(this.rootModelNode,function(_36){_35.rootNode.setChildItems(_36);});},refreshItem:function(){this.setItem(this.rootModelNode.value);},_createEditDialog:function(){this._editDialog=new _5.Dialog({title:"Edit Property",execute:_4.hitch(this,"_updateItem"),preload:true});this._editDialog.placeAt(_4.body());this._editDialog.startup();var _37=_4.doc.createElement("div");var _38=_4.doc.createElement("label");_4.attr(_38,"for","property");_4.style(_38,"fontWeight","bold");_4.attr(_38,"innerHTML","Property:");_37.appendChild(_38);var _39=new _5.form.ValidationTextBox({name:"property",value:"",required:true,disabled:true}).placeAt(_37);_37.appendChild(_4.doc.createElement("br"));_37.appendChild(_4.doc.createElement("br"));var _3a=new _5.form.RadioButton({name:"itemType",value:"value",onClick:_4.hitch(this,function(){this._enableFields("value");})}).placeAt(_37);var _3b=_4.doc.createElement("label");_4.attr(_3b,"for","value");_4.attr(_3b,"innerHTML","Value (JSON):");_37.appendChild(_3b);var _3c=_4.doc.createElement("div");_4.addClass(_3c,"value");var _3d=new _5.form.Textarea({name:"jsonVal"}).placeAt(_3c);_37.appendChild(_3c);var _3e=new _5.form.RadioButton({name:"itemType",value:"reference",onClick:_4.hitch(this,function(){this._enableFields("reference");})}).placeAt(_37);var _3f=_4.doc.createElement("label");_4.attr(_3f,"for","_reference");_4.attr(_3f,"innerHTML","Reference (ID):");_37.appendChild(_3f);_37.appendChild(_4.doc.createElement("br"));var _40=_4.doc.createElement("div");_4.addClass(_40,"reference");if(this.useSelect){var _41=new _5.form.FilteringSelect({name:"_reference",store:this.store,searchAttr:this.refSelectSearchAttr||this.store.getIdentityAttributes()[0],required:false,value:null,pageSize:10}).placeAt(_40);}else{var _42=new _5.form.ValidationTextBox({name:"_reference",value:"",promptMessage:"Enter the ID of the item to reference",isValid:_4.hitch(this,function(_43){return true;})}).placeAt(_40);}_37.appendChild(_40);_37.appendChild(_4.doc.createElement("br"));_37.appendChild(_4.doc.createElement("br"));var _44=document.createElement("div");_44.setAttribute("dir","rtl");var _45=new _5.form.Button({type:"reset",label:"Cancel"}).placeAt(_44);_45.onClick=_4.hitch(this._editDialog,"onCancel");var _46=new _5.form.Button({type:"submit",label:"OK"}).placeAt(_44);_37.appendChild(_44);this._editDialog.attr("content",_37);},_enableFields:function(_47){switch(_47){case "reference":_4.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(_48){_5.getEnclosingWidget(_48).attr("disabled",true);});_4.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(_49){_5.getEnclosingWidget(_49).attr("disabled",false);});break;case "value":_4.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(_4a){_5.getEnclosingWidget(_4a).attr("disabled",false);});_4.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(_4b){_5.getEnclosingWidget(_4b).attr("disabled",true);});break;}},_updateItem:function(_4c){var _4d,_4e,val,_4f,_50=this._editDialog.attr("title")=="Edit Property";var _51=this._editDialog;var _52=this.store;function _53(){try{var _54,_55=[];var _56=_4c.property;if(_50){while(!_52.isItem(_4e.parent,true)){_4d=_4d.getParent();_55.push(_4e.property);_4e=_4d.item;}if(_55.length==0){_52.setValue(_4e.parent,_4e.property,val);}else{_4f=_7(_52,_4e.parent,_4e.property);if(_4f instanceof Array){_4f=_4f.concat();}_54=_4f;while(_55.length>1){_54=_54[_55.pop()];}_54[_55]=val;_52.setValue(_4e.parent,_4e.property,_4f);}}else{if(_52.isItem(_57,true)){if(!_52.isItemLoaded(_57)){_52.loadItem({item:_57,onItem:function(_58){if(_58 instanceof Array){_56=_58.length;}_52.setValue(_58,_56,val);}});}else{if(_57 instanceof Array){_56=_57.length;}_52.setValue(_57,_56,val);}}else{if(_4e.value instanceof Array){_55.push(_4e.value.length);}else{_55.push(_4c.property);}while(!_52.isItem(_4e.parent,true)){_4d=_4d.getParent();_55.push(_4e.property);_4e=_4d.item;}_4f=_7(_52,_4e.parent,_4e.property);_54=_4f;while(_55.length>1){_54=_54[_55.pop()];}_54[_55]=val;_52.setValue(_4e.parent,_4e.property,_4f);}}}catch(e){alert(e);}};if(_51.validate()){_4d=this.lastFocused;_4e=_4d.item;var _57=_4e.value;if(_4e.addNew){_57=_4d.item.parent;_4d=_4d.getParent();_4e=_4d.item;}val=null;switch(_4c.itemType){case "reference":this.store.fetchItemByIdentity({identity:_4c._reference,onItem:function(_59){val=_59;_53();},onError:function(){alert("The id could not be found");}});break;case "value":var _5a=_4c.jsonVal;val=_4.fromJson(_5a);if(typeof val=="function"){val.toString=function(){return _5a;};}_53();break;}}else{_51.show();}},_editProperty:function(){var _5b=_4.mixin({},this.lastFocused.item);if(!this._editDialog){this._createEditDialog();}else{this._editDialog.reset();}if(_4.indexOf(this.store.getIdentityAttributes(),_5b.property)>=0){alert("Cannot Edit an Identifier!");}else{this._editDialog.attr("title","Edit Property");_5.getEnclosingWidget(_4.query("input",this._editDialog.containerNode)[0]).attr("disabled",true);if(this.store.isItem(_5b.value,true)){if(_5b.parent){_5b.itemType="reference";this._enableFields(_5b.itemType);_5b._reference=this.store.getIdentity(_5b.value);this._editDialog.attr("value",_5b);this._editDialog.show();}}else{if(_5b.value&&typeof _5b.value=="object"&&!(_5b.value instanceof Date)){}else{_5b.itemType="value";this._enableFields(_5b.itemType);_5b.jsonVal=typeof _5b.value=="function"?_5b.value.toString():_5b.value instanceof Date?"new Date(\""+_5b.value+"\")":_4.toJson(_5b.value);this._editDialog.attr("value",_5b);this._editDialog.show();}}}},_destroyProperty:function(){var _5c=this.lastFocused;var _5d=_5c.item;var _5e=[];while(!this.store.isItem(_5d.parent,true)||_5d.parent instanceof Array){_5c=_5c.getParent();_5e.push(_5d.property);_5d=_5c.item;}if(_4.indexOf(this.store.getIdentityAttributes(),_5d.property)>=0){alert("Cannot Delete an Identifier!");}else{try{if(_5e.length>0){var _5f,_60=_7(this.store,_5d.parent,_5d.property);_5f=_60;while(_5e.length>1){_5f=_5f[_5e.pop()];}if(_4.isArray(_5f)){_5f.splice(_5e,1);}else{delete _5f[_5e];}this.store.setValue(_5d.parent,_5d.property,_60);}else{this.store.unsetAttribute(_5d.parent,_5d.property);}}catch(e){alert(e);}}},_addProperty:function(){var _61=this.lastFocused.item;var _62=_61.value;var _63=_4.hitch(this,function(){var _64=null;if(!this._editDialog){this._createEditDialog();}else{this._editDialog.reset();}if(_62 instanceof Array){_64=_62.length;_5.getEnclosingWidget(_4.query("input",this._editDialog.containerNode)[0]).attr("disabled",true);}else{_5.getEnclosingWidget(_4.query("input",this._editDialog.containerNode)[0]).attr("disabled",false);}this._editDialog.attr("title","Add Property");this._enableFields("value");this._editDialog.attr("value",{itemType:"value",property:_64});this._editDialog.show();});if(_61.addNew){_61=this.lastFocused.getParent().item;_62=this.lastFocused.item.parent;}if(_61.property&&_4.indexOf(this.store.getIdentityAttributes(),_61.property)>=0){alert("Cannot add properties to an ID node!");}else{if(this.store.isItem(_62,true)&&!this.store.isItemLoaded(_62)){this.store.loadItem({item:_62,onItem:function(_65){_62=_65;_63();}});}else{_63();}}}});})();}}};});