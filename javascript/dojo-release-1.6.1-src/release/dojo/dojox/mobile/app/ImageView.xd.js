/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realityBuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.mobile.app.ImageView"],["require","dojox.mobile.app._Widget"],["require","dojo.fx.easing"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.mobile.app.ImageView"]){_4._hasResource["dojox.mobile.app.ImageView"]=true;_4.provide("dojox.mobile.app.ImageView");_4.experimental("dojox.mobile.app.ImageView");_4.require("dojox.mobile.app._Widget");_4.require("dojo.fx.easing");_4.declare("dojox.mobile.app.ImageView",_6.mobile.app._Widget,{zoom:1,zoomCenterX:0,zoomCenterY:0,maxZoom:5,autoZoomLevel:3,disableAutoZoom:false,disableSwipe:false,autoZoomEvent:null,_leftImg:null,_centerImg:null,_rightImg:null,_leftSmallImg:null,_centerSmallImg:null,_rightSmallImg:null,constructor:function(){this.panX=0;this.panY=0;this.handleLoad=_4.hitch(this,this.handleLoad);this._updateAnimatedZoom=_4.hitch(this,this._updateAnimatedZoom);this._updateAnimatedPan=_4.hitch(this,this._updateAnimatedPan);this._onAnimPanEnd=_4.hitch(this,this._onAnimPanEnd);},buildRendering:function(){this.inherited(arguments);this.canvas=_4.create("canvas",{},this.domNode);_4.addClass(this.domNode,"mblImageView");},postCreate:function(){this.inherited(arguments);this.size=_4.marginBox(this.domNode);_4.style(this.canvas,{width:this.size.w+"px",height:this.size.h+"px"});this.canvas.height=this.size.h;this.canvas.width=this.size.w;var _7=this;this.connect(this.domNode,"onmousedown",function(_8){if(_7.isAnimating()){return;}if(_7.panX){_7.handleDragEnd();}_7.downX=_8.targetTouches?_8.targetTouches[0].clientX:_8.clientX;_7.downY=_8.targetTouches?_8.targetTouches[0].clientY:_8.clientY;});this.connect(this.domNode,"onmousemove",function(_9){if(_7.isAnimating()){return;}if((!_7.downX&&_7.downX!==0)||(!_7.downY&&_7.downY!==0)){return;}if((!_7.disableSwipe&&_7.zoom==1)||(!_7.disableAutoZoom&&_7.zoom!=1)){var x=_9.targetTouches?_9.targetTouches[0].clientX:_9.pageX;var y=_9.targetTouches?_9.targetTouches[0].clientY:_9.pageY;_7.panX=x-_7.downX;_7.panY=y-_7.downY;if(_7.zoom==1){if(Math.abs(_7.panX)>10){_7.render();}}else{if(Math.abs(_7.panX)>10||Math.abs(_7.panY)>10){_7.render();}}}});this.connect(this.domNode,"onmouseout",function(_a){if(!_7.isAnimating()&&_7.panX){_7.handleDragEnd();}});this.connect(this.domNode,"onmouseover",function(_b){_7.downX=_7.downY=null;});this.connect(this.domNode,"onclick",function(_c){if(_7.isAnimating()){return;}if(_7.downX==null||_7.downY==null){return;}var x=(_c.targetTouches?_c.targetTouches[0].clientX:_c.pageX);var y=(_c.targetTouches?_c.targetTouches[0].clientY:_c.pageY);if(Math.abs(_7.panX)>14||Math.abs(_7.panY)>14){_7.downX=_7.downY=null;_7.handleDragEnd();return;}_7.downX=_7.downY=null;if(!_7.disableAutoZoom){if(!_7._centerImg||!_7._centerImg._loaded){return;}if(_7.zoom!=1){_7.set("animatedZoom",1);return;}var _d=_4._abs(_7.domNode);var _e=_7.size.w/_7._centerImg.width;var _f=_7.size.h/_7._centerImg.height;_7.zoomTo(((x-_d.x)/_e)-_7.panX,((y-_d.y)/_f)-_7.panY,_7.autoZoomLevel);}});_4.connect(this.domNode,"flick",this,"handleFlick");},isAnimating:function(){return this._anim&&this._anim.status()=="playing";},handleDragEnd:function(){this.downX=this.downY=null;console.log("handleDragEnd");if(this.zoom==1){if(!this.panX){return;}var _10=(this._leftImg&&this._leftImg._loaded)||(this._leftSmallImg&&this._leftSmallImg._loaded);var _11=(this._rightImg&&this._rightImg._loaded)||(this._rightSmallImg&&this._rightSmallImg._loaded);var _12=!(Math.abs(this.panX)<this._centerImg._baseWidth/2)&&((this.panX>0&&_10?1:0)||(this.panX<0&&_11?1:0));if(!_12){this._animPanTo(0,_4.fx.easing.expoOut,700);}else{this.moveTo(this.panX);}}else{if(!this.panX&&!this.panY){return;}this.zoomCenterX-=(this.panX/this.zoom);this.zoomCenterY-=(this.panY/this.zoom);this.panX=this.panY=0;}},handleFlick:function(_13){if(this.zoom==1&&_13.duration<500){if(_13.direction=="ltr"){this.moveTo(1);}else{if(_13.direction=="rtl"){this.moveTo(-1);}}this.downX=this.downY=null;}},moveTo:function(_14){_14=_14>0?1:-1;var _15;if(_14<1){if(this._rightImg&&this._rightImg._loaded){_15=this._rightImg;}else{if(this._rightSmallImg&&this._rightSmallImg._loaded){_15=this._rightSmallImg;}}}else{if(this._leftImg&&this._leftImg._loaded){_15=this._leftImg;}else{if(this._leftSmallImg&&this._leftSmallImg._loaded){_15=this._leftSmallImg;}}}this._moveDir=_14;var _16=this;if(_15&&_15._loaded){this._animPanTo(this.size.w*_14,null,500,function(){_16.panX=0;_16.panY=0;if(_14<0){_16._switchImage("left","right");}else{_16._switchImage("right","left");}_16.render();_16.onChange(_14*-1);});}else{console.log("moveTo image not loaded!",_15);this._animPanTo(0,_4.fx.easing.expoOut,700);}},_switchImage:function(_17,_18){var _19="_"+_17+"SmallImg";var _1a="_"+_17+"Img";var _1b="_"+_18+"SmallImg";var _1c="_"+_18+"Img";this[_1a]=this._centerImg;this[_19]=this._centerSmallImg;this[_1a]._type=_17;if(this[_19]){this[_19]._type=_17;}this._centerImg=this[_1c];this._centerSmallImg=this[_1b];this._centerImg._type="center";if(this._centerSmallImg){this._centerSmallImg._type="center";}this[_1c]=this[_1b]=null;},_animPanTo:function(to,_1d,_1e,_1f){this._animCallback=_1f;this._anim=new _4.Animation({curve:[this.panX,to],onAnimate:this._updateAnimatedPan,duration:_1e||500,easing:_1d,onEnd:this._onAnimPanEnd});this._anim.play();return this._anim;},onChange:function(_20){},_updateAnimatedPan:function(_21){this.panX=_21;this.render();},_onAnimPanEnd:function(){this.panX=this.panY=0;if(this._animCallback){this._animCallback();}},zoomTo:function(_22,_23,_24){this.set("zoomCenterX",_22);this.set("zoomCenterY",_23);this.set("animatedZoom",_24);},render:function(){var cxt=this.canvas.getContext("2d");cxt.clearRect(0,0,this.canvas.width,this.canvas.height);this._renderImg(this._centerSmallImg,this._centerImg,this.zoom==1?(this.panX<0?1:this.panX>0?-1:0):0);if(this.zoom==1&&this.panX!=0){if(this.panX>0){this._renderImg(this._leftSmallImg,this._leftImg,1);}else{this._renderImg(this._rightSmallImg,this._rightImg,-1);}}},_renderImg:function(_25,_26,_27){var img=(_26&&_26._loaded)?_26:_25;if(!img||!img._loaded){return;}var cxt=this.canvas.getContext("2d");var _28=img._baseWidth;var _29=img._baseHeight;var _2a=_28*this.zoom;var _2b=_29*this.zoom;var _2c=Math.min(this.size.w,_2a);var _2d=Math.min(this.size.h,_2b);var _2e=this.dispWidth=img.width*(_2c/_2a);var _2f=this.dispHeight=img.height*(_2d/_2b);var _30=this.zoomCenterX-(this.panX/this.zoom);var _31=this.zoomCenterY-(this.panY/this.zoom);var _32=Math.floor(Math.max(_2e/2,Math.min(img.width-_2e/2,_30)));var _33=Math.floor(Math.max(_2f/2,Math.min(img.height-_2f/2,_31)));var _34=Math.max(0,Math.round((img.width-_2e)/2+(_32-img._centerX)));var _35=Math.max(0,Math.round((img.height-_2f)/2+(_33-img._centerY)));var _36=Math.round(Math.max(0,this.canvas.width-_2c)/2);var _37=Math.round(Math.max(0,this.canvas.height-_2d)/2);var _38=_2c;var _39=_2e;if(this.zoom==1&&_27&&this.panX){if(this.panX<0){if(_27>0){_2c-=Math.abs(this.panX);_36=0;}else{if(_27<0){_2c=Math.max(1,Math.abs(this.panX)-5);_36=this.size.w-_2c;}}}else{if(_27>0){_2c=Math.max(1,Math.abs(this.panX)-5);_36=0;}else{if(_27<0){_2c-=Math.abs(this.panX);_36=this.size.w-_2c;}}}_2e=Math.max(1,Math.floor(_2e*(_2c/_38)));if(_27>0){_34=(_34+_39)-(_2e);}_34=Math.floor(_34);}try{cxt.drawImage(img,Math.max(0,_34),_35,Math.min(_39,_2e),_2f,_36,_37,Math.min(_38,_2c),_2d);}catch(e){console.log("Caught Error",e,"type=",img._type,"oldDestWidth = ",_38,"destWidth",_2c,"destX",_36,"oldSourceWidth=",_39,"sourceWidth=",_2e,"sourceX = "+_34);}},_setZoomAttr:function(_3a){this.zoom=Math.min(this.maxZoom,Math.max(1,_3a));if(this.zoom==1&&this._centerImg&&this._centerImg._loaded){if(!this.isAnimating()){this.zoomCenterX=this._centerImg.width/2;this.zoomCenterY=this._centerImg.height/2;}this.panX=this.panY=0;}this.render();},_setZoomCenterXAttr:function(_3b){if(_3b!=this.zoomCenterX){if(this._centerImg&&this._centerImg._loaded){_3b=Math.min(this._centerImg.width,_3b);}this.zoomCenterX=Math.max(0,Math.round(_3b));}},_setZoomCenterYAttr:function(_3c){if(_3c!=this.zoomCenterY){if(this._centerImg&&this._centerImg._loaded){_3c=Math.min(this._centerImg.height,_3c);}this.zoomCenterY=Math.max(0,Math.round(_3c));}},_setZoomCenterAttr:function(_3d){if(_3d.x!=this.zoomCenterX||_3d.y!=this.zoomCenterY){this.set("zoomCenterX",_3d.x);this.set("zoomCenterY",_3d.y);this.render();}},_setAnimatedZoomAttr:function(_3e){if(this._anim&&this._anim.status()=="playing"){return;}this._anim=new _4.Animation({curve:[this.zoom,_3e],onAnimate:this._updateAnimatedZoom,onEnd:this._onAnimEnd});this._anim.play();},_updateAnimatedZoom:function(_3f){this._setZoomAttr(_3f);},_setCenterUrlAttr:function(_40){this._setImage("center",_40);},_setLeftUrlAttr:function(_41){this._setImage("left",_41);},_setRightUrlAttr:function(_42){this._setImage("right",_42);},_setImage:function(_43,_44){var _45=null;var _46=null;if(_4.isString(_44)){_46=_44;}else{_46=_44.large;_45=_44.small;}if(this["_"+_43+"Img"]&&this["_"+_43+"Img"]._src==_46){return;}var _47=this["_"+_43+"Img"]=new Image();_47._type=_43;_47._loaded=false;_47._src=_46;_47._conn=_4.connect(_47,"onload",this.handleLoad);if(_45){var _48=this["_"+_43+"SmallImg"]=new Image();_48._type=_43;_48._loaded=false;_48._conn=_4.connect(_48,"onload",this.handleLoad);_48._isSmall=true;_48._src=_45;_48.src=_45;}_47.src=_46;},handleLoad:function(evt){var img=evt.target;img._loaded=true;_4.disconnect(img._conn);var _49=img._type;switch(_49){case "center":this.zoomCenterX=img.width/2;this.zoomCenterY=img.height/2;break;}var _4a=img.height;var _4b=img.width;if(_4b/this.size.w<_4a/this.size.h){img._baseHeight=this.canvas.height;img._baseWidth=_4b/(_4a/this.size.h);}else{img._baseWidth=this.canvas.width;img._baseHeight=_4a/(_4b/this.size.w);}img._centerX=_4b/2;img._centerY=_4a/2;this.render();this.onLoad(img._type,img._src,img._isSmall);},onLoad:function(_4c,url,_4d){}});}}};});