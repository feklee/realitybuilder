/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realityBuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","realityBuilder.Block"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["realityBuilder.Block"]){_4._hasResource["realityBuilder.Block"]=true;_4.provide("realityBuilder.Block");_4.declare("realityBuilder.Block",null,{_positionB:null,_a:null,_camera:null,_blockProperties:null,_bottomVertexesB:null,_bottomVertexes:null,_bottomVertexesV:null,_bottomVertexesS:null,_topVertexesB:null,_topVertexes:null,_topVertexesV:null,_topVertexesS:null,_bottomRotCenterB:null,_bottomRotCenter:null,_bottomRotCenterV:null,_bottomRotCenterS:null,_topRotCenterB:null,_topRotCenter:null,_topRotCenterV:null,_topRotCenterS:null,_projectedVertexesVXZ:null,_projectedVertexesVXZS:null,_boundingBoxS:null,_lastCameraId:null,_lastBlockPropertiesVersionOnServer:null,_lastPositionB:null,_lastA:null,_coordinatesChangedAfterLastRendering:false,_indexOfLeftmostVertex:null,_indexOfRightmostVertex:null,_onlySubtractBottom:false,constructor:function(_7,_8,_9,a){this._positionB=_9;this._a=a;this._blockProperties=_7;this._camera=_8;},positionB:function(){return this._positionB;},xB:function(){return this._positionB[0];},yB:function(){return this._positionB[1];},zB:function(){return this._positionB[2];},a:function(){return this._a;},positionBAndA:function(){return [this.xB(),this.yB(),this.zB(),this.a()];},has2FoldSymmetry:function(){return this._blockProperties.has2FoldSymmetry();},congruencyOffsetB:function(){return this._blockProperties.congruencyOffsetB(this._a);},_vertexesS:function(){return this._bottomVertexesS.concat(this._topVertexesS);},projectedVertexesVXZ:function(){this._updateCoordinates();return (this._projectedVertexesVXZ===null)?false:this._projectedVertexesVXZ;},_updateViewSpaceXZPlaneCoordinates:function(){var i,_a,_b,_c,_d=[],_e,_f;_a=this._bottomVertexesV;_b=this._topVertexesV;_c=_a.length;for(i=0;i<_c;i+=1){_e=[_a[i],_b[i]];_f=realityBuilder.util.intersectionLinePlaneVXZ(_e);if(!_f){_d=null;break;}else{_d.push(_f);}}this._projectedVertexesVXZ=_d;},collidesWith:function(_10){var _11,_12,_13,i;_12=this._blockProperties.rotatedCollisionOffsetsBXY(this,_10);for(i=0;i<_12.length;i+=1){_13=_12[i];_11=[this.xB()+_13[0],this.yB()+_13[1],this.zB()];if(realityBuilder.util.pointsIdenticalB(_10.positionB(),_11)){return true;}}return false;},attachableTo:function(_14){var _15,_16,_17,i;_16=this._blockProperties.rotatedAttachmentOffsetsB(this,_14);for(i=0;i<_16.length;i+=1){_17=_16[i];_15=realityBuilder.util.addVectorsB(this.positionB(),_17);if(realityBuilder.util.pointsIdenticalB(_14.positionB(),_15)){return true;}}return false;},_updateBlockSpaceCoordinates:function(){var xB=this.positionB()[0],yB=this.positionB()[1],zB=this.positionB()[2],_18=this._blockProperties.rotatedOutlineBXY(this.a()),_19=this._blockProperties.rotCenterBXY(),_1a=this;this._bottomVertexesB=[];this._topVertexesB=[];_4.forEach(_18,function(_1b){_1a._bottomVertexesB.push([xB+_1b[0],yB+_1b[1],zB]);_1a._topVertexesB.push([xB+_1b[0],yB+_1b[1],zB+1]);});this._bottomRotCenterB=[xB+_19[0],yB+_19[1],zB];this._topRotCenterB=[xB+_19[0],yB+_19[1],zB+1];},_blockToWorld:function(pB){return realityBuilder.util.blockToWorld(pB,this._blockProperties);},_updateWorldSpaceCoordinates:function(){this._bottomVertexes=_4.map(this._bottomVertexesB,_4.hitch(this,this._blockToWorld));this._topVertexes=_4.map(this._topVertexesB,_4.hitch(this,this._blockToWorld));this._bottomRotCenter=this._blockToWorld(this._bottomRotCenterB);this._topRotCenter=this._blockToWorld(this._topRotCenterB);},_updateViewSpaceCoordinates:function(){this._bottomVertexesV=_4.map(this._bottomVertexes,_4.hitch(this._camera,this._camera.worldToView));this._topVertexesV=_4.map(this._topVertexes,_4.hitch(this._camera,this._camera.worldToView));this._bottomRotCenterV=this._camera.worldToView(this._bottomRotCenter);this._topRotCenterV=this._camera.worldToView(this._topRotCenter);},_coordinatesNeedToBeUpdated:function(){var _1c,_1d,_1e,_1f;_1c=this._lastCameraId!==this._camera.id();_1d=this._lastBlockPropertiesVersionOnServer!==this._blockProperties.versionOnServer();_1e=this._lastPositionB===null||!realityBuilder.util.pointsIdenticalB(this._lastPositionB,this._positionB);_1f=this._lastA!==this._a;return _1c||_1d||_1e||_1f;},_onCoordinatesUpdated:function(){this._lastBlockPropertiesVersionOnServer=this._blockProperties.versionOnServer();this._lastCameraId=this._camera.id();this._lastPositionB=[this._positionB[0],this._positionB[1],this._positionB[2]];this._lastA=this._a;this._coordinatesChangedAfterLastRendering=true;},_updateHorizontalExtentsInSensorSpace:function(){var _20,_21,_22,_23,i,ilv,irv;_20=this._projectedVertexesVXZS;_22=_23=_20[0];ilv=irv=0;for(i=1;i<_20.length;i+=1){_21=_20[i];if(_21[0]<_22[0]){_22=_21;ilv=i;}if(_21[0]>_23[0]){_23=_21;irv=i;}}this._indexOfLeftmostVertex=ilv;this._indexOfRightmostVertex=irv;},_updateProjectedVertexesVXZS:function(){var cam=this._camera;this._projectedVertexesVXZS=_4.map(this._projectedVertexesVXZ,function(_24){var _25=[_24[0],0,_24[1]];return cam.viewToSensor(_25);});},_updateSensorSpaceBoundingBox:function(){var _26,_27,_28,_29,_2a,_2b,i;_2a=this._vertexesS();if(_2a.length>0){_2b=_2a[0];_26=_28=_2b[0];_27=_29=_2b[1];for(i=1;i<_2a.length;i+=1){_2b=_2a[i];if(_2b[0]<_26){_26=_2b[0];}else{if(_2b[0]>_28){_28=_2b[0];}}if(_2b[1]<_27){_27=_2b[1];}else{if(_2b[1]>_29){_29=_2b[1];}}}}this._boundingBoxS=[[_26,_27],[_28,_29]];},_updateSensorSpaceCoordinates:function(){var cam=this._camera;this._bottomVertexesS=_4.map(this._bottomVertexesV,_4.hitch(cam,cam.viewToSensor));this._topVertexesS=_4.map(this._topVertexesV,_4.hitch(cam,cam.viewToSensor));this._bottomRotCenterS=cam.viewToSensor(this._bottomRotCenterV);this._topRotCenterS=cam.viewToSensor(this._topRotCenterV);this._updateProjectedVertexesVXZS();this._updateHorizontalExtentsInSensorSpace();this._updateSensorSpaceBoundingBox();},_updateCoordinates:function(){if(this._coordinatesNeedToBeUpdated()){this._updateBlockSpaceCoordinates();this._updateWorldSpaceCoordinates();this._updateViewSpaceCoordinates();this._updateViewSpaceXZPlaneCoordinates();this._updateSensorSpaceCoordinates();this._onCoordinatesUpdated();}},onlySubtractBottom:function(){this._onlySubtractBottom=true;},_subtractDrawBottomPath:function(_2c){var _2d,len,_2e,i;_2d=this._bottomVertexesS;_2e=_2d[0];_2c.moveTo(_2e[0],_2e[1]);for(i=1;i<_2d.length;i+=1){_2e=_2d[i];_2c.lineTo(_2e[0],_2e[1]);}},_subtractDrawPath:function(_2f){var _30,_31,len,_32,i,ilv,irv;_30=this._bottomVertexesS;_31=this._topVertexesS;len=_31.length;ilv=this._indexOfLeftmostVertex;irv=this._indexOfRightmostVertex;_32=_31[irv];_2f.moveTo(_32[0],_32[1]);for(i=irv+1;i<=len+ilv;i+=1){_32=_31[i%len];_2f.lineTo(_32[0],_32[1]);}_32=_30[ilv];_2f.lineTo(_32[0],_32[1]);for(i=ilv+1;i<=len+irv;i+=1){_32=_30[i%len];_2f.lineTo(_32[0],_32[1]);}_32=_30[irv];_2f.lineTo(_32[0],_32[1]);},subtract:function(_33){var _34,_35,len,_36,i,ilv,irv;this._updateCoordinates();_33.globalCompositeOperation="destination-out";_33.fillStyle="black";_33.beginPath();if(this._onlySubtractBottom){this._subtractDrawBottomPath(_33);}else{this._subtractDrawPath(_33);}_33.closePath();_33.fill();_33.globalCompositeOperation="source-over";},_renderForeground:function(_37){var _38=this._topVertexesS,_39=this._bottomVertexesS,_3a=this._topRotCenterS,len=_38.length,_3b,_3c,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex,_3d;_37.globalAlpha=1;_37.beginPath();_3c=_39[ilv];_37.moveTo(_3c[0],_3c[1]);_3d=(ilv+1<=irv)?irv:irv+len;for(i=ilv+1;i<=_3d;i+=1){_3b=_39[i%len];_37.lineTo(_3b[0],_3b[1]);}_37.stroke();_37.beginPath();_3c=_38[0];_37.moveTo(_3c[0],_3c[1]);for(i=1;i<=len;i+=1){_3b=_38[i%len];_37.lineTo(_3b[0],_3b[1]);}_37.lineTo(_3c[0],_3c[1]);_37.stroke();_3d=(ilv<=irv)?irv:irv+len;for(i=ilv;i<=_3d;i+=1){_37.beginPath();_3b=_39[i%len];_37.moveTo(_3b[0],_3b[1]);_3b=_38[i%len];_37.lineTo(_3b[0],_3b[1]);_37.stroke();}_37.beginPath();_37.arc(_3a[0],_3a[1],_37.lineWidth,0,2*Math.PI,false);_37.fill();},_renderBackground:function(_3e){var _3f=this._bottomVertexesS,_40=this._topVertexesS,_41=this._bottomRotCenterS,_42=this._topRotCenterS,len=_40.length,_43,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex,_44;_3e.globalAlpha=this._blockProperties.backgroundAlpha();_3e.beginPath();_43=_3f[irv];_3e.moveTo(_43[0],_43[1]);_44=(irv+1<=ilv)?ilv:ilv+len;for(i=irv+1;i<=_44;i+=1){_43=_3f[i%len];_3e.lineTo(_43[0],_43[1]);}_3e.stroke();_44=(irv+1<=ilv-1)?ilv-1:ilv-1+len;for(i=irv+1;i<=_44;i+=1){_3e.beginPath();_43=_3f[i%len];_3e.moveTo(_43[0],_43[1]);_43=_40[i%len];_3e.lineTo(_43[0],_43[1]);_3e.stroke();}_3e.beginPath();_3e.moveTo(_41[0],_41[1]);_3e.lineTo(_42[0],_42[1]);_3e.stroke();_3e.globalAlpha=1;},render:function(_45,_46){this._updateCoordinates();_45.strokeStyle=_46;_45.fillStyle=_46;_45.lineWidth=realityBuilder.util.SETTINGS.lineWidthOfBlock;this._renderForeground(_45);this._renderBackground(_45);}});}}};});