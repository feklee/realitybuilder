/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realityBuilder.PrerenderMode"]){dojo._hasResource["realityBuilder.PrerenderMode"]=true;dojo.provide("realityBuilder.PrerenderMode");dojo.declare("realityBuilder.PrerenderMode",null,{_versionOnServer:"-1",_isEnabled:null,_makeRealAfter:null,_blockConfigurations:null,_resetDelay:null,_i:null,_prevI:null,versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},resetDelay:function(){return this._resetDelay;},updateWithServerData:function(_1){if(this._versionOnServer!==_1.version){this._versionOnServer=_1.version;this._isEnabled=_1.isEnabled;this._makeRealAfter=_1.makeRealAfter;this._blockConfigurations=_1.blockConfigurations;this._i=_1.i;this._prevI=_1.prevI;this._resetDelay=_1.resetDelay;this._sortBlockConfigurations(this._blockConfigurations);dojo.publish("realityBuilder/PrerenderMode/changed");}},i:function(){return this._i;},prevI:function(){return this._prevI;},isEnabled:function(){return this._isEnabled;},makeRealAfter:function(){return this._makeRealAfter;},_sortBlockConfiguration2:function(_2,_3){var a=_2,b=_3;if(a[0]===b[0]){if(a[1]===b[1]){if(a[2]===b[2]){if(a[3]===b[3]){return 0;}else{return a[3]-b[3];}}else{return a[2]-b[2];}}else{return a[1]-b[1];}}else{return a[0]-b[0];}},_sortBlockConfiguration:function(_4){_4.sort(dojo.hitch(this,this._sortBlockConfiguration2));},_sortBlockConfigurations:function(_5){var _6=this;dojo.forEach(_5,function(_7){_6._sortBlockConfiguration(_7);});},_posBAndAsMatch:function(_8,_9){var i;for(i=0;i<4;i+=1){if(_8[i]!==_9[i]){return false;}}return true;},_blockConfigurationsMatch:function(_a,_b){var i;if(_a.length===_b.length){for(i=0;i<_a.length;i+=1){if(!this._posBAndAsMatch(_a[i],_b[i])){return false;}}return true;}else{return false;}},simplifiedPosBAndA:function(_c,_d){var _e,_f,a,_10;_f=_c;a=_c[3];if(_d.has2FoldSymmetry()&&a>=2){_10=_d.congruencyOffsetB(a);_e=realityBuilder.util.addVectorsB(_f,_10);_e.push(a%2);}else{_e=dojo.clone(_c);}return _e;},_simplifiedPosBAndAOfBlock:function(_11){return this.simplifiedPosBAndA(_11.posBAndA(),_11.blockProperties());},_currentBlockConfiguration:function(_12,_13){var _14=[],_15,_16=this;dojo.forEach(_12,function(_17){_15=_16._simplifiedPosBAndAOfBlock(_17);_14.push(_15);});_15=this._simplifiedPosBAndAOfBlock(_13);_14.push(_15);this._sortBlockConfiguration(_14);return _14;},matchingBlockConfigurationI:function(_18,_19){var i,_1a,_1b;_1b=this._currentBlockConfiguration(_18,_19);for(i=0;i<this._blockConfigurations.length;i+=1){_1a=this._blockConfigurations[i];if(this._blockConfigurationsMatch(_1a,_1b)){return i;}}return false;},_loadBlockConfigurationOnServerSucceeded:function(){dojo.publish("realityBuilder/PrerenderMode/"+"loadedBlockConfigurationOnServer");},loadBlockConfigurationOnServer:function(i){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"rpc/load_prerendered_block_configuration",content:{"i":i},load:dojo.hitch(this,this._loadBlockConfigurationOnServerSucceeded)});},loadPrevBlockConfigurationOnServer:function(){if(this.i()>0){this.loadBlockConfigurationOnServer(this.i()-1);}},loadNextBlockConfigurationOnServer:function(){if(this.i()<this._blockConfigurations.length-1){this.loadBlockConfigurationOnServer(this.i()+1);}},_scheduleResetOnServer:function(){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"rpc/schedule_reset"});},scheduleReset:function(){this._scheduleResetOnServer();}});}