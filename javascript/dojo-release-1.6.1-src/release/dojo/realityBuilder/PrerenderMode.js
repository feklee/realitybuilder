/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realityBuilder.PrerenderMode"]){dojo._hasResource["realityBuilder.PrerenderMode"]=true;dojo.provide("realityBuilder.PrerenderMode");dojo.declare("realityBuilder.PrerenderMode",null,{_versionOnServer:"-1",_isEnabled:null,_makeRealAfter:null,_blockConfigurations:null,_resetDelay:null,_i:null,_prevI:null,versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},resetDelay:function(){return this._resetDelay;},updateWithServerData:function(_1){if(this._versionOnServer!==_1.version){this._versionOnServer=_1.version;this._isEnabled=_1.isEnabled;this._makeRealAfter=_1.makeRealAfter;this._blockConfigurations=_1.blockConfigurations;this._i=_1.i;this._prevI=_1.prevI;this._resetDelay=_1.resetDelay;this._sortBlockConfigurations(this._blockConfigurations);dojo.publish("realityBuilder/PrerenderMode/changed");}},i:function(){return this._i;},prevI:function(){return this._prevI;},isEnabled:function(){return this._isEnabled;},makeRealAfter:function(){return this._makeRealAfter;},_sortBlockConfiguration2:function(_2,_3){var a=_2,b=_3;if(a[0]===b[0]){if(a[1]===b[1]){if(a[2]===b[2]){if(a[3]===b[3]){return 0;}else{return a[3]-b[3];}}else{return a[2]-b[2];}}else{return a[1]-b[1];}}else{return a[0]-b[0];}},_sortBlockConfiguration:function(_4){_4.sort(dojo.hitch(this,this._sortBlockConfiguration2));},_sortBlockConfigurations:function(_5){var _6=this;dojo.forEach(_5,function(_7){_6._sortBlockConfiguration(_7);});},_posBAndAsMatch:function(_8,_9){var i;for(i=0;i<4;i+=1){if(_8[i]!==_9[i]){return false;}}return true;},_blockConfigurationsMatch:function(_a,_b){var i;if(_a.length===_b.length){for(i=0;i<_a.length;i+=1){if(!this._posBAndAsMatch(_a[i],_b[i])){return false;}}return true;}else{return false;}},_simplifiedPosBAndA:function(_c){var _d,_e,a;_e=_c.posB();a=_c.a();if(_c.has2FoldSymmetry()&&a>=2){_d=realityBuilder.util.addVectorsB(_e,_c.congruencyOffsetB());_d.push(a%2);}else{_d=dojo.clone(_e);_d.push(a);}return _d;},_currentBlockConfiguration:function(_f,_10){var _11=[],_12,_13=this;dojo.forEach(_f,function(_14){_12=_13._simplifiedPosBAndA(_14);_11.push(_12);});_12=this._simplifiedPosBAndA(_10);_11.push(_12);this._sortBlockConfiguration(_11);return _11;},matchingBlockConfigurationI:function(_15,_16){var i,_17,_18;_18=this._currentBlockConfiguration(_15,_16);for(i=0;i<this._blockConfigurations.length;i+=1){_17=this._blockConfigurations[i];if(this._blockConfigurationsMatch(_17,_18)){return i;}}return false;},blockConfigurationMatches:function(_19){var _1a,_1b,_1c,_1d=this;_1a=[];dojo.forEach(_19,function(_1e){_1c=_1d._simplifiedPosBAndA(_1e);_1a.push(_1c);});this._sortBlockConfiguration(_1a);_1b=this._blockConfigurations[this.i()];return this._blockConfigurationsMatch(_1a,_1b);},_loadBlockConfigurationOnServerSucceeded:function(){dojo.publish("realityBuilder/PrerenderMode/"+"loadedBlockConfigurationOnServer");},loadBlockConfigurationOnServer:function(i){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"rpc/load_prerendered_block_configuration",content:{"i":i},load:dojo.hitch(this,this._loadBlockConfigurationOnServerSucceeded)});},loadPrevBlockConfigurationOnServer:function(){if(this.i()>0){this.loadBlockConfigurationOnServer(this.i()-1);}},loadNextBlockConfigurationOnServer:function(){if(this.i()<this._blockConfigurations.length-1){this.loadBlockConfigurationOnServer(this.i()+1);}},_scheduleResetOnServer:function(){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"rpc/schedule_reset"});},scheduleReset:function(){this._scheduleResetOnServer();}});}