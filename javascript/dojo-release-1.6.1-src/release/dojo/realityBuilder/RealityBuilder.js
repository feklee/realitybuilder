/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realityBuilder.RealityBuilder"]){dojo._hasResource["realityBuilder.RealityBuilder"]=true;dojo.provide("realityBuilder.RealityBuilder");dojo.require("realityBuilder.BlockProperties");dojo.require("realityBuilder.ConstructionBlocks");dojo.require("realityBuilder.ConstructionBlock");dojo.require("realityBuilder.NewBlock");dojo.require("realityBuilder.Camera");dojo.require("realityBuilder.PrerenderMode");dojo.require("realityBuilder.util");dojo.declare("realityBuilder.RealityBuilder",null,{_constructionBlocks:null,_blockProperties:null,_prerenderMode:null,_newBlock:null,_camera:null,_updateTimeout:null,_onReadyCalled:null,constructor:function(_1){var rb=realityBuilder;if(!rb.util.isCanvasSupported()){_1.onBrowserNotSupportedError();return;}realityBuilder.util.SETTINGS=_1;this._onReadyCalled=false;this._blockProperties=new rb.BlockProperties();this._camera=new rb.Camera(this._blockProperties,_1.width,_1.height,dojo.byId(_1.id));this._constructionBlocks=new rb.ConstructionBlocks(this._blockProperties,this._camera);this._prerenderMode=new rb.PrerenderMode();this._newBlock=new rb.NewBlock(this._blockProperties,this._camera,this._constructionBlocks,this._prerenderMode);dojo.subscribe("realityBuilder/ConstructionBlocks/changedOnServer",this,this._update);dojo.subscribe("realityBuilder/PrerenderMode/"+"loadedBlockConfigurationOnServer",this,this._update);dojo.subscribe("realityBuilder/NewBlock/createdPendingOnServer",this,this._update);dojo.subscribe("realityBuilder/NewBlock/"+"positionAngleInitialized",this,this._onNewBlockPositionAngleInitialized);dojo.subscribe("realityBuilder/NewBlock/buildOrMoveSpaceChanged",this,this._onMoveOrBuildSpaceChanged);dojo.subscribe("realityBuilder/NewBlock/frozen",this,this._onNewBlockFrozen);dojo.subscribe("realityBuilder/NewBlock/unfrozen",this,this._onNewBlockUnfrozen);dojo.subscribe("realityBuilder/NewBlock/movedOrRotated",this,this._onNewBlockMovedOrRotated);dojo.subscribe("realityBuilder/NewBlock/"+"onNewBlockMakeRealRequested",this,this._onNewBlockMakeRealRequested);dojo.subscribe("realityBuilder/ConstructionBlocks/changed",this,this._onConstructionBlocksChanged);dojo.subscribe("realityBuilder/Camera/changed",this,this._onCameraChanged);dojo.subscribe("realityBuilder/BlockProperties/changed",this,this._onBlockPropertiesChanged);dojo.subscribe("realityBuilder/PrerenderMode/changed",this,this._onPrerenderModeChanged);dojo.connect(null,"onkeypress",dojo.hitch(this,this._onKeyPress));this._update();},newBlock:function(){return this._newBlock;},camera:function(){return this._camera;},prerenderMode:function(){return this._prerenderMode;},constructionBlocks:function(){return this._constructionBlocks;},_onNewBlockFrozen:function(){this._renderNewBlockIfFullyInitialized();realityBuilder.util.SETTINGS.onDegreesOfFreedomChanged();},_onNewBlockUnfrozen:function(){this._renderNewBlockIfFullyInitialized();realityBuilder.util.SETTINGS.onDegreesOfFreedomChanged();},_onNewBlockMakeRealRequested:function(){},setRealBlocksVisibility:function(_2){this._camera.sensor().setRealBlocksVisibility(_2);this._constructionBlocks.renderIfVisible();realityBuilder.util.SETTINGS.onRealBlocksVisibilityChanged();},setPendingBlocksVisibility:function(_3){this._camera.sensor().setPendingBlocksVisibility(_3);this._constructionBlocks.renderIfVisible();realityBuilder.util.SETTINGS.onPendingBlocksVisibilityChanged();},realBlocksAreVisible:function(){return this._camera.sensor().realBlocksAreVisible();},pendingBlocksAreVisible:function(){return this._camera.sensor().pendingBlocksAreVisible();},_onKeyPress:function(_4){var _5,_6;_6=this._newBlock;if(_4.keyCode===109){_5=this._constructionBlocks;_5.setBlockStateOnServer(_6.positionB(),_6.a(),2);}},_onNewBlockMovedOrRotated:function(){this._newBlock.render();realityBuilder.util.SETTINGS.onDegreesOfFreedomChanged();realityBuilder.util.SETTINGS.onMovedOrRotated();},_blocksAreFullyInitialized:function(){return (this._constructionBlocks.isInitializedWithServerData()&&this._newBlock.isInitializedWithServerData()&&this._camera.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData());},_renderConstructionBlocksIfFullyInitialized:function(_7){if(this._blocksAreFullyInitialized()){this._constructionBlocks.renderIfVisible();}},_renderNewBlockIfFullyInitialized:function(){if(this._blocksAreFullyInitialized()){this._newBlock.render();}},_renderBlocksIfFullyInitialized:function(){this._renderConstructionBlocksIfFullyInitialized();this._renderNewBlockIfFullyInitialized();},_updateNewBlockStateIfFullyInitialized:function(_8){if(this._constructionBlocks.isInitializedWithServerData()&&this._newBlock.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()&&this._prerenderMode.isInitializedWithServerData()){realityBuilder._newBlock.updateState();realityBuilder.util.SETTINGS.onDegreesOfFreedomChanged();realityBuilder.util.SETTINGS.onMovedOrRotated();}},_onConstructionBlocksChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._checkIfReady();realityBuilder.util.SETTINGS.onConstructionBlocksChanged();},_onCameraChanged:function(){this._renderBlocksIfFullyInitialized();this._checkIfReady();realityBuilder.util.SETTINGS.onCameraChanged();},_onNewBlockPositionAngleInitialized:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._checkIfReady();},_onMoveOrBuildSpaceChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._checkIfReady();},_onBlockPropertiesChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._checkIfReady();},_onPrerenderModeChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._newBlock.unfreeze();this._checkIfReady();realityBuilder.util.SETTINGS.onPrerenderedBlockConfigurationChanged();},_checkIfReady:function(){if(this._constructionBlocks.isInitializedWithServerData()&&this._camera.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()&&this._onReadyCalled===false){realityBuilder.util.SETTINGS.onReady();this._onReadyCalled=true;}},_updateSucceeded:function(_9){var _a=this;if(_9.blocksData.changed){this._constructionBlocks.updateWithServerData(_9.blocksData);}if(_9.prerenderModeData.changed){this._prerenderMode.updateWithServerData(_9.prerenderModeData);}if(_9.cameraData.changed){this._camera.updateWithServerData(_9.cameraData);}if(_9.blockPropertiesData.changed){this._blockProperties.updateWithServerData(_9.blockPropertiesData);}if(_9.newBlockData.changed){this._newBlock.updateWithServerData(_9.newBlockData);}if(this._updateTimeout){clearTimeout(this._updateTimeout);}this._updateTimeout=setTimeout(function(){_a._update();},_9.updateIntervalClient);},_update:function(){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"rpc/construction",content:{"blocksDataVersion":this._constructionBlocks.versionOnServer(),"cameraDataVersion":this._camera.versionOnServer(),"blockPropertiesDataVersion":this._blockProperties.versionOnServer(),"newBlockDataVersion":this._newBlock.versionOnServer(),"prerenderModeDataVersion":this._prerenderMode.versionOnServer()},load:dojo.hitch(this,this._updateSucceeded)});},_storeSettingsOnServerSucceeded:function(){this._update();},_preparedCameraData:function(_b){var _c;_c=realityBuilder.util.addPrefix("camera.",_b);_c["camera.x"]=_b.position[0];_c["camera.y"]=_b.position[1];_c["camera.z"]=_b.position[2];return _c;},storeSettingsOnServer:function(_d){var _e={};if("cameraData" in _d){dojo.mixin(_e,this._preparedCameraData(_d.cameraData));}realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/update_settings",content:_e,load:dojo.hitch(this,this._storeSettingsOnServerSucceeded)});}});}