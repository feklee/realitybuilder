/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realitybuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","realityBuilder.RealityBuilder"],["require","realityBuilder.BlockProperties"],["require","realityBuilder.ConstructionBlockProperties"],["require","realityBuilder.ConstructionBlocks"],["require","realityBuilder.ConstructionBlock"],["require","realityBuilder.NewBlock"],["require","realityBuilder.Camera"],["require","realityBuilder.PrerenderMode"],["require","realityBuilder.util"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["realityBuilder.RealityBuilder"]){_4._hasResource["realityBuilder.RealityBuilder"]=true;_4.provide("realityBuilder.RealityBuilder");_4.require("realityBuilder.BlockProperties");_4.require("realityBuilder.ConstructionBlockProperties");_4.require("realityBuilder.ConstructionBlocks");_4.require("realityBuilder.ConstructionBlock");_4.require("realityBuilder.NewBlock");_4.require("realityBuilder.Camera");_4.require("realityBuilder.PrerenderMode");_4.require("realityBuilder.util");_4.declare("realityBuilder.RealityBuilder",null,{_constructionBlocks:null,_showReal:null,_showPending:null,_blockProperties:null,_constructionBlockProperties:null,_prerenderMode:null,_newBlock:null,_camera:null,_updateTimeout:null,_onReadyCalled:null,constructor:function(_7){var rb=realityBuilder;if(!rb.util.isCanvasSupported()){_7.onBrowserNotSupportedError();return;}realityBuilder.util.SETTINGS=_7;this._onReadyCalled=false;this._blockProperties=new rb.BlockProperties();this._constructionBlockProperties=new rb.ConstructionBlockProperties();this._camera=new rb.Camera(this._blockProperties,_7.width,_7.height,_4.byId(_7.id));this._constructionBlocks=new rb.ConstructionBlocks(this._blockProperties,this._constructionBlockProperties,this._camera);this._prerenderMode=new rb.PrerenderMode();this._newBlock=new rb.NewBlock(this._blockProperties,this._camera,this._constructionBlocks,this._prerenderMode);_4.subscribe("realityBuilder/ConstructionBlocks/changedOnServer",this,this._update);_4.subscribe("realityBuilder/PrerenderMode/"+"loadedBlockConfigurationOnServer",this,this._update);_4.subscribe("realityBuilder/NewBlock/createdPendingOnServer",this,this._update);_4.subscribe("realityBuilder/NewBlock/"+"positionAngleInitialized",this,this._onNewBlockPositionAngleInitialized);_4.subscribe("realityBuilder/NewBlock/buildOrMoveSpaceChanged",this,this._onMoveOrBuildSpaceChanged);_4.subscribe("realityBuilder/NewBlock/stopped",this,this._onNewBlockStopped);_4.subscribe("realityBuilder/NewBlock/madeMovable",this,this._onNewBlockMadeMovable);_4.subscribe("realityBuilder/NewBlock/movedOrRotated",this,this._onNewBlockMovedOrRotated);_4.subscribe("realityBuilder/NewBlock/"+"onNewBlockMakeRealRequested",this,this._onNewBlockMakeRealRequested);_4.subscribe("realityBuilder/ConstructionBlocks/changed",this,this._onConstructionBlocksChanged);_4.subscribe("realityBuilder/Camera/changed",this,this._onCameraChanged);_4.subscribe("realityBuilder/BlockProperties/changed",this,this._onBlockPropertiesChanged);_4.subscribe("realityBuilder/ConstructionBlockProperties/changed",this,this._onConstructionBlockPropertiesChanged);_4.subscribe("realityBuilder/PrerenderMode/changed",this,this._onPrerenderModeChanged);_4.connect(null,"onkeypress",_4.hitch(this,this._onKeyPress));this._update();},newBlock:function(){return this._newBlock;},camera:function(){return this._camera;},prerenderMode:function(){return this._prerenderMode;},showPending:function(){return this._showPending;},showReal:function(){return this._showReal;},constructionBlocks:function(){return this._constructionBlocks;},_onNewBlockStopped:function(){this._newBlock.render();realityBuilder.util.SETTINGS.onDegreesOfFreedomChanged();},_onNewBlockMadeMovable:function(){this._newBlock.render();realityBuilder.util.SETTINGS.onDegreesOfFreedomChanged();},_onNewBlockMakeRealRequested:function(){},setRealBlocksVisibility:function(_8){this._camera.sensor().setRealBlocksVisibility(_8);this._constructionBlocks.renderIfVisible();realityBuilder.util.SETTINGS.onRealBlocksVisibilityChanged();},setPendingBlocksVisibility:function(_9){this._camera.sensor().setPendingBlocksVisibility(_9);this._constructionBlocks.renderIfVisible();realityBuilder.util.SETTINGS.onPendingBlocksVisibilityChanged();},realBlocksAreVisible:function(){return this._camera.sensor().realBlocksAreVisible();},pendingBlocksAreVisible:function(){return this._camera.sensor().pendingBlocksAreVisible();},_onKeyPress:function(_a){var _b,_c;_c=this._newBlock;if(_a.keyCode===109){_b=this._constructionBlocks;_b.setBlockStateOnServer(_c.positionB(),_c.a(),2);}},_onNewBlockMovedOrRotated:function(){this._newBlock.render();realityBuilder.util.SETTINGS.onDegreesOfFreedomChanged();realityBuilder.util.SETTINGS.onMovedOrRotated();},_renderBlocksIfFullyInitialized:function(){if(this._constructionBlocks.isInitializedWithServerData()&&this._newBlock.isInitializedWithServerData()&&this._camera.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()&&this._constructionBlockProperties.isInitializedWithServerData()){this._constructionBlocks.renderIfVisible();this._newBlock.render();}},_updateNewBlockStateIfFullyInitialized:function(){if(this._constructionBlocks.isInitializedWithServerData()&&this._newBlock.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()&&this._prerenderMode.isInitializedWithServerData()){this._newBlock.updatePositionAndMovability();realityBuilder.util.SETTINGS.onDegreesOfFreedomChanged();realityBuilder.util.SETTINGS.onMovedOrRotated();}},_onConstructionBlocksChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._checkIfReady();realityBuilder.util.SETTINGS.onConstructionBlocksChanged();},_onCameraChanged:function(){this._renderBlocksIfFullyInitialized();this._checkIfReady();realityBuilder.util.SETTINGS.onCameraChanged();},_onNewBlockPositionAngleInitialized:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._checkIfReady();},_onMoveOrBuildSpaceChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._checkIfReady();},_onBlockPropertiesChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._checkIfReady();},_onConstructionBlockPropertiesChanged:function(){this._renderBlocksIfFullyInitialized();this._checkIfReady();},_onPrerenderModeChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._checkIfReady();realityBuilder.util.SETTINGS.onPrerenderedBlockConfigurationChanged();},_checkIfReady:function(){if(this._constructionBlocks.isInitializedWithServerData()&&this._camera.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()&&this._constructionBlockProperties.isInitializedWithServerData()&&this._onReadyCalled===false){realityBuilder.util.SETTINGS.onReady();this._onReadyCalled=true;}},_updateSucceeded:function(_d){var _e=this;if(_d.blocksData.changed){this._constructionBlocks.updateWithServerData(_d.blocksData);}if(_d.prerenderModeData.changed){this._prerenderMode.updateWithServerData(_d.prerenderModeData);}if(_d.cameraData.changed){this._camera.updateWithServerData(_d.cameraData);}if(_d.blockPropertiesData.changed){this._blockProperties.updateWithServerData(_d.blockPropertiesData);}if(_d.constructionBlockPropertiesData.changed){this._constructionBlockProperties.updateWithServerData(_d.constructionBlockPropertiesData);}if(_d.newBlockData.changed){this._newBlock.updateWithServerData(_d.newBlockData);}if(this._updateTimeout){clearTimeout(this._updateTimeout);}this._updateTimeout=setTimeout(function(){_e._update();},_d.updateIntervalClient);},_update:function(){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"rpc/construction",content:{"blocksDataVersion":this._constructionBlocks.versionOnServer(),"cameraDataVersion":this._camera.versionOnServer(),"blockPropertiesDataVersion":this._blockProperties.versionOnServer(),"constructionBlockPropertiesDataVersion":this._constructionBlockProperties.versionOnServer(),"newBlockDataVersion":this._newBlock.versionOnServer(),"prerenderModeDataVersion":this._prerenderMode.versionOnServer()},load:_4.hitch(this,this._updateSucceeded)});},_storeSettingsOnServerSucceeded:function(){this._update();},_preparedCameraData:function(_f){var _10;_10=realityBuilder.util.addPrefix("camera.",_f);_10["camera.x"]=_f.position[0];_10["camera.y"]=_f.position[1];_10["camera.z"]=_f.position[2];return _10;},storeSettingsOnServer:function(_11){var _12={};if("cameraData" in _11){_4.mixin(_12,this._preparedCameraData(_11.cameraData));}realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/update_settings",content:_12,load:_4.hitch(this,this._storeSettingsOnServerSucceeded)});}});}}};});