/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realityBuilder.Block"]){dojo._hasResource["realityBuilder.Block"]=true;dojo.provide("realityBuilder.Block");dojo.declare("realityBuilder.Block",null,{_positionB:null,_a:null,_camera:null,_blockProperties:null,_bottomVertexesB:null,_bottomVertexes:null,_bottomVertexesV:null,_bottomVertexesS:null,_topVertexesB:null,_topVertexes:null,_topVertexesV:null,_topVertexesS:null,_bottomRotCenterB:null,_bottomRotCenter:null,_bottomRotCenterV:null,_bottomRotCenterS:null,_topRotCenterB:null,_topRotCenter:null,_topRotCenterV:null,_topRotCenterS:null,_projectedVertexesVXZ:null,_projectedVertexesVXZS:null,_boundingBoxS:null,_lastCameraId:null,_lastBlockPropertiesVersionOnServer:null,_lastPositionB:null,_lastA:null,_coordinatesChangedAfterLastRendering:false,_indexOfLeftmostVertex:null,_indexOfRightmostVertex:null,_onlySubtractBottom:false,constructor:function(_1,_2,_3,a){this._positionB=_3;this._a=a;this._blockProperties=_1;this._camera=_2;},positionB:function(){return this._positionB;},xB:function(){return this._positionB[0];},yB:function(){return this._positionB[1];},zB:function(){return this._positionB[2];},a:function(){return this._a;},positionBAndA:function(){return [this.xB(),this.yB(),this.zB(),this.a()];},has2FoldSymmetry:function(){return this._blockProperties.has2FoldSymmetry();},congruencyOffsetB:function(){return this._blockProperties.congruencyOffsetB(this._a);},_vertexesS:function(){return this._bottomVertexesS.concat(this._topVertexesS);},projectedVertexesVXZ:function(){this._updateCoordinates();return (this._projectedVertexesVXZ===null)?false:this._projectedVertexesVXZ;},_updateViewSpaceXZPlaneCoordinates:function(){var i,_4,_5,_6,_7=[],_8,_9;_4=this._bottomVertexesV;_5=this._topVertexesV;_6=_4.length;for(i=0;i<_6;i+=1){_8=[_4[i],_5[i]];_9=realityBuilder.util.intersectionLinePlaneVXZ(_8);if(!_9){_7=null;break;}else{_7.push(_9);}}this._projectedVertexesVXZ=_7;},collidesWith:function(_a){var _b,_c,_d,i;_c=this._blockProperties.rotatedCollisionOffsetsBXY(this,_a);for(i=0;i<_c.length;i+=1){_d=_c[i];_b=[this.xB()+_d[0],this.yB()+_d[1],this.zB()];if(realityBuilder.util.pointsIdenticalB(_a.positionB(),_b)){return true;}}return false;},attachableTo:function(_e){var _f,_10,_11,i;_10=this._blockProperties.rotatedAttachmentOffsetsB(this,_e);for(i=0;i<_10.length;i+=1){_11=_10[i];_f=realityBuilder.util.addVectorsB(this.positionB(),_11);if(realityBuilder.util.pointsIdenticalB(_e.positionB(),_f)){return true;}}return false;},_updateBlockSpaceCoordinates:function(){var xB=this.positionB()[0],yB=this.positionB()[1],zB=this.positionB()[2],_12=this._blockProperties.rotatedOutlineBXY(this.a()),_13=this._blockProperties.rotCenterBXY(),_14=this;this._bottomVertexesB=[];this._topVertexesB=[];dojo.forEach(_12,function(_15){_14._bottomVertexesB.push([xB+_15[0],yB+_15[1],zB]);_14._topVertexesB.push([xB+_15[0],yB+_15[1],zB+1]);});this._bottomRotCenterB=[xB+_13[0],yB+_13[1],zB];this._topRotCenterB=[xB+_13[0],yB+_13[1],zB+1];},_blockToWorld:function(pB){return realityBuilder.util.blockToWorld(pB,this._blockProperties);},_updateWorldSpaceCoordinates:function(){this._bottomVertexes=dojo.map(this._bottomVertexesB,dojo.hitch(this,this._blockToWorld));this._topVertexes=dojo.map(this._topVertexesB,dojo.hitch(this,this._blockToWorld));this._bottomRotCenter=this._blockToWorld(this._bottomRotCenterB);this._topRotCenter=this._blockToWorld(this._topRotCenterB);},_updateViewSpaceCoordinates:function(){this._bottomVertexesV=dojo.map(this._bottomVertexes,dojo.hitch(this._camera,this._camera.worldToView));this._topVertexesV=dojo.map(this._topVertexes,dojo.hitch(this._camera,this._camera.worldToView));this._bottomRotCenterV=this._camera.worldToView(this._bottomRotCenter);this._topRotCenterV=this._camera.worldToView(this._topRotCenter);},_coordinatesNeedToBeUpdated:function(){var _16,_17,_18,_19;_16=this._lastCameraId!==this._camera.id();_17=this._lastBlockPropertiesVersionOnServer!==this._blockProperties.versionOnServer();_18=this._lastPositionB===null||!realityBuilder.util.pointsIdenticalB(this._lastPositionB,this._positionB);_19=this._lastA!==this._a;return _16||_17||_18||_19;},_onCoordinatesUpdated:function(){this._lastBlockPropertiesVersionOnServer=this._blockProperties.versionOnServer();this._lastCameraId=this._camera.id();this._lastPositionB=[this._positionB[0],this._positionB[1],this._positionB[2]];this._lastA=this._a;this._coordinatesChangedAfterLastRendering=true;},_updateHorizontalExtentsInSensorSpace:function(){var _1a,_1b,_1c,_1d,i,ilv,irv;_1a=this._projectedVertexesVXZS;_1c=_1d=_1a[0];ilv=irv=0;for(i=1;i<_1a.length;i+=1){_1b=_1a[i];if(_1b[0]<_1c[0]){_1c=_1b;ilv=i;}if(_1b[0]>_1d[0]){_1d=_1b;irv=i;}}this._indexOfLeftmostVertex=ilv;this._indexOfRightmostVertex=irv;},_updateProjectedVertexesVXZS:function(){var cam=this._camera;this._projectedVertexesVXZS=dojo.map(this._projectedVertexesVXZ,function(_1e){var _1f=[_1e[0],0,_1e[1]];return cam.viewToSensor(_1f);});},_updateSensorSpaceBoundingBox:function(){var _20,_21,_22,_23,_24,_25,i;_24=this._vertexesS();if(_24.length>0){_25=_24[0];_20=_22=_25[0];_21=_23=_25[1];for(i=1;i<_24.length;i+=1){_25=_24[i];if(_25[0]<_20){_20=_25[0];}else{if(_25[0]>_22){_22=_25[0];}}if(_25[1]<_21){_21=_25[1];}else{if(_25[1]>_23){_23=_25[1];}}}}this._boundingBoxS=[[_20,_21],[_22,_23]];},_updateSensorSpaceCoordinates:function(){var cam=this._camera;this._bottomVertexesS=dojo.map(this._bottomVertexesV,dojo.hitch(cam,cam.viewToSensor));this._topVertexesS=dojo.map(this._topVertexesV,dojo.hitch(cam,cam.viewToSensor));this._bottomRotCenterS=cam.viewToSensor(this._bottomRotCenterV);this._topRotCenterS=cam.viewToSensor(this._topRotCenterV);this._updateProjectedVertexesVXZS();this._updateHorizontalExtentsInSensorSpace();this._updateSensorSpaceBoundingBox();},_updateCoordinates:function(){if(this._coordinatesNeedToBeUpdated()){this._updateBlockSpaceCoordinates();this._updateWorldSpaceCoordinates();this._updateViewSpaceCoordinates();this._updateViewSpaceXZPlaneCoordinates();this._updateSensorSpaceCoordinates();this._onCoordinatesUpdated();}},onlySubtractBottom:function(){this._onlySubtractBottom=true;},_subtractDrawBottomPath:function(_26){var _27,len,_28,i;_27=this._bottomVertexesS;_28=_27[0];_26.moveTo(_28[0],_28[1]);for(i=1;i<_27.length;i+=1){_28=_27[i];_26.lineTo(_28[0],_28[1]);}},_subtractDrawPath:function(_29){var _2a,_2b,len,_2c,i,ilv,irv;_2a=this._bottomVertexesS;_2b=this._topVertexesS;len=_2b.length;ilv=this._indexOfLeftmostVertex;irv=this._indexOfRightmostVertex;_2c=_2b[irv];_29.moveTo(_2c[0],_2c[1]);for(i=irv+1;i<=len+ilv;i+=1){_2c=_2b[i%len];_29.lineTo(_2c[0],_2c[1]);}_2c=_2a[ilv];_29.lineTo(_2c[0],_2c[1]);for(i=ilv+1;i<=len+irv;i+=1){_2c=_2a[i%len];_29.lineTo(_2c[0],_2c[1]);}_2c=_2a[irv];_29.lineTo(_2c[0],_2c[1]);},subtract:function(_2d){var _2e,_2f,len,_30,i,ilv,irv;this._updateCoordinates();_2d.globalCompositeOperation="destination-out";_2d.fillStyle="black";_2d.beginPath();if(this._onlySubtractBottom){this._subtractDrawBottomPath(_2d);}else{this._subtractDrawPath(_2d);}_2d.closePath();_2d.fill();_2d.globalCompositeOperation="source-over";},_renderForeground:function(_31){var _32=this._topVertexesS,_33=this._bottomVertexesS,_34=this._topRotCenterS,len=_32.length,_35,_36,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex,_37;_31.globalAlpha=1;_31.beginPath();_36=_33[ilv];_31.moveTo(_36[0],_36[1]);_37=(ilv+1<=irv)?irv:irv+len;for(i=ilv+1;i<=_37;i+=1){_35=_33[i%len];_31.lineTo(_35[0],_35[1]);}_31.stroke();_31.beginPath();_36=_32[0];_31.moveTo(_36[0],_36[1]);for(i=1;i<=len;i+=1){_35=_32[i%len];_31.lineTo(_35[0],_35[1]);}_31.lineTo(_36[0],_36[1]);_31.stroke();_37=(ilv<=irv)?irv:irv+len;for(i=ilv;i<=_37;i+=1){_31.beginPath();_35=_33[i%len];_31.moveTo(_35[0],_35[1]);_35=_32[i%len];_31.lineTo(_35[0],_35[1]);_31.stroke();}_31.beginPath();_31.arc(_34[0],_34[1],_31.lineWidth,0,2*Math.PI,false);_31.fill();},_renderBackground:function(_38){var _39=this._bottomVertexesS,_3a=this._topVertexesS,_3b=this._bottomRotCenterS,_3c=this._topRotCenterS,len=_3a.length,_3d,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex,_3e;_38.globalAlpha=this._blockProperties.backgroundAlpha();_38.beginPath();_3d=_39[irv];_38.moveTo(_3d[0],_3d[1]);_3e=(irv+1<=ilv)?ilv:ilv+len;for(i=irv+1;i<=_3e;i+=1){_3d=_39[i%len];_38.lineTo(_3d[0],_3d[1]);}_38.stroke();_3e=(irv+1<=ilv-1)?ilv-1:ilv-1+len;for(i=irv+1;i<=_3e;i+=1){_38.beginPath();_3d=_39[i%len];_38.moveTo(_3d[0],_3d[1]);_3d=_3a[i%len];_38.lineTo(_3d[0],_3d[1]);_38.stroke();}_38.beginPath();_38.moveTo(_3b[0],_3b[1]);_38.lineTo(_3c[0],_3c[1]);_38.stroke();_38.globalAlpha=1;},render:function(_3f,_40){this._updateCoordinates();_3f.strokeStyle=_40;_3f.fillStyle=_40;_3f.lineWidth=realityBuilder.util.SETTINGS.lineWidthOfBlock;this._renderForeground(_3f);this._renderBackground(_3f);}});}