/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realityBuilder.Block"]){dojo._hasResource["realityBuilder.Block"]=true;dojo.provide("realityBuilder.Block");dojo.declare("realityBuilder.Block",null,{_positionB:null,_a:null,_camera:null,_blockProperties:null,_bottomVertexesB:null,_bottomVertexes:null,_bottomVertexesV:null,_bottomVertexesS:null,_topVertexesB:null,_topVertexes:null,_topVertexesV:null,_topVertexesS:null,_projectedVertexesVXZ:null,_projectedVertexesVXZS:null,_boundingBoxS:null,_lastCameraId:null,_lastBlockPropertiesVersionOnServer:null,_lastPositionB:null,_lastA:null,_coordinatesChangedAfterLastRendering:false,_indexOfLeftmostVertex:null,_indexOfRightmostVertex:null,_onlySubtractBottom:false,constructor:function(_1,_2,_3,a){this._positionB=_3;this._a=a;this._blockProperties=_1;this._camera=_2;},positionB:function(){return this._positionB;},xB:function(){return this._positionB[0];},yB:function(){return this._positionB[1];},zB:function(){return this._positionB[2];},a:function(){return this._a;},has2FoldSymmetry:function(){return this._blockProperties.has2FoldSymmetry();},congruencyOffsetB:function(){return this._blockProperties.congruencyOffsetB(this._a);},_vertexesS:function(){return this._bottomVertexesS.concat(this._topVertexesS);},projectedVertexesVXZ:function(){this._updateCoordinates();return (this._projectedVertexesVXZ===null)?false:this._projectedVertexesVXZ;},_updateViewSpaceXZPlaneCoordinates:function(){var i,_4,_5,_6,_7=[],_8,_9;_4=this._bottomVertexesV;_5=this._topVertexesV;_6=_4.length;for(i=0;i<_6;i+=1){_8=[_4[i],_5[i]];_9=realityBuilder.util.intersectionLinePlaneVXZ(_8);if(!_9){_7=null;break;}else{_7.push(_9);}}this._projectedVertexesVXZ=_7;},collidesWith:function(_a){var _b,_c,_d,i;_c=this._blockProperties.rotatedCollisionOffsetsBXY(this,_a);for(i=0;i<_c.length;i+=1){_d=_c[i];_b=[this.xB()+_d[0],this.yB()+_d[1],this.zB()];if(realityBuilder.util.pointsIdenticalB(_a.positionB(),_b)){return true;}}return false;},attachableTo:function(_e){var _f,_10,_11,i;_10=this._blockProperties.rotatedAttachmentOffsetsB(this,_e);for(i=0;i<_10.length;i+=1){_11=_10[i];_f=realityBuilder.util.addVectorsB(this.positionB(),_11);if(realityBuilder.util.pointsIdenticalB(_e.positionB(),_f)){return true;}}return false;},_updateBlockSpaceCoordinates:function(){var xB=this.positionB()[0],yB=this.positionB()[1],zB=this.positionB()[2],_12=this._blockProperties.rotatedOutlineBXY(this.a()),_13=this;this._bottomVertexesB=[];this._topVertexesB=[];dojo.forEach(_12,function(_14){_13._bottomVertexesB.push([xB+_14[0],yB+_14[1],zB]);_13._topVertexesB.push([xB+_14[0],yB+_14[1],zB+1]);});},_blockToWorld:function(pB){return realityBuilder.util.blockToWorld(pB,this._blockProperties);},_updateWorldSpaceCoordinates:function(){this._bottomVertexes=dojo.map(this._bottomVertexesB,dojo.hitch(this,this._blockToWorld));this._topVertexes=dojo.map(this._topVertexesB,dojo.hitch(this,this._blockToWorld));},_updateViewSpaceCoordinates:function(){this._bottomVertexesV=dojo.map(this._bottomVertexes,dojo.hitch(this._camera,this._camera.worldToView));this._topVertexesV=dojo.map(this._topVertexes,dojo.hitch(this._camera,this._camera.worldToView));},_coordinatesNeedToBeUpdated:function(){var _15,_16,_17,_18;_15=this._lastCameraId!==this._camera.id();_16=this._lastBlockPropertiesVersionOnServer!==this._blockProperties.versionOnServer();_17=this._lastPositionB===null||!realityBuilder.util.pointsIdenticalB(this._lastPositionB,this._positionB);_18=this._lastA!==this._a;return _15||_16||_17||_18;},_onCoordinatesUpdated:function(){this._lastBlockPropertiesVersionOnServer=this._blockProperties.versionOnServer();this._lastCameraId=this._camera.id();this._lastPositionB=[this._positionB[0],this._positionB[1],this._positionB[2]];this._lastA=this._a;this._coordinatesChangedAfterLastRendering=true;},_updateHorizontalExtentsInSensorSpace:function(){var _19,_1a,_1b,_1c,i,ilv,irv;_19=this._projectedVertexesVXZS;_1b=_1c=_19[0];ilv=irv=0;for(i=1;i<_19.length;i+=1){_1a=_19[i];if(_1a[0]<_1b[0]){_1b=_1a;ilv=i;}if(_1a[0]>_1c[0]){_1c=_1a;irv=i;}}this._indexOfLeftmostVertex=ilv;this._indexOfRightmostVertex=irv;},_updateProjectedVertexesVXZS:function(){var cam=this._camera;this._projectedVertexesVXZS=dojo.map(this._projectedVertexesVXZ,function(_1d){var _1e=[_1d[0],0,_1d[1]];return cam.viewToSensor(_1e);});},_updateSensorSpaceBoundingBox:function(){var _1f,_20,_21,_22,_23,_24,i;_23=this._vertexesS();if(_23.length>0){_24=_23[0];_1f=_21=_24[0];_20=_22=_24[1];for(i=1;i<_23.length;i+=1){_24=_23[i];if(_24[0]<_1f){_1f=_24[0];}else{if(_24[0]>_21){_21=_24[0];}}if(_24[1]<_20){_20=_24[1];}else{if(_24[1]>_22){_22=_24[1];}}}}this._boundingBoxS=[[_1f,_20],[_21,_22]];},_updateSensorSpaceCoordinates:function(){var cam=this._camera;this._bottomVertexesS=dojo.map(this._bottomVertexesV,dojo.hitch(cam,cam.viewToSensor));this._topVertexesS=dojo.map(this._topVertexesV,dojo.hitch(cam,cam.viewToSensor));this._updateProjectedVertexesVXZS();this._updateHorizontalExtentsInSensorSpace();this._updateSensorSpaceBoundingBox();},_updateCoordinates:function(){if(this._coordinatesNeedToBeUpdated()){this._updateBlockSpaceCoordinates();this._updateWorldSpaceCoordinates();this._updateViewSpaceCoordinates();this._updateViewSpaceXZPlaneCoordinates();this._updateSensorSpaceCoordinates();this._onCoordinatesUpdated();}},onlySubtractBottom:function(){this._onlySubtractBottom=true;},_subtractDrawBottomPath:function(_25){var _26,len,_27,i;_26=this._bottomVertexesS;_27=_26[0];_25.moveTo(_27[0],_27[1]);for(i=1;i<_26.length;i+=1){_27=_26[i];_25.lineTo(_27[0],_27[1]);}},_subtractDrawPath:function(_28){var _29,_2a,len,_2b,i,ilv,irv;_29=this._bottomVertexesS;_2a=this._topVertexesS;len=_2a.length;ilv=this._indexOfLeftmostVertex;irv=this._indexOfRightmostVertex;_2b=_2a[irv];_28.moveTo(_2b[0],_2b[1]);for(i=irv+1;i<=len+ilv;i+=1){_2b=_2a[i%len];_28.lineTo(_2b[0],_2b[1]);}_2b=_29[ilv];_28.lineTo(_2b[0],_2b[1]);for(i=ilv+1;i<=len+irv;i+=1){_2b=_29[i%len];_28.lineTo(_2b[0],_2b[1]);}_2b=_29[irv];_28.lineTo(_2b[0],_2b[1]);},subtract:function(_2c){var _2d,_2e,len,_2f,i,ilv,irv;this._updateCoordinates();_2c.globalCompositeOperation="destination-out";_2c.fillStyle="black";_2c.beginPath();if(this._onlySubtractBottom){this._subtractDrawBottomPath(_2c);}else{this._subtractDrawPath(_2c);}_2c.closePath();_2c.fill();_2c.globalCompositeOperation="source-over";},_renderForeground:function(_30){var _31=this._topVertexesS,_32=this._bottomVertexesS,len=_31.length,_33,_34,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex,_35;_30.globalAlpha=1;_30.beginPath();_34=_32[ilv];_30.moveTo(_34[0],_34[1]);_35=(ilv+1<=irv)?irv:irv+len;for(i=ilv+1;i<=_35;i+=1){_33=_32[i%len];_30.lineTo(_33[0],_33[1]);}_30.stroke();_30.beginPath();_34=_31[0];_30.moveTo(_34[0],_34[1]);for(i=1;i<=len;i+=1){_33=_31[i%len];_30.lineTo(_33[0],_33[1]);}_30.lineTo(_34[0],_34[1]);_30.stroke();_35=(ilv<=irv)?irv:irv+len;for(i=ilv;i<=_35;i+=1){_30.beginPath();_33=_32[i%len];_30.moveTo(_33[0],_33[1]);_33=_31[i%len];_30.lineTo(_33[0],_33[1]);_30.stroke();}},_renderBackground:function(_36){var _37=this._bottomVertexesS,_38=this._topVertexesS,len=_38.length,_39,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex,_3a;_36.globalAlpha=this._blockProperties.backgroundAlpha();_36.beginPath();_39=_37[irv];_36.moveTo(_39[0],_39[1]);_3a=(irv+1<=ilv)?ilv:ilv+len;for(i=irv+1;i<=_3a;i+=1){_39=_37[i%len];_36.lineTo(_39[0],_39[1]);}_36.stroke();_3a=(irv+1<=ilv-1)?ilv-1:ilv-1+len;for(i=irv+1;i<=_3a;i+=1){_36.beginPath();_39=_37[i%len];_36.moveTo(_39[0],_39[1]);_39=_38[i%len];_36.lineTo(_39[0],_39[1]);_36.stroke();}_36.globalAlpha=1;},render:function(_3b,_3c){this._updateCoordinates();_3b.strokeStyle=_3c;_3b.lineWidth=realityBuilder.util.SETTINGS.lineWidthOfBlock;this._renderForeground(_3b);this._renderBackground(_3b);}});}