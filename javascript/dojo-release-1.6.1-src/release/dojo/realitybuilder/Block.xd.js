/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realityBuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","realityBuilder.Block"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["realityBuilder.Block"]){_4._hasResource["realityBuilder.Block"]=true;_4.provide("realityBuilder.Block");_4.declare("realityBuilder.Block",null,{_positionB:null,_a:null,_camera:null,_blockProperties:null,_bottomVertexesB:null,_bottomVertexes:null,_bottomVertexesV:null,_bottomVertexesS:null,_topVertexesB:null,_topVertexes:null,_topVertexesV:null,_topVertexesS:null,_projectedVertexesVXZ:null,_projectedVertexesVXZS:null,_boundingBoxS:null,_lastCameraId:null,_lastBlockPropertiesVersionOnServer:null,_lastPositionB:null,_lastA:null,_coordinatesChangedAfterLastRendering:false,_indexOfLeftmostVertex:null,_indexOfRightmostVertex:null,_onlySubtractBottom:false,constructor:function(_7,_8,_9,a){this._positionB=_9;this._a=a;this._blockProperties=_7;this._camera=_8;},positionB:function(){return this._positionB;},xB:function(){return this._positionB[0];},yB:function(){return this._positionB[1];},zB:function(){return this._positionB[2];},a:function(){return this._a;},has2FoldSymmetry:function(){return this._blockProperties.has2FoldSymmetry();},congruencyOffsetB:function(){return this._blockProperties.congruencyOffsetB(this._a);},_vertexesS:function(){return this._bottomVertexesS.concat(this._topVertexesS);},projectedVertexesVXZ:function(){this._updateCoordinates();return (this._projectedVertexesVXZ===null)?false:this._projectedVertexesVXZ;},_updateViewSpaceXZPlaneCoordinates:function(){var i,_a,_b,_c,_d=[],_e,_f;_a=this._bottomVertexesV;_b=this._topVertexesV;_c=_a.length;for(i=0;i<_c;i+=1){_e=[_a[i],_b[i]];_f=realityBuilder.util.intersectionLinePlaneVXZ(_e);if(!_f){_d=null;break;}else{_d.push(_f);}}this._projectedVertexesVXZ=_d;},collidesWith:function(_10){var _11,_12,_13,i;_12=this._blockProperties.rotatedCollisionOffsetsBXY(this,_10);for(i=0;i<_12.length;i+=1){_13=_12[i];_11=[this.xB()+_13[0],this.yB()+_13[1],this.zB()];if(realityBuilder.util.pointsIdenticalB(_10.positionB(),_11)){return true;}}return false;},attachableTo:function(_14){var _15,_16,_17,i;_16=this._blockProperties.rotatedAttachmentOffsetsB(this,_14);for(i=0;i<_16.length;i+=1){_17=_16[i];_15=realityBuilder.util.addVectorsB(this.positionB(),_17);if(realityBuilder.util.pointsIdenticalB(_14.positionB(),_15)){return true;}}return false;},_updateBlockSpaceCoordinates:function(){var xB=this.positionB()[0],yB=this.positionB()[1],zB=this.positionB()[2],_18=this._blockProperties.rotatedOutlineBXY(this.a()),_19=this;this._bottomVertexesB=[];this._topVertexesB=[];_4.forEach(_18,function(_1a){_19._bottomVertexesB.push([xB+_1a[0],yB+_1a[1],zB]);_19._topVertexesB.push([xB+_1a[0],yB+_1a[1],zB+1]);});},_blockToWorld:function(pB){return realityBuilder.util.blockToWorld(pB,this._blockProperties);},_updateWorldSpaceCoordinates:function(){this._bottomVertexes=_4.map(this._bottomVertexesB,_4.hitch(this,this._blockToWorld));this._topVertexes=_4.map(this._topVertexesB,_4.hitch(this,this._blockToWorld));},_updateViewSpaceCoordinates:function(){this._bottomVertexesV=_4.map(this._bottomVertexes,_4.hitch(this._camera,this._camera.worldToView));this._topVertexesV=_4.map(this._topVertexes,_4.hitch(this._camera,this._camera.worldToView));},_coordinatesNeedToBeUpdated:function(){var _1b,_1c,_1d,_1e;_1b=this._lastCameraId!==this._camera.id();_1c=this._lastBlockPropertiesVersionOnServer!==this._blockProperties.versionOnServer();_1d=this._lastPositionB===null||!realityBuilder.util.pointsIdenticalB(this._lastPositionB,this._positionB);_1e=this._lastA!==this._a;return _1b||_1c||_1d||_1e;},_onCoordinatesUpdated:function(){this._lastBlockPropertiesVersionOnServer=this._blockProperties.versionOnServer();this._lastCameraId=this._camera.id();this._lastPositionB=[this._positionB[0],this._positionB[1],this._positionB[2]];this._lastA=this._a;this._coordinatesChangedAfterLastRendering=true;},_updateHorizontalExtentsInSensorSpace:function(){var _1f,_20,_21,_22,i,ilv,irv;_1f=this._projectedVertexesVXZS;_21=_22=_1f[0];ilv=irv=0;for(i=1;i<_1f.length;i+=1){_20=_1f[i];if(_20[0]<_21[0]){_21=_20;ilv=i;}if(_20[0]>_22[0]){_22=_20;irv=i;}}this._indexOfLeftmostVertex=ilv;this._indexOfRightmostVertex=irv;},_updateProjectedVertexesVXZS:function(){var cam=this._camera;this._projectedVertexesVXZS=_4.map(this._projectedVertexesVXZ,function(_23){var _24=[_23[0],0,_23[1]];return cam.viewToSensor(_24);});},_updateSensorSpaceBoundingBox:function(){var _25,_26,_27,_28,_29,_2a,i;_29=this._vertexesS();if(_29.length>0){_2a=_29[0];_25=_27=_2a[0];_26=_28=_2a[1];for(i=1;i<_29.length;i+=1){_2a=_29[i];if(_2a[0]<_25){_25=_2a[0];}else{if(_2a[0]>_27){_27=_2a[0];}}if(_2a[1]<_26){_26=_2a[1];}else{if(_2a[1]>_28){_28=_2a[1];}}}}this._boundingBoxS=[[_25,_26],[_27,_28]];},_updateSensorSpaceCoordinates:function(){var cam=this._camera;this._bottomVertexesS=_4.map(this._bottomVertexesV,_4.hitch(cam,cam.viewToSensor));this._topVertexesS=_4.map(this._topVertexesV,_4.hitch(cam,cam.viewToSensor));this._updateProjectedVertexesVXZS();this._updateHorizontalExtentsInSensorSpace();this._updateSensorSpaceBoundingBox();},_updateCoordinates:function(){if(this._coordinatesNeedToBeUpdated()){this._updateBlockSpaceCoordinates();this._updateWorldSpaceCoordinates();this._updateViewSpaceCoordinates();this._updateViewSpaceXZPlaneCoordinates();this._updateSensorSpaceCoordinates();this._onCoordinatesUpdated();}},onlySubtractBottom:function(){this._onlySubtractBottom=true;},_subtractDrawBottomPath:function(_2b){var _2c,len,_2d,i;_2c=this._bottomVertexesS;_2d=_2c[0];_2b.moveTo(_2d[0],_2d[1]);for(i=1;i<_2c.length;i+=1){_2d=_2c[i];_2b.lineTo(_2d[0],_2d[1]);}},_subtractDrawPath:function(_2e){var _2f,_30,len,_31,i,ilv,irv;_2f=this._bottomVertexesS;_30=this._topVertexesS;len=_30.length;ilv=this._indexOfLeftmostVertex;irv=this._indexOfRightmostVertex;_31=_30[irv];_2e.moveTo(_31[0],_31[1]);for(i=irv+1;i<=len+ilv;i+=1){_31=_30[i%len];_2e.lineTo(_31[0],_31[1]);}_31=_2f[ilv];_2e.lineTo(_31[0],_31[1]);for(i=ilv+1;i<=len+irv;i+=1){_31=_2f[i%len];_2e.lineTo(_31[0],_31[1]);}_31=_2f[irv];_2e.lineTo(_31[0],_31[1]);},subtract:function(_32){var _33,_34,len,_35,i,ilv,irv;this._updateCoordinates();_32.globalCompositeOperation="destination-out";_32.fillStyle="black";_32.beginPath();if(this._onlySubtractBottom){this._subtractDrawBottomPath(_32);}else{this._subtractDrawPath(_32);}_32.closePath();_32.fill();_32.globalCompositeOperation="source-over";},_renderForeground:function(_36){var _37=this._topVertexesS,_38=this._bottomVertexesS,len=_37.length,_39,_3a,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex,_3b;_36.globalAlpha=1;_36.beginPath();_3a=_38[ilv];_36.moveTo(_3a[0],_3a[1]);_3b=(ilv+1<=irv)?irv:irv+len;for(i=ilv+1;i<=_3b;i+=1){_39=_38[i%len];_36.lineTo(_39[0],_39[1]);}_36.stroke();_36.beginPath();_3a=_37[0];_36.moveTo(_3a[0],_3a[1]);for(i=1;i<=len;i+=1){_39=_37[i%len];_36.lineTo(_39[0],_39[1]);}_36.lineTo(_3a[0],_3a[1]);_36.stroke();_3b=(ilv<=irv)?irv:irv+len;for(i=ilv;i<=_3b;i+=1){_36.beginPath();_39=_38[i%len];_36.moveTo(_39[0],_39[1]);_39=_37[i%len];_36.lineTo(_39[0],_39[1]);_36.stroke();}},_renderBackground:function(_3c){var _3d=this._bottomVertexesS,_3e=this._topVertexesS,len=_3e.length,_3f,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex,_40;_3c.globalAlpha=this._blockProperties.backgroundAlpha();_3c.beginPath();_3f=_3d[irv];_3c.moveTo(_3f[0],_3f[1]);_40=(irv+1<=ilv)?ilv:ilv+len;for(i=irv+1;i<=_40;i+=1){_3f=_3d[i%len];_3c.lineTo(_3f[0],_3f[1]);}_3c.stroke();_40=(irv+1<=ilv-1)?ilv-1:ilv-1+len;for(i=irv+1;i<=_40;i+=1){_3c.beginPath();_3f=_3d[i%len];_3c.moveTo(_3f[0],_3f[1]);_3f=_3e[i%len];_3c.lineTo(_3f[0],_3f[1]);_3c.stroke();}_3c.globalAlpha=1;},render:function(_41,_42){this._updateCoordinates();_41.strokeStyle=_42;this._renderForeground(_41);this._renderBackground(_41);}});}}};});