/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realitybuilder.Camera"]){dojo._hasResource["realitybuilder.Camera"]=true;dojo.provide("realitybuilder.Camera");dojo.require("realitybuilder.util");dojo.require("realitybuilder.Sensor");dojo.require("dojox.math.matrix");dojo.declare("realitybuilder.Camera",null,{_blockProperties:null,_position:null,_aX:0,_aY:0,_aZ:0,_fl:1,_sensorResolution:100,_rZ:null,_rX:null,_rZYX:null,_sensor:null,_versionOnServer:"-1",_id:null,constructor:function(_1,_2,_3,_4){this._blockProperties=_1;this._position=[0,0,1];this._sensor=new realitybuilder.Sensor(_2,_3,_4);this._updateRotationMatrices();},_updateId:function(){this._id=Math.random().toString();},sensor:function(){return this._sensor;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},position:function(){return this._position;},aX:function(){return this._aX;},aY:function(){return this._aY;},aZ:function(){return this._aZ;},fl:function(){return this._fl;},sensorResolution:function(){return this._sensorResolution;},id:function(){return this._id;},update:function(_5){this._position=_5.position;this._aX=_5.aX;this._aY=_5.aY;this._aZ=_5.aZ;this._fl=_5.fl;this._sensorResolution=_5.sensorResolution;this._updateRotationMatrices();this._updateId();dojo.publish("realitybuilder/Camera/changed");},updateWithServerData:function(_6){if(this._versionOnServer!==_6.version){this._versionOnServer=_6.version;this.update(_6);}},_updateRotationMatrices:function(){var _7;this._rX=[[1,0,0],[0,Math.cos(-this._aX),Math.sin(-this._aX)],[0,-Math.sin(-this._aX),Math.cos(-this._aX)]];this._rY=[[Math.cos(-this._aY),0,Math.sin(-this._aY)],[0,1,0],[-Math.sin(-this._aY),0,Math.cos(-this._aY)]];this._rZ=[[Math.cos(-this._aZ),Math.sin(-this._aZ),0],[-Math.sin(-this._aZ),Math.cos(-this._aZ),0],[0,0,1]];_7=dojox.math.matrix.multiply(this._rY,this._rX);this._rZYX=dojox.math.matrix.multiply(this._rZ,_7);},worldToView:function(_8){var _9=realitybuilder.util.subtractVectors3D(_8,this._position);_9=dojox.math.matrix.transpose([_9]);_9=dojox.math.matrix.multiply(this._rZYX,_9);_9=dojox.math.matrix.transpose(_9)[0];return _9;},scale:function(zV){return this._sensorResolution*this._fl/zV;},viewToSensor:function(_a){var xV=_a[0],yV=_a[1],zV=_a[2],_b;_b=this.scale(zV);xV*=_b;yV*=_b;xV+=this._sensor.width()/2;yV+=this._sensor.height()/2;return [xV,yV];},blockToSensor:function(_c){return this.viewToSensor(this.worldToView(realitybuilder.util.blockToWorld(_c,this._blockProperties)));}});}