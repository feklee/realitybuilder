/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realitybuilder.ConstructionBlocks"]){dojo._hasResource["realitybuilder.ConstructionBlocks"]=true;dojo.provide("realitybuilder.ConstructionBlocks");dojo.require("realitybuilder.ConstructionBlock");dojo.require("realitybuilder.util");dojo.require("dojo.io.script");dojo.declare("realitybuilder.ConstructionBlocks",null,{_versionOnServer:"-1",_camera:null,_blockProperties:null,_constructionBlockProperties:null,_blocks:null,_realBlocksSorted:null,_pendingBlocks:null,constructor:function(_1,_2,_3){this._blockProperties=_1;this._constructionBlockProperties=_2;this._blocks=[];this._realBlocksSorted=[];this._camera=_3;},blocks:function(){return this._blocks;},pendingBlocks:function(){return this._pendingBlocks;},realBlocksSorted:function(){return this._realBlocksSorted;},highestRealBlocksZB:function(){if(this._realBlocksSorted.length>0){return this._realBlocksSorted[0].zB();}else{return -1;}},realBlocksInLayer:function(zB){var _4=[],i,_5=this._realBlocksSorted,_6;for(i=0;i<_5.length;i+=1){_6=_5[i];if(_6.zB()===zB){_4.push(_6);}else{if(_6.zB()<zB){break;}}}return _4;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},_createBlockFromServerData:function(_7){var _8=this._camera,rb=realitybuilder;return new rb.ConstructionBlock(this._blockProperties,_8,_7.positionB,_7.a,this._constructionBlockProperties,_7.state,_7.timeStamp);},updateWithServerData:function(_9){if(this._versionOnServer!==_9.version){this._versionOnServer=_9.version;this._blocks=dojo.map(_9.blocks,dojo.hitch(this,this._createBlockFromServerData));this._updateRealBlocksSorted();this._updatePendingBlocks();dojo.publish("realitybuilder/ConstructionBlocks/changed");}},_sortByHeight:function(_a,_b){if(_a.zB()>_b.zB()){return -1;}else{if(_a.zB()<_b.zB()){return 1;}else{return 0;}}},_updateRealBlocksSorted:function(_c){var _d=dojo.filter(this._blocks,function(_e){return _e.isReal();});_d.sort(this._sortByHeight);this._realBlocksSorted=_d;},_updatePendingBlocks:function(_f){this._pendingBlocks=dojo.filter(this._blocks,function(_10){return _10.isPending();});},blockAt:function(_11){var _12=this.blocks(),_13,i;for(i=0;i<_12.length;i+=1){_13=_12[i];if(realitybuilder.util.pointsIdenticalB(_11,_13.positionB())){return _13;}}return false;},realBlocksCollideWith:function(_14){var _15=this.realBlocksSorted(),_16,i;for(i=0;i<_15.length;i+=1){_16=_15[i];if(_16.collidesWith(_14)){return true;}}return false;},realBlocksAreAttachableTo:function(_17){var _18=this.realBlocksSorted(),_19,i;for(i=0;i<_18.length;i+=1){_19=_18[i];if(_19.attachableTo(_17)){return true;}}return false;},_makePendingOnServerSucceeded:function(){dojo.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_makePendingOnServerFailed:function(){dojo.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},makePendingOnServer:function(_1a,a){dojo.io.script.get({url:realitybuilder.util.rootUrl()+"admin/rpc/make_pending",callbackParamName:"callback",content:{"xB":_1a[0],"yB":_1a[1],"zB":_1a[2],"a":a},load:dojo.hitch(this,this._makePendingOnServerSucceeded),error:dojo.hitch(this,this._makePendingOnServerFailed),timeout:5000});},_deleteOnServerSucceeded:function(){dojo.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_deleteOnServerFailed:function(){dojo.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},deleteOnServer:function(_1b,a){dojo.io.script.get({url:realitybuilder.util.rootUrl()+"admin/rpc/delete",callbackParamName:"callback",content:{"xB":_1b[0],"yB":_1b[1],"zB":_1b[2],"a":a},load:dojo.hitch(this,this._deleteOnServerSucceeded),error:dojo.hitch(this,this._deleteOnServerFailed)});},_makeRealOnServerSucceeded:function(){dojo.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_makeRealOnServerFailed:function(){dojo.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},makeRealOnServer:function(_1c,a){dojo.io.script.get({url:realitybuilder.util.rootUrl()+"admin/rpc/make_real",callbackParamName:"callback",content:{"xB":_1c[0],"yB":_1c[1],"zB":_1c[2],"a":a},load:dojo.hitch(this,this._makeRealOnServerSucceeded),error:dojo.hitch(this,this._makeRealOnServerFailed)});},setBlockStateOnServer:function(_1d,a,_1e){switch(_1e){case 0:this.deleteOnServer(_1d,a);break;case 1:this.makePendingOnServer(_1d,a);break;case 2:this.makeRealOnServer(_1d,a);break;}},zBOfUpperSideOfRealBlockBelow:function(xB,yB,zB){var _1f,_20,_21,bXB,bYB,bZB;_1f=this._realBlocksSorted;_20=zB-1;_21=0;dojo.forEach(_1f,function(b){bXB=b.xB();bYB=b.yB();bZB=b.zB();if(bZB+1<=_20&&xB>=bXB&&xB<=bXB+1&&yB>=bYB&&yB<=bYB+1&&bZB+1>_21){_21=bZB+1;}});return _21;},_renderBlocks:function(_22,_23){if(_22.getContext){var _24=_22.getContext("2d");realitybuilder.util.clearCanvas(_22);dojo.forEach(_23,function(b){b.render(_24);});}},renderIfVisible:function(){var _25=this._camera.sensor();if(_25.realBlocksAreVisible()){this._renderBlocks(_25.realBlocksCanvas(),this._realBlocksSorted);}if(_25.pendingBlocksAreVisible()){this._renderBlocks(_25.pendingBlocksCanvas(),this._pendingBlocks);}}});}