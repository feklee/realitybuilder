/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realityBuilder.ConstructionBlocks"]){dojo._hasResource["realityBuilder.ConstructionBlocks"]=true;dojo.provide("realityBuilder.ConstructionBlocks");dojo.require("realityBuilder.ConstructionBlock");dojo.require("realityBuilder.util");dojo.declare("realityBuilder.ConstructionBlocks",null,{_versionOnServer:"-1",_camera:null,_blockProperties:null,_blocks:null,_realBlocksSorted:null,_pendingBlocks:null,constructor:function(_1,_2){this._blockProperties=_1;this._blocks=[];this._realBlocksSorted=[];this._camera=_2;},blocks:function(){return this._blocks;},pendingBlocks:function(){return this._pendingBlocks;},realBlocksSorted:function(){return this._realBlocksSorted;},highestRealBlocksZB:function(){if(this._realBlocksSorted.length>0){return this._realBlocksSorted[0].zB();}else{return -1;}},realBlocksInLayer:function(zB){var _3=[],i,_4=this._realBlocksSorted,_5;for(i=0;i<_4.length;i+=1){_5=_4[i];if(_5.zB()===zB){_3.push(_5);}else{if(_5.zB()<zB){break;}}}return _3;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},_createBlockFromServerData:function(_6){var _7=this._camera,rb=realityBuilder;return new rb.ConstructionBlock(this._blockProperties,_7,_6.positionB,_6.a,_6.state,_6.timeStamp);},updateWithServerData:function(_8){if(this._versionOnServer!==_8.version){this._versionOnServer=_8.version;this._blocks=dojo.map(_8.blocks,dojo.hitch(this,this._createBlockFromServerData));this._updateRealBlocksSorted();this._updatePendingBlocks();dojo.publish("realityBuilder/ConstructionBlocks/changed");}},_sortByHeight:function(_9,_a){if(_9.zB()>_a.zB()){return -1;}else{if(_9.zB()<_a.zB()){return 1;}else{return 0;}}},_updateRealBlocksSorted:function(_b){var _c=dojo.filter(this._blocks,function(_d){return _d.isReal();});_c.sort(this._sortByHeight);this._realBlocksSorted=_c;},_updatePendingBlocks:function(_e){this._pendingBlocks=dojo.filter(this._blocks,function(_f){return _f.isPending();});},blockAt:function(_10,a){var _11=this.blocks(),_12,i;for(i=0;i<_11.length;i+=1){_12=_11[i];if(realityBuilder.util.pointsIdenticalB(_10,_12.positionB())&&a===_12.a()){return _12;}}return false;},realBlocksCollideWith:function(_13){var _14=this.realBlocksSorted(),_15,i;for(i=0;i<_14.length;i+=1){_15=_14[i];if(_15.collidesWith(_13)){return true;}}return false;},realBlocksAreAttachableTo:function(_16){var _17=this.realBlocksSorted(),_18,i;for(i=0;i<_17.length;i+=1){_18=_17[i];if(_18.attachableTo(_16)){return true;}}return false;},_makePendingOnServerSucceeded:function(){dojo.publish("realityBuilder/ConstructionBlocks/changedOnServer");},_makePendingOnServerFailed:function(){dojo.publish("realityBuilder/ConstructionBlocks/"+"changeOnServerFailed");},makePendingOnServer:function(_19,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/make_pending",content:{"xB":_19[0],"yB":_19[1],"zB":_19[2],"a":a},load:dojo.hitch(this,this._makePendingOnServerSucceeded)});},_deleteOnServerSucceeded:function(){dojo.publish("realityBuilder/ConstructionBlocks/changedOnServer");},deleteOnServer:function(_1a,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/delete",content:{"xB":_1a[0],"yB":_1a[1],"zB":_1a[2],"a":a},load:dojo.hitch(this,this._deleteOnServerSucceeded)});},_makeRealOnServerSucceeded:function(){dojo.publish("realityBuilder/ConstructionBlocks/changedOnServer");},_makeRealOnServerFailed:function(){dojo.publish("realityBuilder/ConstructionBlocks/"+"changeOnServerFailed");},makeRealOnServer:function(_1b,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/make_real",content:{"xB":_1b[0],"yB":_1b[1],"zB":_1b[2],"a":a},load:dojo.hitch(this,this._makeRealOnServerSucceeded)});},setBlockStateOnServer:function(_1c,a,_1d){switch(_1d){case 0:this.deleteOnServer(_1c,a);break;case 1:this.makePendingOnServer(_1c,a);break;case 2:this.makeRealOnServer(_1c,a);break;}},zBOfUpperSideOfRealBlockBelow:function(xB,yB,zB){var _1e,_1f,_20,bXB,bYB,bZB;_1e=this._realBlocksSorted;_1f=zB-1;_20=0;dojo.forEach(_1e,function(b){bXB=b.xB();bYB=b.yB();bZB=b.zB();if(bZB+1<=_1f&&xB>=bXB&&xB<=bXB+1&&yB>=bYB&&yB<=bYB+1&&bZB+1>_20){_20=bZB+1;}});return _20;},_renderBlocks:function(_21,_22){if(_21.getContext){var _23=_21.getContext("2d");realityBuilder.util.clearCanvas(_21);dojo.forEach(_22,function(b){b.render(_23);});}},renderIfVisible:function(){var _24=this._camera.sensor();if(_24.realBlocksAreVisible()){this._renderBlocks(_24.realBlocksCanvas(),this._realBlocksSorted);}if(_24.pendingBlocksAreVisible()){this._renderBlocks(_24.pendingBlocksCanvas(),this._pendingBlocks);}}});}