/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realityBuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","realityBuilder.ConstructionBlocks"],["require","realityBuilder.ConstructionBlock"],["require","realityBuilder.util"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["realityBuilder.ConstructionBlocks"]){_4._hasResource["realityBuilder.ConstructionBlocks"]=true;_4.provide("realityBuilder.ConstructionBlocks");_4.require("realityBuilder.ConstructionBlock");_4.require("realityBuilder.util");_4.declare("realityBuilder.ConstructionBlocks",null,{_versionOnServer:"-1",_camera:null,_blockProperties:null,_constructionBlockProperties:null,_blocks:null,_realBlocksSorted:null,_pendingBlocks:null,constructor:function(_7,_8,_9){this._blockProperties=_7;this._constructionBlockProperties=_8;this._blocks=[];this._realBlocksSorted=[];this._camera=_9;},blocks:function(){return this._blocks;},pendingBlocks:function(){return this._pendingBlocks;},realBlocksSorted:function(){return this._realBlocksSorted;},highestRealBlocksZB:function(){if(this._realBlocksSorted.length>0){return this._realBlocksSorted[0].zB();}else{return -1;}},realBlocksInLayer:function(zB){var _a=[],i,_b=this._realBlocksSorted,_c;for(i=0;i<_b.length;i+=1){_c=_b[i];if(_c.zB()===zB){_a.push(_c);}else{if(_c.zB()<zB){break;}}}return _a;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},_createBlockFromServerData:function(_d){var _e=this._camera,rb=realityBuilder;return new rb.ConstructionBlock(this._blockProperties,_e,_d.positionB,_d.a,this._constructionBlockProperties,_d.state,_d.timeStamp);},updateWithServerData:function(_f){if(this._versionOnServer!==_f.version){this._versionOnServer=_f.version;this._blocks=_4.map(_f.blocks,_4.hitch(this,this._createBlockFromServerData));this._updateRealBlocksSorted();this._updatePendingBlocks();_4.publish("realityBuilder/ConstructionBlocks/changed");}},_sortByHeight:function(_10,_11){if(_10.zB()>_11.zB()){return -1;}else{if(_10.zB()<_11.zB()){return 1;}else{return 0;}}},_updateRealBlocksSorted:function(_12){var tmp=_4.filter(this._blocks,function(_13){return _13.isReal();});tmp.sort(this._sortByHeight);this._realBlocksSorted=tmp;},_updatePendingBlocks:function(_14){this._pendingBlocks=_4.filter(this._blocks,function(_15){return _15.isPending();});},blockAt:function(_16){var _17=this.blocks(),_18,i;for(i=0;i<_17.length;i+=1){_18=_17[i];if(realityBuilder.util.pointsIdenticalB(_16,_18.positionB())){return _18;}}return false;},realBlocksCollideWith:function(_19){var _1a=this.realBlocksSorted(),_1b,i;for(i=0;i<_1a.length;i+=1){_1b=_1a[i];if(_1b.collidesWith(_19)){return true;}}return false;},realBlocksAreAttachableTo:function(_1c){var _1d=this.realBlocksSorted(),_1e,i;for(i=0;i<_1d.length;i+=1){_1e=_1d[i];if(_1e.attachableTo(_1c)){return true;}}return false;},_makePendingOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},_makePendingOnServerFailed:function(){_4.publish("realityBuilder/ConstructionBlocks/"+"changeOnServerFailed");},makePendingOnServer:function(_1f,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/make_pending",content:{"xB":_1f[0],"yB":_1f[1],"zB":_1f[2],"a":a},load:_4.hitch(this,this._makePendingOnServerSucceeded)});},_deleteOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},deleteOnServer:function(_20,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/delete",content:{"xB":_20[0],"yB":_20[1],"zB":_20[2],"a":a},load:_4.hitch(this,this._deleteOnServerSucceeded)});},_makeRealOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},_makeRealOnServerFailed:function(){_4.publish("realityBuilder/ConstructionBlocks/"+"changeOnServerFailed");},makeRealOnServer:function(_21,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/make_real",content:{"xB":_21[0],"yB":_21[1],"zB":_21[2],"a":a},load:_4.hitch(this,this._makeRealOnServerSucceeded)});},setBlockStateOnServer:function(_22,a,_23){switch(_23){case 0:this.deleteOnServer(_22,a);break;case 1:this.makePendingOnServer(_22,a);break;case 2:this.makeRealOnServer(_22,a);break;}},zBOfUpperSideOfRealBlockBelow:function(xB,yB,zB){var _24,_25,_26,bXB,bYB,bZB;_24=this._realBlocksSorted;_25=zB-1;_26=0;_4.forEach(_24,function(b){bXB=b.xB();bYB=b.yB();bZB=b.zB();if(bZB+1<=_25&&xB>=bXB&&xB<=bXB+1&&yB>=bYB&&yB<=bYB+1&&bZB+1>_26){_26=bZB+1;}});return _26;},_renderBlocks:function(_27,_28){if(_27.getContext){var _29=_27.getContext("2d");realityBuilder.util.clearCanvas(_27);_4.forEach(_28,function(b){b.render(_29);});}},renderIfVisible:function(){var _2a=this._camera.sensor();if(_2a.realBlocksAreVisible()){this._renderBlocks(_2a.realBlocksCanvas(),this._realBlocksSorted);}if(_2a.pendingBlocksAreVisible()){this._renderBlocks(_2a.pendingBlocksCanvas(),this._pendingBlocks);}}});}}};});