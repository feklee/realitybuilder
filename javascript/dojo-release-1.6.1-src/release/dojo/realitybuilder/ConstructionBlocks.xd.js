/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realityBuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","realityBuilder.ConstructionBlocks"],["require","realityBuilder.ConstructionBlock"],["require","realityBuilder.util"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["realityBuilder.ConstructionBlocks"]){_4._hasResource["realityBuilder.ConstructionBlocks"]=true;_4.provide("realityBuilder.ConstructionBlocks");_4.require("realityBuilder.ConstructionBlock");_4.require("realityBuilder.util");_4.declare("realityBuilder.ConstructionBlocks",null,{_versionOnServer:"-1",_camera:null,_blockProperties:null,_blocks:null,_realBlocksSorted:null,_pendingBlocks:null,constructor:function(_7,_8){this._blockProperties=_7;this._blocks=[];this._realBlocksSorted=[];this._camera=_8;},blocks:function(){return this._blocks;},pendingBlocks:function(){return this._pendingBlocks;},realBlocksSorted:function(){return this._realBlocksSorted;},highestRealBlocksZB:function(){if(this._realBlocksSorted.length>0){return this._realBlocksSorted[0].zB();}else{return -1;}},realBlocksInLayer:function(zB){var _9=[],i,_a=this._realBlocksSorted,_b;for(i=0;i<_a.length;i+=1){_b=_a[i];if(_b.zB()===zB){_9.push(_b);}else{if(_b.zB()<zB){break;}}}return _9;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},_createBlockFromServerData:function(_c){var _d=this._camera,rb=realityBuilder;return new rb.ConstructionBlock(this._blockProperties,_d,_c.positionB,_c.a,_c.state,_c.timeStamp);},updateWithServerData:function(_e){if(this._versionOnServer!==_e.version){this._versionOnServer=_e.version;this._blocks=_4.map(_e.blocks,_4.hitch(this,this._createBlockFromServerData));this._updateRealBlocksSorted();this._updatePendingBlocks();_4.publish("realityBuilder/ConstructionBlocks/changed");}},_sortByHeight:function(_f,_10){if(_f.zB()>_10.zB()){return -1;}else{if(_f.zB()<_10.zB()){return 1;}else{return 0;}}},_updateRealBlocksSorted:function(_11){var tmp=_4.filter(this._blocks,function(_12){return _12.isReal();});tmp.sort(this._sortByHeight);this._realBlocksSorted=tmp;},_updatePendingBlocks:function(_13){this._pendingBlocks=_4.filter(this._blocks,function(_14){return _14.isPending();});},blockAt:function(_15,a){var _16=this.blocks(),_17,i;for(i=0;i<_16.length;i+=1){_17=_16[i];if(realityBuilder.util.pointsIdenticalB(_15,_17.positionB())&&a===_17.a()){return _17;}}return false;},realBlocksCollideWith:function(_18){var _19=this.realBlocksSorted(),_1a,i;for(i=0;i<_19.length;i+=1){_1a=_19[i];if(_1a.collidesWith(_18)){return true;}}return false;},realBlocksAreAttachableTo:function(_1b){var _1c=this.realBlocksSorted(),_1d,i;for(i=0;i<_1c.length;i+=1){_1d=_1c[i];if(_1d.attachableTo(_1b)){return true;}}return false;},_makePendingOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},_makePendingOnServerFailed:function(){_4.publish("realityBuilder/ConstructionBlocks/"+"changeOnServerFailed");},makePendingOnServer:function(_1e,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/make_pending",content:{"xB":_1e[0],"yB":_1e[1],"zB":_1e[2],"a":a},load:_4.hitch(this,this._makePendingOnServerSucceeded)});},_deleteOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},deleteOnServer:function(_1f,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/delete",content:{"xB":_1f[0],"yB":_1f[1],"zB":_1f[2],"a":a},load:_4.hitch(this,this._deleteOnServerSucceeded)});},_makeRealOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},_makeRealOnServerFailed:function(){_4.publish("realityBuilder/ConstructionBlocks/"+"changeOnServerFailed");},makeRealOnServer:function(_20,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/make_real",content:{"xB":_20[0],"yB":_20[1],"zB":_20[2],"a":a},load:_4.hitch(this,this._makeRealOnServerSucceeded)});},setBlockStateOnServer:function(_21,a,_22){switch(_22){case 0:this.deleteOnServer(_21,a);break;case 1:this.makePendingOnServer(_21,a);break;case 2:this.makeRealOnServer(_21,a);break;}},zBOfUpperSideOfRealBlockBelow:function(xB,yB,zB){var _23,_24,_25,bXB,bYB,bZB;_23=this._realBlocksSorted;_24=zB-1;_25=0;_4.forEach(_23,function(b){bXB=b.xB();bYB=b.yB();bZB=b.zB();if(bZB+1<=_24&&xB>=bXB&&xB<=bXB+1&&yB>=bYB&&yB<=bYB+1&&bZB+1>_25){_25=bZB+1;}});return _25;},_renderBlocks:function(_26,_27){if(_26.getContext){var _28=_26.getContext("2d");realityBuilder.util.clearCanvas(_26);_4.forEach(_27,function(b){b.render(_28);});}},renderIfVisible:function(){var _29=this._camera.sensor();if(_29.realBlocksAreVisible()){this._renderBlocks(_29.realBlocksCanvas(),this._realBlocksSorted);}if(_29.pendingBlocksAreVisible()){this._renderBlocks(_29.pendingBlocksCanvas(),this._pendingBlocks);}}});}}};});