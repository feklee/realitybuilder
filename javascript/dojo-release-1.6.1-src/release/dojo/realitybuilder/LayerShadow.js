/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realitybuilder.LayerShadow"]){dojo._hasResource["realitybuilder.LayerShadow"]=true;dojo.provide("realitybuilder.LayerShadow");dojo.declare("realitybuilder.LayerShadow",null,{_newBlock:null,_camera:null,_blockProperties:null,_constructionBlocks:null,_fullVertexes:null,_fullVertexesV:null,_fullVertexesS:null,_canvas:null,_helperCanvas:null,constructor:function(_1,_2,_3,_4){var _5;this._newBlock=_1;this._blockProperties=_2;this._camera=_3;this._constructionBlocks=_4;_5=_3.sensor().shadowCanvas();this._canvas=dojo.create("canvas");dojo.attr(this._canvas,"width",_5.width);dojo.attr(this._canvas,"height",_5.height);this._helperCanvas=dojo.create("canvas");dojo.attr(this._helperCanvas,"width",_5.width);dojo.attr(this._helperCanvas,"height",_5.height);if(realitybuilder.util.isFlashCanvasActive()){FlashCanvas.initElement(this._canvas);FlashCanvas.initElement(this._helperCanvas);}},canvas:function(){return this._canvas;},_updateWorldSpace:function(_6){var xB=this._newBlock.xB(),yB=this._newBlock.yB(),zB=_6+1,vs=[],_7=this._blockProperties.rotatedOutlineBXY(this._newBlock.a()),_8=this;dojo.forEach(_7,function(_9){vs.push(realitybuilder.util.blockToWorld([xB+_9[0],yB+_9[1],zB],_8._blockProperties));});this._fullVertexes=vs;},_updateViewSpaceCoordinates:function(_a){this._updateWorldSpace(_a);this._fullVertexesV=dojo.map(this._fullVertexes,dojo.hitch(this._camera,this._camera.worldToView));},_updateSensorSpaceCoordinates:function(_b){this._fullVertexesS=dojo.map(this._fullVertexesV,dojo.hitch(this._camera,this._camera.viewToSensor));},_updateCoordinates:function(_c){this._updateViewSpaceCoordinates(_c);this._updateSensorSpaceCoordinates(_c);},_renderTops:function(_d,_e){var _f=this._constructionBlocks.realBlocksInLayer(_d);dojo.forEach(_f,function(_10){_10.renderSolidTop(_e);});},_renderFull:function(_11,_12,_13){var _14,_15,i;this._updateCoordinates(_11);_14=this._fullVertexesS;_12.fillStyle=_13;_15=_14[0];_12.beginPath();_12.moveTo(_15[0],_15[1]);for(i=1;i<_14.length;i+=1){_15=_14[i];_12.lineTo(_15[0],_15[1]);}_12.closePath();_12.fill();},render:function(_16,_17){var _18=this._canvas,_19=this._helperCanvas,_1a,_1b;if(_18.getContext){_1a=_18.getContext("2d");realitybuilder.util.clearCanvas(_18);_1b=_19.getContext("2d");realitybuilder.util.clearCanvas(_19);_1a.globalCompositeOperation="source-over";if(_16===-1){realitybuilder.util.fillCanvas(_18,"black");}else{this._renderTops(_16,_1a);}_1b.globalCompositeOperation="source-over";_1b.drawImage(_18,0,0);_1b.globalCompositeOperation="xor";this._renderFull(_16,_1b,_17);this._renderFull(_16,_1a,_17);_1a.globalCompositeOperation="destination-out";_1a.drawImage(_19,0,0);}}});}