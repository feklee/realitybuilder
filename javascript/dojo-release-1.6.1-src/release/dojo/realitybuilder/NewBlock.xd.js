/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realityBuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","realityBuilder.NewBlock"],["require","realityBuilder.Block"],["require","realityBuilder.Shadow"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["realityBuilder.NewBlock"]){_4._hasResource["realityBuilder.NewBlock"]=true;_4.provide("realityBuilder.NewBlock");_4.require("realityBuilder.Block");_4.require("realityBuilder.Shadow");_4.declare("realityBuilder.NewBlock",realityBuilder.Block,{"-chains-":{constructor:"manual"},_versionOnServer:"-1",_moveSpace1B:null,_moveSpace2B:null,_buildSpace1B:null,_buildSpace2B:null,_color:null,_colorWhenFrozen:null,_shadowColor:null,_shadowAlpha:null,_isFrozen:null,_constructionBlocks:null,_shadow:null,_camera:null,_lastPositionB:null,_wasFrozenWhenLastRendered:null,_lastConstructionBlocksVersion:null,_prerenderMode:null,constructor:function(_7,_8,_9,_a){this.inherited(arguments,[_7,_8,[0,0,0],0]);this._isFrozen=false;this._constructionBlocks=_9;this._shadow=new realityBuilder.Shadow(this,_7,_8,_9);this._camera=_8;this._prerenderMode=_a;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},updateWithServerData:function(_b){var _c;if(this._versionOnServer!==_b.version){if(!this.isInitializedWithServerData()){this._positionB=_b.initPositionB;this._a=_b.initA;_c=true;}else{_c=false;}this._moveSpace1B=_b.moveSpace1B;this._moveSpace2B=_b.moveSpace2B;this._buildSpace1B=_b.buildSpace1B;this._buildSpace2B=_b.buildSpace2B;this._color=_b.color;this._colorWhenFrozen=_b.colorWhenFrozen;this._shadowColor=_b.shadowColor;this._shadowAlpha=_b.shadowAlpha;this._versionOnServer=_b.version;if(_c){_4.publish("realityBuilder/NewBlock/"+"positionAngleInitialized");}_4.publish("realityBuilder/NewBlock/moveOrBuildSpaceChanged");}},_collidesWithRealBlock:function(){return this._constructionBlocks.realBlocksCollideWith(this);},move:function(_d){if(!this._wouldGoOutOfRange(_d,0)){this._positionB=realityBuilder.util.addVectorsB(this._positionB,_d);_4.publish("realityBuilder/NewBlock/movedOrRotated");}},rotate90:function(){if(!this._wouldGoOutOfRange([0,0,0],1)){this._a=(this._a+1)%4;_4.publish("realityBuilder/NewBlock/movedOrRotated");}},requestMakeReal:function(){if(this.canBeMadeReal()){this._freeze();this._createPendingOnServer();_4.publish("realityBuilder/NewBlock/makeRealRequested");}},isFrozen:function(){return this._isFrozen;},_freeze:function(){this._isFrozen=true;_4.publish("realityBuilder/NewBlock/frozen");},_unfreeze:function(){this._isFrozen=false;_4.publish("realityBuilder/NewBlock/unfrozen");},_unfreezeIfMadeRealOrDeleted:function(){var _e,_f,_10;if(this.isFrozen()){_10=this._constructionBlocks.blockAt(this.positionB());if(_10){if(_10.isDeleted()||_10.isReal()){this._unfreeze();}}}},_moveOutOfTheWay:function(){var _11,cbs=this._constructionBlocks,xB=this.xB(),yB=this.yB(),_12;if(this._collidesWithRealBlock()){_12=this.zB();do{_12+=1;_11=new realityBuilder.Block(this._blockProperties,this._camera,[xB,yB,_12],this.a());}while(cbs.realBlocksCollideWith(_11));this._positionB[2]=_12;}},updateState:function(){this._unfreezeIfMadeRealOrDeleted();this._moveOutOfTheWay();},_wouldGoOutOfRange:function(_13,_14){var _15,_16,_17;_15=realityBuilder.util.addVectorsB(this.positionB(),_13);_17=(this.a()+_14)%4;_16=new realityBuilder.Block(this._blockProperties,this._camera,_15,_17);return (this._constructionBlocks.realBlocksCollideWith(_16)||!this._wouldBeInMoveSpace(_15));},canBeRotated90:function(){return !this._wouldGoOutOfRange([0,0,0],1)&&!this._isFrozen;},canBeMoved:function(_18){return !this._wouldGoOutOfRange(_18,0)&&!this._isFrozen;},_wouldBeInMoveSpace:function(_19){var m1B=this._moveSpace1B,m2B=this._moveSpace2B;return (_19[0]>=m1B[0]&&_19[0]<=m2B[0]&&_19[1]>=m1B[1]&&_19[1]<=m2B[1]&&_19[2]>=0&&_19[2]<=m2B[2]);},_isInBuildSpace:function(){var xB=this._positionB[0],yB=this._positionB[1],zB=this._positionB[2],b1B=this._buildSpace1B,b2B=this._buildSpace2B;return (xB>=b1B[0]&&xB<=b2B[0]&&yB>=b1B[1]&&yB<=b2B[1]&&zB>=b1B[2]&&zB<=b2B[2]);},_isAttachable:function(){return (this._constructionBlocks.realBlocksAreAttachableTo(this)||this.zB()===0);},_isInPrerenderedBlockConfiguration:function(){var _1a=this._constructionBlocks.realBlocksSorted();return this._prerenderMode.matchingBlockConfigurationI(_1a,this)!==false;},canBeMadeReal:function(){return this._isInBuildSpace()&&this._isAttachable()&&(!this._prerenderMode.isEnabled()||this._isInPrerenderedBlockConfiguration())&&!this._isFrozen;},_boundingBoxesOverlap:function(_1b){var l,r,b,t,_1c,_1d,_1e,_1f,_20,_21;this._updateCoordinates();l=this._boundingBoxS[0][0];r=this._boundingBoxS[1][0];b=this._boundingBoxS[0][1];t=this._boundingBoxS[1][1];_1b._updateCoordinates();_1c=_1b._boundingBoxS[0][0];_1d=_1b._boundingBoxS[1][0];_1e=_1b._boundingBoxS[0][1];_1f=_1b._boundingBoxS[1][1];_20=(r>=_1c&&l<=_1d);_21=(t>=_1e&&b<=_1f);return _20&&_21;},_relationVertexesEdges:function(_22,_23){var _24,len,i,j,_25,_26,_27,_28;_24=realityBuilder.util;len=_23.length;for(i=0;i<len;i+=1){_28=[_23[i],_23[(i+1)%len]];for(j=0;j<len;j+=1){_27=_22[j];_25=_24.relationPointSegmentVXZ(_27,_28);if(_25<0||_25>0){return _25;}}}return 0;},_isObscuredBySLO:function(_29){var _2a,_2b,_2c;_2b=this.projectedVertexesVXZ();_2c=_29.projectedVertexesVXZ();if(_2b===false||_2c===false){return false;}_2a=this._relationVertexesEdges(_2c,_2b);if(_2a===0){_2a=this._relationVertexesEdges(_2b,_2c);_2a=-_2a;}if(_2a<0){return true;}else{if(_2a>0){return false;}else{return false;}}},_subtractRealBlock:function(_2d,_2e){if(this._boundingBoxesOverlap(_2d)){_2d.subtract(_2e);}},_subtractRealBlocks:function(_2f){var _30=this._constructionBlocks.realBlocksSorted(),i,_31,zB=this.zB();for(i=0;i<_30.length;i+=1){_31=_30[i];if(_31.zB()<zB){break;}else{if(_31.zB()===zB){if(this._isObscuredBySLO(_31)){this._subtractRealBlock(_31,_2f);}}else{if(_31.zB()>zB){this._subtractRealBlock(_31,_2f);}}}}},_renderShadow:function(){if(this.isFrozen()){this._shadow.clear();}else{this._shadow.render(this._shadowColor,this._shadowAlpha);}},_needsToBeRendered:function(){var _32,_33,_34;_32=this._coordinatesChangedAfterLastRendering;_33=(this._lastConstructionBlocksVersion!==this._constructionBlocks.versionOnServer());_34=(this._wasFrozenWhenLastRendered!==this._isFrozen);return _32||_33||_34;},_onRendered:function(){this._coordinatesChangedAfterLastRendering=false;this._wasFrozenWhenLastRendered=this._isFrozen;this._lastConstructionBlocksVersion=this._constructionBlocks.versionOnServer();},render:function(){var _35,_36,_37;this._updateCoordinates();if(this._needsToBeRendered()){_35=this._camera.sensor().newBlockCanvas();if(_35.getContext){_36=_35.getContext("2d");_37=this.isFrozen()?this._colorWhenFrozen:this._color;if(!realityBuilder.util.isFlashCanvasActive()){this._renderShadow();}realityBuilder.util.clearCanvas(_35);this.inherited(arguments,[_36,_37]);this._subtractRealBlocks(_36);}this._onRendered();}},_createPendingOnServerSucceeded:function(){_4.publish("realityBuilder/NewBlock/createdPendingOnServer");if(this._prerenderMode.isEnabled()){setTimeout(_4.hitch(this,this._makeRealIfInPrerenderedBlockConfiguration),this._prerenderMode.makeRealAfter());}},_createPendingOnServer:function(){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"rpc/create_pending",content:{"xB":this.xB(),"yB":this.yB(),"zB":this.zB(),"a":this.a()},load:_4.hitch(this,this._createPendingOnServerSucceeded)});},_makeRealIfInPrerenderedBlockConfiguration:function(){var i,_38;_38=this._constructionBlocks.realBlocksSorted();i=this._prerenderMode.matchingBlockConfigurationI(_38,this);if(i!==false){this._prerenderMode.loadBlockConfigurationOnServer(i);}else{this._unfreeze();}}});}}};});