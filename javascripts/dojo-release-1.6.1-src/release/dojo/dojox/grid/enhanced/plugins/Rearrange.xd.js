/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realityBuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.grid.enhanced.plugins.Rearrange"],["require","dojox.grid.enhanced._Plugin"],["require","dojox.grid.enhanced.plugins._RowMapLayer"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.grid.enhanced.plugins.Rearrange"]){_4._hasResource["dojox.grid.enhanced.plugins.Rearrange"]=true;_4.provide("dojox.grid.enhanced.plugins.Rearrange");_4.require("dojox.grid.enhanced._Plugin");_4.require("dojox.grid.enhanced.plugins._RowMapLayer");_4.declare("dojox.grid.enhanced.plugins.Rearrange",_6.grid.enhanced._Plugin,{name:"rearrange",constructor:function(_7,_8){this.grid=_7;this.setArgs(_8);var _9=new _6.grid.enhanced.plugins._RowMapLayer(_7);_6.grid.enhanced.plugins.wrap(_7,"_storeLayerFetch",_9);},setArgs:function(_a){this.args=_4.mixin(this.args||{},_a||{});this.args.setIdentifierForNewItem=this.args.setIdentifierForNewItem||function(v){return v;};},destroy:function(){this.inherited(arguments);this.grid.unwrap("rowmap");},onSetStore:function(_b){this.grid.layer("rowmap").clearMapping();},_hasIdentity:function(_c){var g=this.grid,s=g.store,_d=g.layout.cells;if(s.getFeatures()["dojo.data.api.Identity"]){if(_4.some(_c,function(_e){return s.getIdentityAttributes(g._by_idx[_e.r].item)==_d[_e.c].field;})){return true;}}return false;},moveColumns:function(_f,_10){var g=this.grid,_11=g.layout,_12=_11.cells,_13,i,_14=0,_15=true,tmp={},_16={};_f.sort(function(a,b){return a-b;});for(i=0;i<_f.length;++i){tmp[_f[i]]=i;if(_f[i]<_10){++_14;}}var _17=0;var _18=0;var _19=Math.max(_f[_f.length-1],_10);if(_19==_12.length){--_19;}for(i=_f[0];i<=_19;++i){var j=tmp[i];if(j>=0){if(i!=_10-_14+j){_16[i]=_10-_14+j;}_17=j+1;_18=_f.length-j-1;}else{if(i<_10&&_17>0){_16[i]=i-_17;}else{if(i>=_10&&_18>0){_16[i]=i+_18;}}}}_14=0;if(_10==_12.length){--_10;_15=false;}g._notRefreshSelection=true;for(i=0;i<_f.length;++i){_13=_f[i];if(_13<_10){_13-=_14;}++_14;if(_13!=_10){_11.moveColumn(_12[_13].view.idx,_12[_10].view.idx,_13,_10,_15);_12=_11.cells;}if(_10<=_13){++_10;}}delete g._notRefreshSelection;_4.publish("dojox/grid/rearrange/move/"+g.id,["col",_16,_f]);},moveRows:function(_1a,_1b){var g=this.grid,_1c={},_1d=[],_1e=[],len=_1a.length,i,r,k,arr,_1f,_20;for(i=0;i<len;++i){r=_1a[i];if(r>=_1b){break;}_1d.push(r);}_1e=_1a.slice(i);arr=_1d;len=arr.length;if(len){_1f={};_4.forEach(arr,function(r){_1f[r]=true;});_1c[arr[0]]=_1b-len;for(k=0,i=arr[k]+1,_20=i-1;i<_1b;++i){if(!_1f[i]){_1c[i]=_20;++_20;}else{++k;_1c[i]=_1b-len+k;}}}arr=_1e;len=arr.length;if(len){_1f={};_4.forEach(arr,function(r){_1f[r]=true;});_1c[arr[len-1]]=_1b+len-1;for(k=len-1,i=arr[k]-1,_20=i+1;i>=_1b;--i){if(!_1f[i]){_1c[i]=_20;--_20;}else{--k;_1c[i]=_1b+k;}}}var _21=_4.clone(_1c);g.layer("rowmap").setMapping(_1c);g.forEachLayer(function(_22){if(_22.name()!="rowmap"){_22.invalidate();return true;}else{return false;}},false);g.selection.selected=[];g._noInternalMapping=true;g._refresh();setTimeout(function(){_4.publish("dojox/grid/rearrange/move/"+g.id,["row",_21,_1a]);g._noInternalMapping=false;},0);},moveCells:function(_23,_24){var g=this.grid,s=g.store;if(s.getFeatures()["dojo.data.api.Write"]){if(_23.min.row==_24.min.row&&_23.min.col==_24.min.col){return;}var _25=g.layout.cells,cnt=_23.max.row-_23.min.row+1,r,c,tr,tc,_26=[],_27=[];for(r=_23.min.row,tr=_24.min.row;r<=_23.max.row;++r,++tr){for(c=_23.min.col,tc=_24.min.col;c<=_23.max.col;++c,++tc){while(_25[c]&&_25[c].hidden){++c;}while(_25[tc]&&_25[tc].hidden){++tc;}_26.push({"r":r,"c":c});_27.push({"r":tr,"c":tc,"v":_25[c].get(r,g._by_idx[r].item)});}}if(this._hasIdentity(_26.concat(_27))){console.warn("Can not write to identity!");return;}_4.forEach(_26,function(_28){s.setValue(g._by_idx[_28.r].item,_25[_28.c].field,"");});_4.forEach(_27,function(_29){s.setValue(g._by_idx[_29.r].item,_25[_29.c].field,_29.v);});s.save({onComplete:function(){_4.publish("dojox/grid/rearrange/move/"+g.id,["cell",{"from":_23,"to":_24}]);}});}},copyCells:function(_2a,_2b){var g=this.grid,s=g.store;if(s.getFeatures()["dojo.data.api.Write"]){if(_2a.min.row==_2b.min.row&&_2a.min.col==_2b.min.col){return;}var _2c=g.layout.cells,cnt=_2a.max.row-_2a.min.row+1,r,c,tr,tc,_2d=[];for(r=_2a.min.row,tr=_2b.min.row;r<=_2a.max.row;++r,++tr){for(c=_2a.min.col,tc=_2b.min.col;c<=_2a.max.col;++c,++tc){while(_2c[c]&&_2c[c].hidden){++c;}while(_2c[tc]&&_2c[tc].hidden){++tc;}_2d.push({"r":tr,"c":tc,"v":_2c[c].get(r,g._by_idx[r].item)});}}if(this._hasIdentity(_2d)){console.warn("Can not write to identity!");return;}_4.forEach(_2d,function(_2e){s.setValue(g._by_idx[_2e.r].item,_2c[_2e.c].field,_2e.v);});s.save({onComplete:function(){setTimeout(function(){_4.publish("dojox/grid/rearrange/copy/"+g.id,["cell",{"from":_2a,"to":_2b}]);},0);}});}},changeCells:function(_2f,_30,_31){var g=this.grid,s=g.store;if(s.getFeatures()["dojo.data.api.Write"]){var _32=_2f,_33=g.layout.cells,_34=_32.layout.cells,cnt=_30.max.row-_30.min.row+1,r,c,tr,tc,_35=[];for(r=_30.min.row,tr=_31.min.row;r<=_30.max.row;++r,++tr){for(c=_30.min.col,tc=_31.min.col;c<=_30.max.col;++c,++tc){while(_34[c]&&_34[c].hidden){++c;}while(_33[tc]&&_33[tc].hidden){++tc;}_35.push({"r":tr,"c":tc,"v":_34[c].get(r,_32._by_idx[r].item)});}}if(this._hasIdentity(_35)){console.warn("Can not write to identity!");return;}_4.forEach(_35,function(_36){s.setValue(g._by_idx[_36.r].item,_33[_36.c].field,_36.v);});s.save({onComplete:function(){_4.publish("dojox/grid/rearrange/change/"+g.id,["cell",_31]);}});}},clearCells:function(_37){var g=this.grid,s=g.store;if(s.getFeatures()["dojo.data.api.Write"]){var _38=g.layout.cells,cnt=_37.max.row-_37.min.row+1,r,c,_39=[];for(r=_37.min.row;r<=_37.max.row;++r){for(c=_37.min.col;c<=_37.max.col;++c){while(_38[c]&&_38[c].hidden){++c;}_39.push({"r":r,"c":c});}}if(this._hasIdentity(_39)){console.warn("Can not write to identity!");return;}_4.forEach(_39,function(_3a){s.setValue(g._by_idx[_3a.r].item,_38[_3a.c].field,"");});s.save({onComplete:function(){_4.publish("dojox/grid/rearrange/change/"+g.id,["cell",_37]);}});}},insertRows:function(_3b,_3c,_3d){try{var g=this.grid,s=g.store,_3e=g.rowCount,_3f={},obj={idx:0},_40=[],i,_41=this;var len=_3c.length;for(i=_3d;i<g.rowCount;++i){_3f[i]=i+len;}if(s.getFeatures()["dojo.data.api.Write"]){if(_3b){var _42=_3b,_43=_42.store,_44;for(i=0;!_44;++i){_44=g._by_idx[i];}var _45=s.getAttributes(_44.item);var _46=[];_4.forEach(_3c,function(_47,i){var _48={};var _49=_42._by_idx[_47];if(_49){_4.forEach(_45,function(_4a){_48[_4a]=_43.getValue(_49.item,_4a);});_48=_41.args.setIdentifierForNewItem(_48,s,_3e+obj.idx)||_48;try{s.newItem(_48);_40.push(_3d+i);_3f[_3e+obj.idx]=_3d+i;++obj.idx;}catch(e){console.log("insertRows newItem:",e,_48);}}else{_46.push(_47);}});}else{if(_3c.length&&_4.isObject(_3c[0])){_4.forEach(_3c,function(_4b,i){var _4c=_41.args.setIdentifierForNewItem(_4b,s,_3e+obj.idx)||_4b;try{s.newItem(_4c);_40.push(_3d+i);_3f[_3e+obj.idx]=_3d+i;++obj.idx;}catch(e){console.log("insertRows newItem:",e,_4c);}});}else{return;}}g.layer("rowmap").setMapping(_3f);s.save({onComplete:function(){g._refresh();setTimeout(function(){_4.publish("dojox/grid/rearrange/insert/"+g.id,["row",_40]);},0);}});}}catch(e){console.log("insertRows:",e);}},removeRows:function(_4d){var g=this.grid;var s=g.store;try{_4.forEach(_4.map(_4d,function(_4e){return g._by_idx[_4e];}),function(row){if(row){s.deleteItem(row.item);}});s.save({onComplete:function(){_4.publish("dojox/grid/rearrange/remove/"+g.id,["row",_4d]);}});}catch(e){console.log("removeRows:",e);}},_getPageInfo:function(){var _4f=this.grid.scroller,_50=_4f.page,_51=_4f.page,_52=_4f.firstVisibleRow,_53=_4f.lastVisibleRow,_54=_4f.rowsPerPage,_55=_4f.pageNodes[0],_56,_57,_58,_59=[];_4.forEach(_55,function(_5a,_5b){if(!_5a){return;}_58=false;_56=_5b*_54;_57=(_5b+1)*_54-1;if(_52>=_56&&_52<=_57){_50=_5b;_58=true;}if(_53>=_56&&_53<=_57){_51=_5b;_58=true;}if(!_58&&(_56>_53||_57<_52)){_59.push(_5b);}});return {topPage:_50,bottomPage:_51,invalidPages:_59};}});_6.grid.EnhancedGrid.registerPlugin(_6.grid.enhanced.plugins.Rearrange);}}};});