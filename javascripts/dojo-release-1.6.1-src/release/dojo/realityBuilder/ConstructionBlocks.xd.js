/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realityBuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","realityBuilder.ConstructionBlocks"],["require","realityBuilder.ConstructionBlock"],["require","realityBuilder.util"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["realityBuilder.ConstructionBlocks"]){_4._hasResource["realityBuilder.ConstructionBlocks"]=true;_4.provide("realityBuilder.ConstructionBlocks");_4.require("realityBuilder.ConstructionBlock");_4.require("realityBuilder.util");_4.declare("realityBuilder.ConstructionBlocks",null,{_versionOnServer:"-1",_camera:null,_blockProperties:null,_blocks:null,_realBlocksSorted:null,_pendingBlocks:null,constructor:function(_7,_8){this._blockProperties=_7;this._blocks=[];this._realBlocksSorted=[];this._camera=_8;},blocks:function(){return this._blocks;},pendingBlocks:function(){return this._pendingBlocks;},realBlocksSorted:function(){return this._realBlocksSorted;},highestRealBlocksZB:function(){if(this._realBlocksSorted.length>0){return this._realBlocksSorted[0].zB();}else{return -1;}},realBlocksInLayer:function(zB){var _9=[],i,_a=this._realBlocksSorted,_b;for(i=0;i<_a.length;i+=1){_b=_a[i];if(_b.zB()===zB){_9.push(_b);}else{if(_b.zB()<zB){break;}}}return _9;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},_createBlockFromServerData:function(_c){var _d=this._camera,rb=realityBuilder;return new rb.ConstructionBlock(this._blockProperties,_d,_c.posB,_c.a,_c.state,_c.timeStamp);},updateWithServerData:function(_e){if(this._versionOnServer!==_e.version){this._versionOnServer=_e.version;this._blocks=_4.map(_e.blocks,_4.hitch(this,this._createBlockFromServerData));this._updateRealBlocksSorted();this._updatePendingBlocks();_4.publish("realityBuilder/ConstructionBlocks/changed");}},_sortByHeight:function(_f,_10){if(_f.zB()>_10.zB()){return -1;}else{if(_f.zB()<_10.zB()){return 1;}else{return 0;}}},_updateRealBlocksSorted:function(){var tmp=_4.filter(this._blocks,function(_11){return _11.isReal();});tmp.sort(this._sortByHeight);this._realBlocksSorted=tmp;},_updatePendingBlocks:function(){this._pendingBlocks=_4.filter(this._blocks,function(_12){return _12.isPending();});},blockAt:function(_13,a){var _14=this.blocks(),_15,i;for(i=0;i<_14.length;i+=1){_15=_14[i];if(realityBuilder.util.pointsIdenticalB(_13,_15.posB())&&a===_15.a()){return _15;}}return false;},realBlocksCollideWith:function(_16){var _17=this.realBlocksSorted(),_18,i;for(i=0;i<_17.length;i+=1){_18=_17[i];if(_18.collidesWith(_16)){return true;}}return false;},realBlocksAreAttachableTo:function(_19){var _1a=this.realBlocksSorted(),_1b,i;for(i=0;i<_1a.length;i+=1){_1b=_1a[i];if(_1b.attachableTo(_19)){return true;}}return false;},_makePendingOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},_makePendingOnServerFailed:function(){_4.publish("realityBuilder/ConstructionBlocks/"+"changeOnServerFailed");},makePendingOnServer:function(_1c,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/make_pending",content:{"xB":_1c[0],"yB":_1c[1],"zB":_1c[2],"a":a},load:_4.hitch(this,this._makePendingOnServerSucceeded)});},_deleteOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},deleteOnServer:function(_1d,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/delete",content:{"xB":_1d[0],"yB":_1d[1],"zB":_1d[2],"a":a},load:_4.hitch(this,this._deleteOnServerSucceeded)});},_makeRealOnServerSucceeded:function(){_4.publish("realityBuilder/ConstructionBlocks/changedOnServer");},_makeRealOnServerFailed:function(){_4.publish("realityBuilder/ConstructionBlocks/"+"changeOnServerFailed");},makeRealOnServer:function(_1e,a){realityBuilder.util.jsonpGet({url:realityBuilder.util.rootUrl()+"admin/rpc/make_real",content:{"xB":_1e[0],"yB":_1e[1],"zB":_1e[2],"a":a},load:_4.hitch(this,this._makeRealOnServerSucceeded)});},setBlockStateOnServer:function(_1f,a,_20){switch(_20){case 0:this.deleteOnServer(_1f,a);break;case 1:this.makePendingOnServer(_1f,a);break;case 2:this.makeRealOnServer(_1f,a);break;}},zBOfUpperSideOfRealBlockBelow:function(xB,yB,zB){var _21,_22,_23,bXB,bYB,bZB;_21=this._realBlocksSorted;_22=zB-1;_23=0;_4.forEach(_21,function(b){bXB=b.xB();bYB=b.yB();bZB=b.zB();if(bZB+1<=_22&&xB>=bXB&&xB<=bXB+1&&yB>=bYB&&yB<=bYB+1&&bZB+1>_23){_23=bZB+1;}});return _23;},_renderBlocks:function(_24,_25){if(_24.getContext){var _26=_24.getContext("2d");realityBuilder.util.clearCanvas(_24);_4.forEach(_25,function(b){b.render(_26);});}},renderIfVisible:function(){var _27=this._camera.sensor();if(_27.realBlocksAreVisible()){this._renderBlocks(_27.realBlocksCanvas(),this._realBlocksSorted);}if(_27.pendingBlocksAreVisible()){this._renderBlocks(_27.pendingBlocksCanvas(),this._pendingBlocks);}}});}}};});