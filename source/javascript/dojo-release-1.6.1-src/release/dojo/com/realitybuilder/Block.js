/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["com.realitybuilder.Block"]){dojo._hasResource["com.realitybuilder.Block"]=true;dojo.provide("com.realitybuilder.Block");dojo.declare("com.realitybuilder.Block",null,{_positionB:null,_camera:null,_blockProperties:null,_bottomVertexes:null,_bottomVertexesV:null,_bottomVertexesS:null,_topVertexes:null,_topVertexesV:null,_topVertexesS:null,_projectedVertexesVXZ:null,_projectedVertexesVXZS:null,_boundingBoxS:null,_lastCameraId:null,_lastBlockPropertiesVersionOnServer:null,_coordinatesChangedAfterLastRendering:false,_indexOfLeftmostVertex:null,_indexOfRightmostVertex:null,_onlySubtractBottom:false,constructor:function(_1,_2,_3){this._positionB=_3;this._blockProperties=_1;this._camera=_2;this._edges=this._INITIAL_EDGES;},positionB:function(){return this._positionB;},xB:function(){return this._positionB[0];},yB:function(){return this._positionB[1];},zB:function(){return this._positionB[2];},_vertexesS:function(){return this._bottomVertexesS.concat(this._topVertexesS);},projectedVertexesVXZ:function(){this._updateCoordinates();return (this._projectedVertexesVXZ===null)?false:this._projectedVertexesVXZ;},_updateViewSpaceXZPlaneCoordinates:function(){var i,_4,_5,_6,_7=[],_8,_9;_4=this._bottomVertexesV;_5=this._topVertexesV;_6=_4.length;for(i=0;i<_6;i+=1){_8=[_4[i],_5[i]];_9=com.realitybuilder.util.intersectionLinePlaneVXZ(_8);if(!_9){_7=null;break;}else{_7.push(_9);}}this._projectedVertexesVXZ=_7;},collidesWith:function(_a){var _b,_c=this._blockProperties.collisionOffsetsB(),_d,i;for(i=0;i<_c.length;i+=1){_d=_c[i];_b=[this.xB()+_d[0],this.yB()+_d[1],this.zB()];if(com.realitybuilder.util.pointsIdenticalB(_a.positionB(),_b)){return true;}}return false;},attachableTo:function(_e){var _f,_10=this._blockProperties.attachmentOffsetsB(),_11,i;for(i=0;i<_10.length;i+=1){_11=_10[i];_f=com.realitybuilder.util.addVectorsB(this.positionB(),_11);if(com.realitybuilder.util.pointsIdenticalB(_e.positionB(),_f)){return true;}}return false;},_updateWorldSpaceCoordinates:function(){var xB=this.positionB()[0],yB=this.positionB()[1],zB=this.positionB()[2],_12=[],_13=[],_14=this._blockProperties.outlineB(),_15=this;dojo.forEach(_14,function(_16){_12.push(com.realitybuilder.util.blockToWorld([xB+_16[0],yB+_16[1],zB],_15._blockProperties));_13.push(com.realitybuilder.util.blockToWorld([xB+_16[0],yB+_16[1],zB+1],_15._blockProperties));});this._bottomVertexes=_12;this._topVertexes=_13;},_updateViewSpaceCoordinates:function(){this._bottomVertexesV=dojo.map(this._bottomVertexes,dojo.hitch(this._camera,this._camera.worldToView));this._topVertexesV=dojo.map(this._topVertexes,dojo.hitch(this._camera,this._camera.worldToView));},_coordinatesNeedToBeUpdated:function(){var _17,_18;_17=this._lastCameraIdS!==this._camera.id();_18=this._lastBlockPropertiesVersionOnServer!==this._blockProperties.versionOnServer();return _17||_18;},_onCoordinatesUpdated:function(){this._lastBlockPropertiesVersionOnServer=this._blockProperties.versionOnServer();this._lastCameraId=this._camera.id();this._coordinatesChangedAfterLastRendering=true;},_updateHorizontalExtentsInSensorSpace:function(){var _19,_1a,_1b,_1c,i,ilv,irv;_19=this._projectedVertexesVXZS;_1b=_1c=_19[0];ilv=irv=0;for(i=1;i<_19.length;i+=1){_1a=_19[i];if(_1a[0]<_1b[0]){_1b=_1a;ilv=i;}if(_1a[0]>_1c[0]){_1c=_1a;irv=i;}}this._indexOfLeftmostVertex=ilv;this._indexOfRightmostVertex=irv;},_updateProjectedVertexesVXZS:function(){var cam=this._camera;this._projectedVertexesVXZS=dojo.map(this._projectedVertexesVXZ,function(_1d){var _1e=[_1d[0],0,_1d[1]];return cam.viewToSensor(_1e);});},_updateSensorSpaceBoundingBox:function(){var _1f=Number.MAX_VALUE,_20=Number.MAX_VALUE,_21=Number.MIN_VALUE,_22=Number.MIN_VALUE;dojo.forEach(this._vertexesS(),function(_23){if(_23[0]<_1f){_1f=_23[0];}else{if(_23[0]>_21){_21=_23[0];}}if(_23[1]<_20){_20=_23[1];}else{if(_23[1]>_22){_22=_23[1];}}});this._boundingBoxS=[[_1f,_20],[_21,_22]];},_updateSensorSpaceCoordinates:function(){var cam=this._camera;this._bottomVertexesS=dojo.map(this._bottomVertexesV,dojo.hitch(cam,cam.viewToSensor));this._topVertexesS=dojo.map(this._topVertexesV,dojo.hitch(cam,cam.viewToSensor));this._updateProjectedVertexesVXZS();this._updateHorizontalExtentsInSensorSpace();this._updateSensorSpaceBoundingBox();},_updateCoordinates:function(){if(this._coordinatesNeedToBeUpdated()){this._updateWorldSpaceCoordinates();this._updateViewSpaceCoordinates();this._updateViewSpaceXZPlaneCoordinates();this._updateSensorSpaceCoordinates();this._onCoordinatesUpdated();}},onlySubtractBottom:function(){this._onlySubtractBottom=true;},_subtractDrawBottomPath:function(_24){var _25,len,_26,i;_25=this._bottomVertexesS;_26=_25[0];_24.moveTo(_26[0],_26[1]);for(i=1;i<_25.length;i+=1){_26=_25[i];_24.lineTo(_26[0],_26[1]);}},_subtractDrawPath:function(_27){var _28,_29,len,_2a,i,ilv,irv;_28=this._bottomVertexesS;_29=this._topVertexesS;len=_29.length;ilv=this._indexOfLeftmostVertex;irv=this._indexOfRightmostVertex;_2a=_29[irv];_27.moveTo(_2a[0],_2a[1]);for(i=irv+1;i<=len+ilv;i+=1){_2a=_29[i%len];_27.lineTo(_2a[0],_2a[1]);}_2a=_28[ilv];_27.lineTo(_2a[0],_2a[1]);for(i=ilv+1;i<=len+irv;i+=1){_2a=_28[i%len];_27.lineTo(_2a[0],_2a[1]);}_2a=_28[irv];_27.lineTo(_2a[0],_2a[1]);},subtract:function(_2b){var _2c,_2d,len,_2e,i,ilv,irv;this._updateCoordinates();_2b.globalCompositeOperation="destination-out";_2b.fillStyle="black";_2b.beginPath();if(this._onlySubtractBottom){this._subtractDrawBottomPath(_2b);}else{this._subtractDrawPath(_2b);}_2b.closePath();_2b.fill();_2b.globalCompositeOperation="source-over";},_renderForeground:function(_2f){var _30=this._topVertexesS,_31=this._bottomVertexesS,len=_30.length,_32,_33,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex;_2f.globalAlpha=1;_2f.beginPath();_33=_31[ilv];_2f.moveTo(_33[0],_33[1]);for(i=ilv+1;i<=irv;i+=1){_32=_31[i];_2f.lineTo(_32[0],_32[1]);}_2f.stroke();_2f.beginPath();_33=_30[0];_2f.moveTo(_33[0],_33[1]);for(i=1;i<=_30.length;i+=1){_32=_30[i%len];_2f.lineTo(_32[0],_32[1]);}_2f.lineTo(_33[0],_33[1]);_2f.stroke();for(i=ilv;i<=irv;i+=1){_2f.beginPath();_32=_31[i%len];_2f.moveTo(_32[0],_32[1]);_32=_30[i%len];_2f.lineTo(_32[0],_32[1]);_2f.stroke();}},_renderBackground:function(_34){var _35=this._bottomVertexesS,_36=this._topVertexesS,len=_36.length,_37,i,ilv=this._indexOfLeftmostVertex,irv=this._indexOfRightmostVertex;_34.globalAlpha=0.2;_34.beginPath();_37=_35[irv];_34.moveTo(_37[0],_37[1]);for(i=irv+1;i<=len+ilv;i+=1){_37=_35[i%len];_34.lineTo(_37[0],_37[1]);}_34.stroke();for(i=irv+1;i<=len+ilv-1;i+=1){_34.beginPath();_37=_35[i%len];_34.moveTo(_37[0],_37[1]);_37=_36[i%len];_34.lineTo(_37[0],_37[1]);_34.stroke();}_34.globalAlpha=1;},render:function(_38,_39){this._updateCoordinates();_38.strokeStyle=_39;this._renderForeground(_38);this._renderBackground(_38);}});}