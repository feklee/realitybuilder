/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["com.realitybuilder.Camera"]){dojo._hasResource["com.realitybuilder.Camera"]=true;dojo.provide("com.realitybuilder.Camera");dojo.require("com.realitybuilder.util");dojo.require("com.realitybuilder.Sensor");dojo.require("dojox.math.matrix");dojo.declare("com.realitybuilder.Camera",null,{_blockProperties:null,_position:null,_aX:0,_aY:0,_aZ:0,_fl:1,_sensorResolution:100,_rZ:null,_rX:null,_rZYX:null,_sensor:null,_versionOnServer:"-1",_id:null,constructor:function(_1,_2,_3){this._blockProperties=_1;this._position=[0,0,1];this._sensor=new com.realitybuilder.Sensor(_2,_3);this._updateRotationMatrices();},_updateId:function(){this._id=Math.random().toString();},sensor:function(){return this._sensor;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},position:function(){return this._position;},aX:function(){return this._aX;},aY:function(){return this._aY;},aZ:function(){return this._aZ;},fl:function(){return this._fl;},sensorResolution:function(){return this._sensorResolution;},id:function(){return this._id;},update:function(_4){this._position=_4.position;this._aX=_4.aX;this._aY=_4.aY;this._aZ=_4.aZ;this._fl=_4.fl;this._sensorResolution=_4.sensorResolution;this._updateRotationMatrices();this._updateId();dojo.publish("com/realitybuilder/Camera/changed");},updateWithServerData:function(_5){this._versionOnServer=_5.version;this.update(_5);},_updateRotationMatrices:function(){var _6;this._rX=[[1,0,0],[0,Math.cos(-this._aX),Math.sin(-this._aX)],[0,-Math.sin(-this._aX),Math.cos(-this._aX)]];this._rY=[[Math.cos(-this._aY),0,Math.sin(-this._aY)],[0,1,0],[-Math.sin(-this._aY),0,Math.cos(-this._aY)]];this._rZ=[[Math.cos(-this._aZ),Math.sin(-this._aZ),0],[-Math.sin(-this._aZ),Math.cos(-this._aZ),0],[0,0,1]];_6=dojox.math.matrix.multiply(this._rY,this._rX);this._rZYX=dojox.math.matrix.multiply(this._rZ,_6);},worldToView:function(_7){var _8=com.realitybuilder.util.subtractVectors3D(_7,this._position);_8=dojox.math.matrix.transpose([_8]);_8=dojox.math.matrix.multiply(this._rZYX,_8);_8=dojox.math.matrix.transpose(_8)[0];return _8;},scale:function(zV){return this._sensorResolution*this._fl/zV;},viewToSensor:function(_9){var xV=_9[0],yV=_9[1],zV=_9[2],_a;_a=this.scale(zV);xV*=_a;yV*=_a;xV+=this._sensor.width()/2;yV+=this._sensor.height()/2;return [xV,yV];},blockToSensor:function(_b){return this.viewToSensor(this.worldToView(com.realitybuilder.util.blockToWorld(_b,this._blockProperties)));}});}