/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["com.realitybuilder.Construction"]){dojo._hasResource["com.realitybuilder.Construction"]=true;dojo.provide("com.realitybuilder.Construction");dojo.require("com.realitybuilder.BlockProperties");dojo.require("com.realitybuilder.ConstructionBlocks");dojo.require("com.realitybuilder.ConstructionBlock");dojo.require("com.realitybuilder.NewBlock");dojo.require("com.realitybuilder.Image");dojo.require("com.realitybuilder.Camera");dojo.require("com.realitybuilder.UserControls");dojo.require("com.realitybuilder.AdminControls");dojo.require("com.realitybuilder.util");dojo.declare("com.realitybuilder.Construction",null,{_showAdminControls:null,_constructionBlocks:null,_responseToLastRequest:null,_UPDATE_INTERVAL:2000,_CHECK_IF_HAS_LOADED_INTERVAL:500,_showReal:null,_showPending:null,_blockProperties:null,_newBlock:null,_camera:null,_image:null,_userControls:null,_adminControls:null,_updateTimeout:null,constructor:function(_1){this._insertLoadIndicator();this._insertView();this._showAdminControls=_1;this._responseToLastRequest=0;this._showReal=_1;this._showPending=_1;this._blockProperties=new com.realitybuilder.BlockProperties();this._camera=new com.realitybuilder.Camera(this._blockProperties,640,480);this._image=new com.realitybuilder.Image(this._camera);this._constructionBlocks=new com.realitybuilder.ConstructionBlocks(this,this._blockProperties);this._newBlock=new com.realitybuilder.NewBlock(this._blockProperties,this._camera,this._constructionBlocks);this._userControls=new com.realitybuilder.UserControls(this);if(this._showAdminControls){this._adminControls=new com.realitybuilder.AdminControls(this);dojo.subscribe("com/realitybuilder/ConstructionBlocks/changeOnServerFailed",this._adminControls,this._adminControls.updateBlocksTable);}dojo.subscribe("com/realitybuilder/ConstructionBlocks/changedOnServer",this,this._update);dojo.subscribe("com/realitybuilder/NewBlock/positionInitialized",this,this._onNewBlockPositionInitialized);dojo.subscribe("com/realitybuilder/NewBlock/buildSpaceChanged",this,this._onBuildSpaceChanged);dojo.subscribe("com/realitybuilder/NewBlock/stopped",this,this._onNewBlockStopped);dojo.subscribe("com/realitybuilder/NewBlock/madeMovable",this,this._onNewBlockMadeMovable);dojo.subscribe("com/realitybuilder/NewBlock/moved",this,this._onNewBlockMoved);dojo.subscribe("com/realitybuilder/ConstructionBlocks/changed",this,this._onConstructionBlocksChanged);dojo.subscribe("com/realitybuilder/Camera/changed",this,this._onCameraChanged);dojo.subscribe("com/realitybuilder/Image/changed",this,this._onImageChanged);dojo.subscribe("com/realitybuilder/BlockProperties/changed",this,this._onBlockPropertiesChanged);this._setupDemoFunctionality();this._update();this._checkIfHasLoaded();},newBlock:function(){return this._newBlock;},camera:function(){return this._camera;},showPending:function(){return this._showPending;},showReal:function(){return this._showReal;},constructionBlocks:function(){return this._constructionBlocks;},_onNewBlockStopped:function(){this._newBlock.render();this._userControls.updateCoordinateControls(true);},_onNewBlockMadeMovable:function(){this._newBlock.render();this._userControls.updateCoordinateControls(false);},requestReal:function(){if(this._newBlock.isMovable()){this._newBlock.stop();this._constructionBlocks.createPendingOnServer(this._newBlock.positionB());this._responseToLastRequest=1;}this._userControls.updateRequestRealButton();this._userControls.updateStatusMessage(this._responseToLastRequest);},toggleReal:function(){this._showReal=!this._showReal;this._camera.sensor().showRealBlocks(this._showReal);this._adminControls.updateToggleRealButton();},togglePending:function(){this._showPending=!this._showPending;this._camera.sensor().showPendingBlocks(this._showPending);this._adminControls.updateTogglePendingButton();},_onDemoKeyPress:function(_2){if(_2.shiftKey&&_2.keyCode===dojo.keys.F12){this._constructionBlocks.setBlockStateOnServer(this._newBlock.positionB(),2);}},_setupDemoFunctionality:function(){dojo.connect(null,"onkeypress",dojo.hitch(this,this._onDemoKeyPress));},_onNewBlockMoved:function(){this._newBlock.render();this._userControls.updateRequestRealButton();this._userControls.updateStatusMessage(this._responseToLastRequest);this._userControls.updateCoordinateControls();if(this._showAdminControls){this._adminControls.updateCoordinateDisplays();}},_updateNewBlockPositionAndState:function(){var _3=this._newBlock.positionB(),_4,_5;if(this._newBlock.isStopped()){_4=this._constructionBlocks.blockAt(_3);}this._newBlock.updatePositionB();if(this._showAdminControls){this._adminControls.updateCoordinateDisplays();}if(this._newBlock.isStopped()){if(_4&&!_4.isDeleted()){_5=_4.state();if(_5===2){this._responseToLastRequest=2;this._newBlock.makeMovable();}else{this._responseToLastRequest=1;}}else{this._responseToLastRequest=3;this._newBlock.makeMovable();}}},_renderBlocksIfFullyInitialized:function(){if(this._constructionBlocks.isInitializedWithServerData()&&this._newBlock.isInitializedWithServerData()&&this._camera.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()){if(this._showAdminControls){this._constructionBlocks.render();}this._newBlock.render();}},_renderCoordinateControlsIfFullyInitialized:function(){if(this._camera.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()&&this._newBlock.isInitializedWithServerData()){this._userControls.renderCoordinateControls();}},_updateNewBlockStateIfFullyInitialized:function(){if(this._constructionBlocks.isInitializedWithServerData()&&this._newBlock.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()){this._updateNewBlockPositionAndState();this._userControls.updateRequestRealButton();this._userControls.updateCoordinateControls(!this._newBlock.isMovable());}},_updateStatusMessageIfFullyInitialized:function(){if(this._constructionBlocks.isInitializedWithServerData()&&this._newBlock.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()){this._userControls.updateStatusMessage(this._responseToLastRequest);}},_onConstructionBlocksChanged:function(){if(this._showAdminControls){this._adminControls.updateBlocksTable();}this._updateStatusMessageIfFullyInitialized();this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();},_onCameraChanged:function(){if(this._showAdminControls){this._adminControls.updateCameraControls(this._camera);}this._renderCoordinateControlsIfFullyInitialized();this._renderBlocksIfFullyInitialized();},_onNewBlockPositionInitialized:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._updateStatusMessageIfFullyInitialized();this._renderCoordinateControlsIfFullyInitialized();},_onBuildSpaceChanged:function(){this._updateNewBlockStateIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._updateStatusMessageIfFullyInitialized();this._renderCoordinateControlsIfFullyInitialized();},_onBlockPropertiesChanged:function(){this._userControls.renderCoordinateControls();this._renderCoordinateControlsIfFullyInitialized();this._renderBlocksIfFullyInitialized();this._updateNewBlockStateIfFullyInitialized();this._updateStatusMessageIfFullyInitialized();this._renderBlocksIfFullyInitialized();},_onImageChanged:function(){if(this._showAdminControls){this._adminControls.updateImageControls(this._image);}},_insertLoadIndicator:function(){dojo.attr("loadIndicator","innerHTML","Loading...");},_requestRealButtonHtml:function(){var _6,_7;if(dojo.isIE&&dojo.isIE===6){_6="a href=\"javascript:void(0)\"";_7="a";}else{_6=_7="div";}return "<"+_6+" id=\"requestReal\" >Make Real</"+_7+">";},_insertView:function(){dojo.attr("view","innerHTML","<img id=\"live\" src=\"/images/placeholder.gif\" alt=\"Live Image\">"+"<div id=\"sensor\">"+"<canvas id=\"sensorShadowCanvas\" width=\"1\" height=\"1\">"+"</canvas>"+"<canvas id=\"sensorRealBlocksCanvas\" width=\"1\" height=\"1\">"+"</canvas>"+"<canvas id=\"sensorPendingBlocksCanvas\" width=\"1\" height=\"1\">"+"</canvas>"+"<canvas id=\"sensorNewBlockCanvas\" width=\"1\" height=\"1\">"+"</canvas>"+"</div>"+"<div id=\"coordinateControls\">"+"<canvas id=\"coordinateControlsCanvas\" width=\"1\" height=\"1\">"+"</canvas>"+"</div>"+"<p id=\"status\"></p>"+this._requestRealButtonHtml());if(com.realitybuilder.util.isFlashCanvasActive()){FlashCanvas.initElement(dojo.byId("sensorShadowCanvas"));FlashCanvas.initElement(dojo.byId("sensorRealBlocksCanvas"));FlashCanvas.initElement(dojo.byId("sensorPendingBlocksCanvas"));FlashCanvas.initElement(dojo.byId("sensorNewBlockCanvas"));FlashCanvas.initElement(dojo.byId("coordinateControlsCanvas"));}},_checkIfHasLoaded:function(){if(this._constructionBlocks.isInitializedWithServerData()&&this._camera.isInitializedWithServerData()&&this._blockProperties.isInitializedWithServerData()&&this._image.imageLoaded()){dojo.destroy(dojo.byId("loadIndicator"));this._unhideContent();}else{setTimeout(dojo.hitch(this,this._checkIfHasLoaded),this._CHECK_IF_HAS_LOADED_INTERVAL);}},_updateSucceeded:function(_8,_9){var _a=this;if(_8.blocksData.changed){this._constructionBlocks.updateWithServerData(_8.blocksData,this._image);}if(_8.cameraData.changed){this._camera.updateWithServerData(_8.cameraData);}if(_8.imageData.changed){this._image.updateWithServerData(_8.imageData);}if(_8.blockPropertiesData.changed){this._blockProperties.updateWithServerData(_8.blockPropertiesData);}if(_8.newBlockData.changed){this._newBlock.updateWithServerData(_8.newBlockData);}if(this._updateTimeout){clearTimeout(this._updateTimeout);}this._updateTimeout=setTimeout(function(){_a._update();},this._UPDATE_INTERVAL);},_update:function(){var _b;_b=this._showAdminControls?"true":"false";dojo.xhrGet({url:"/rpc/construction",content:{"blocksDataVersion":this._constructionBlocks.versionOnServer(),"getDeletedBlocks":_b,"cameraDataVersion":this._camera.versionOnServer(),"imageDataVersion":this._image.versionOnServer(),"blockPropertiesDataVersion":this._blockProperties.versionOnServer(),"newBlockDataVersion":this._newBlock.versionOnServer()},handleAs:"json",load:dojo.hitch(this,this._updateSucceeded)});},_unhideContent:function(){var _c=dojo.byId("content"),_d=(!dojo.isIE||dojo.isIE>8),_e;if(_d){dojo.style(_c,"opacity","0");}dojo.style(_c,"width","auto");dojo.style(_c,"height","auto");if(dojo.isIE&&dojo.isIE<=7){dojo.style(_c,"zoom","1");}if(_d){_e={node:_c,duration:1000};dojo.fadeIn(_e).play();}},_storeSettingsOnServerSucceeded:function(){this._update();},storeSettingsOnServer:function(){var _f=com.realitybuilder.util.addPrefix("image.",this._adminControls.readImageControls()),_10=com.realitybuilder.util.addPrefix("camera.",this._adminControls.readCameraControls()),_11={};dojo.mixin(_11,_f,_10);dojo.xhrPost({url:"/admin/rpc/update_settings",content:_11,load:dojo.hitch(this,this._storeSettingsOnServerSucceeded)});}});}