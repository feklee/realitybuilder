/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["com.realitybuilder.ConstructionBlocks"]){dojo._hasResource["com.realitybuilder.ConstructionBlocks"]=true;dojo.provide("com.realitybuilder.ConstructionBlocks");dojo.require("com.realitybuilder.ConstructionBlock");dojo.require("com.realitybuilder.util");dojo.declare("com.realitybuilder.ConstructionBlocks",null,{_versionOnServer:"-1",_construction:null,_blockProperties:null,_blocks:null,_realBlocksSorted:null,_pendingBlocks:null,_realBlocksCanvas:null,_pendingBlocksCanvas:null,constructor:function(_1,_2){this._blockProperties=_2;this._blocks=[];this._realBlocksSorted=[];this._construction=_1;var _3=_1.camera().sensor();this._realBlocksCanvas=_3.realBlocksCanvas();this._pendingBlocksCanvas=_3.pendingBlocksCanvas();},blocks:function(){return this._blocks;},pendingBlocks:function(){return this._pendingBlocks;},realBlocksSorted:function(){return this._realBlocksSorted;},realBlocksInLayer:function(zB){var _4=[],i,_5=this._realBlocksSorted,_6;for(i=0;i<_5.length;i+=1){_6=_5[i];if(_6.zB()===zB){_4.push(_6);}else{if(_6.zB()<zB){break;}}}return _4;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},_createBlockFromServerData:function(bd){var _7=this._construction.camera();return new com.realitybuilder.ConstructionBlock(this._blockProperties,_7,[bd.xB,bd.yB,bd.zB],bd.state,bd.timeStamp);},updateWithServerData:function(_8){this._versionOnServer=_8.version;this._blocks=dojo.map(_8.blocks,dojo.hitch(this,this._createBlockFromServerData));this._updateRealBlocksSorted();this._updatePendingBlocks();dojo.publish("com/realitybuilder/ConstructionBlocks/changed");},_sortByHeight:function(_9,_a){if(_9.zB()>_a.zB()){return -1;}else{if(_9.zB()<_a.zB()){return 1;}else{return 0;}}},_updateRealBlocksSorted:function(_b){var _c=dojo.filter(this._blocks,function(_d){return _d.isReal();});_c.sort(this._sortByHeight);this._realBlocksSorted=_c;},_updatePendingBlocks:function(_e){this._pendingBlocks=dojo.filter(this._blocks,function(_f){return _f.isPending();});},blockAt:function(_10){var _11=this.blocks(),_12,i;for(i=0;i<_11.length;i+=1){_12=_11[i];if(com.realitybuilder.util.pointsIdenticalB(_10,_12.positionB())){return _12;}}return false;},realBlocksCollideWith:function(_13){var _14=this.realBlocksSorted(),_15,i;for(i=0;i<_14.length;i+=1){_15=_14[i];if(_15.collidesWith(_13)){return true;}}return false;},realBlocksAreAttachableTo:function(_16){var _17=this.realBlocksSorted(),_18,i;for(i=0;i<_17.length;i+=1){_18=_17[i];if(_18.attachableTo(_16)){return true;}}return false;},_makePendingOnServerSucceeded:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changedOnServer");},_makePendingOnServerFailed:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changeOnServerFailed");},makePendingOnServer:function(_19){dojo.xhrPost({url:"/admin/rpc/make_pending",content:{"xB":_19[0],"yB":_19[1],"zB":_19[2]},load:dojo.hitch(this,this._makePendingOnServerSucceeded),error:dojo.hitch(this,this._makePendingOnServerFailed)});},_createPendingOnServerSucceeded:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changedOnServer");},_createPendingOnServerFailed:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changeOnServerFailed");},createPendingOnServer:function(_1a){dojo.xhrPost({url:"/rpc/create_pending",content:{"xB":_1a[0],"yB":_1a[1],"zB":_1a[2]},load:dojo.hitch(this,this._createPendingOnServerSucceeded),error:dojo.hitch(this,this._createPendingOnServerFailed)});},_deleteOnServerSucceeded:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changedOnServer");},_deleteOnServerFailed:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changeOnServerFailed");},deleteOnServer:function(_1b){dojo.xhrPost({url:"/admin/rpc/delete",content:{"xB":_1b[0],"yB":_1b[1],"zB":_1b[2]},load:dojo.hitch(this,this._deleteOnServerSucceeded),error:dojo.hitch(this,this._deleteOnServerFailed)});},_makeRealOnServerSucceeded:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changedOnServer");},_makeRealOnServerFailed:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changeOnServerFailed");},makeRealOnServer:function(_1c){dojo.xhrPost({url:"/admin/rpc/make_real",content:{"xB":_1c[0],"yB":_1c[1],"zB":_1c[2]},load:dojo.hitch(this,this._makeRealOnServerSucceeded),error:dojo.hitch(this,this._makeRealOnServerFailed)});},setBlockStateOnServer:function(_1d,_1e){switch(_1e){case 0:this.deleteOnServer(_1d);break;case 1:this.makePendingOnServer(_1d);break;case 2:this.makeRealOnServer(_1d);break;}},zBOfUpperSideOfRealBlockBelow:function(xB,yB,zB){var _1f,_20,_21,bXB,bYB,bZB;_1f=this._realBlocksSorted;_20=zB-1;_21=0;dojo.forEach(_1f,function(b){bXB=b.xB();bYB=b.yB();bZB=b.zB();if(bZB+1<=_20&&xB>=bXB&&xB<=bXB+1&&yB>=bYB&&yB<=bYB+1&&bZB+1>_21){_21=bZB+1;}});return _21;},_renderBlocks:function(_22,_23){if(_22.getContext){var _24=_22.getContext("2d");com.realitybuilder.util.clearCanvas(_22);dojo.forEach(_23,function(b){b.render(_24);});}},render:function(){this._renderBlocks(this._realBlocksCanvas,this._realBlocksSorted);this._renderBlocks(this._pendingBlocksCanvas,this._pendingBlocks);}});}