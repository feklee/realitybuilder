/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["com.realitybuilder.LayerShadow"]){dojo._hasResource["com.realitybuilder.LayerShadow"]=true;dojo.provide("com.realitybuilder.LayerShadow");dojo.declare("com.realitybuilder.LayerShadow",null,{_newBlock:null,_camera:null,_blockProperties:null,_constructionBlocks:null,_fullVertexes:null,_fullVertexesV:null,_fullVertexesS:null,_canvas:null,_helperCanvas:null,constructor:function(_1,_2,_3,_4){var _5;this._newBlock=_1;this._blockProperties=_2;this._camera=_3;this._constructionBlocks=_4;_5=_3.sensor().shadowCanvas();this._canvas=dojo.create("canvas");dojo.attr(this._canvas,"width",_5.width);dojo.attr(this._canvas,"height",_5.height);this._helperCanvas=dojo.create("canvas");dojo.attr(this._helperCanvas,"width",_5.width);dojo.attr(this._helperCanvas,"height",_5.height);if(com.realitybuilder.util.isFlashCanvasActive()){FlashCanvas.initElement(this._canvas);FlashCanvas.initElement(this._helperCanvas);}},canvas:function(){return this._canvas;},_updateWorldSpace:function(_6){var xB=this._newBlock.xB(),yB=this._newBlock.yB(),zB=_6+1,vs=[],_7=this._blockProperties.outlineB(),_8=this;dojo.forEach(_7,function(_9){vs.push(com.realitybuilder.util.blockToWorld([xB+_9[0],yB+_9[1],zB],_8._blockProperties));});this._fullVertexes=vs;},_updateViewSpaceCoordinates:function(_a){this._updateWorldSpace(_a);this._fullVertexesV=dojo.map(this._fullVertexes,dojo.hitch(this._camera,this._camera.worldToView));},_updateSensorSpaceCoordinates:function(_b){this._fullVertexesS=dojo.map(this._fullVertexesV,dojo.hitch(this._camera,this._camera.viewToSensor));},_updateCoordinates:function(_c){this._updateViewSpaceCoordinates(_c);this._updateSensorSpaceCoordinates(_c);},_renderTops:function(_d,_e){var _f=this._constructionBlocks.realBlocksInLayer(_d);dojo.forEach(_f,function(_10){_10.renderSolidTop(_e);});},_renderFull:function(_11,_12){var _13,_14,i;this._updateCoordinates(_11);_13=this._fullVertexesS;_12.fillStyle="red";_14=_13[0];_12.beginPath();_12.moveTo(_14[0],_14[1]);for(i=1;i<_13.length;i+=1){_14=_13[i];_12.lineTo(_14[0],_14[1]);}_12.closePath();_12.fill();},render:function(_15){var _16=this._canvas,_17=this._helperCanvas,_18,_19;if(_16.getContext){_18=_16.getContext("2d");com.realitybuilder.util.clearCanvas(_16);_19=_17.getContext("2d");com.realitybuilder.util.clearCanvas(_17);_18.globalCompositeOperation="source-over";if(_15===-1){com.realitybuilder.util.fillCanvas(_16,"black");}else{this._renderTops(_15,_18);}_19.globalCompositeOperation="source-over";_19.drawImage(_16,0,0);_19.globalCompositeOperation="xor";this._renderFull(_15,_19);this._renderFull(_15,_18);_18.globalCompositeOperation="destination-out";_18.drawImage(_17,0,0);}}});}