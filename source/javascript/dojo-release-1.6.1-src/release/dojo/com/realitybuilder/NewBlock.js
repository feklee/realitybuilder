/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["com.realitybuilder.NewBlock"]){dojo._hasResource["com.realitybuilder.NewBlock"]=true;dojo.provide("com.realitybuilder.NewBlock");dojo.require("com.realitybuilder.Block");dojo.require("com.realitybuilder.Shadow");dojo.declare("com.realitybuilder.NewBlock",com.realitybuilder.Block,{"-chains-":{constructor:"manual"},_versionOnServer:"-1",_moveSpace1B:null,_moveSpace2B:null,_buildSpace1B:null,_buildSpace2B:null,_color:null,_stoppedColor:null,_shadowColor:null,_isStopped:null,_constructionBlocks:null,_shadow:null,_camera:null,_lastPositionB:null,_lastIsStopped:null,_lastConstructionBlocksVersion:null,_prerenderMode:null,constructor:function(_1,_2,_3,_4){this.inherited(arguments,[_1,_2,[0,0,0],0]);this._isStopped=false;this._constructionBlocks=_3;this._shadow=new com.realitybuilder.Shadow(this,_1,_2,_3);this._camera=_2;this._prerenderMode=_4;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},updateWithServerData:function(_5){var _6;if(!this.isInitializedWithServerData()){this._positionB=_5.initPositionB;this._a=_5.initA;_6=true;}else{_6=false;}this._moveSpace1B=_5.moveSpace1B;this._moveSpace2B=_5.moveSpace2B;this._buildSpace1B=_5.buildSpace1B;this._buildSpace2B=_5.buildSpace2B;this._color=_5.color;this._stoppedColor=_5.stoppedColor;this._shadowColor=_5.shadowColor;this._versionOnServer=_5.version;if(_6){dojo.publish("com/realitybuilder/NewBlock/"+"positionAngleInitialized");}dojo.publish("com/realitybuilder/NewBlock/moveOrBuildSpaceChanged");},_collidesWithRealBlock:function(){return this._constructionBlocks.realBlocksCollideWith(this);},move:function(_7){if(!this.wouldGoOutOfRange(_7,0)){this._positionB=com.realitybuilder.util.addVectorsB(this._positionB,_7);dojo.publish("com/realitybuilder/NewBlock/movedOrRotated");}},rotate90:function(){if(!this.wouldGoOutOfRange([0,0,0],1)){this._a=(this._a+1)%4;dojo.publish("com/realitybuilder/NewBlock/movedOrRotated");}},requestMakeReal:function(){if(this.canBeMadeReal()){this._stop();this._createPendingOnServer();dojo.publish("com/realitybuilder/NewBlock/makeRealRequested");}},isRotatable:function(){return !this._isStopped;},isMovable:function(){return !this._isStopped;},isStopped:function(){return this._isStopped;},_stop:function(){this._isStopped=true;dojo.publish("com/realitybuilder/NewBlock/stopped");},_makeMovable:function(){this._isStopped=false;dojo.publish("com/realitybuilder/NewBlock/madeMovable");},updatePositionAndMovability:function(){var _8,_9,_a;if(this.isStopped()){_a=this._constructionBlocks.blockAt(this.positionB());if(_a){if(_a.isDeleted()||_a.isReal()){this._makeMovable();}}}this._updatePositionB();},_updatePositionB:function(){var _b,_c=this._constructionBlocks,xB=this.xB(),yB=this.yB(),_d;if(this._collidesWithRealBlock()){_d=this.zB();do{_d+=1;_b=new com.realitybuilder.Block(this._blockProperties,this._camera,[xB,yB,_d],this.a());}while(_c.realBlocksCollideWith(_b));this._positionB[2]=_d;}},wouldGoOutOfRange:function(_e,_f){var _10,_11,_12;_10=com.realitybuilder.util.addVectorsB(this.positionB(),_e);_12=(this.a()+_f)%4;_11=new com.realitybuilder.Block(this._blockProperties,this._camera,_10,_12);return (this._constructionBlocks.realBlocksCollideWith(_11)||!this._wouldBeInMoveSpace(_10));},_wouldBeInMoveSpace:function(_13){var m1B=this._moveSpace1B,m2B=this._moveSpace2B;return (_13[0]>=m1B[0]&&_13[0]<=m2B[0]&&_13[1]>=m1B[1]&&_13[1]<=m2B[1]&&_13[2]>=0&&_13[2]<=m2B[2]);},_isInBuildSpace:function(){var xB=this._positionB[0],yB=this._positionB[1],zB=this._positionB[2],b1B=this._buildSpace1B,b2B=this._buildSpace2B;return (xB>=b1B[0]&&xB<=b2B[0]&&yB>=b1B[1]&&yB<=b2B[1]&&zB>=b1B[2]&&zB<=b2B[2]);},_isAttachable:function(){return (this._constructionBlocks.realBlocksAreAttachableTo(this)||this.zB()===0);},_isInPrerenderedBlockConfiguration:function(){var _14=this._constructionBlocks.realBlocksSorted();return this._prerenderMode.matchingBlockConfiguration(_14,this)!==false;},canBeMadeReal:function(){return this._isInBuildSpace()&&this._isAttachable()&&(!this._prerenderMode.isEnabled()||this._isInPrerenderedBlockConfiguration());},_boundingBoxesOverlap:function(_15){var l,r,b,t,_16,_17,_18,_19,_1a,_1b;this._updateCoordinates();l=this._boundingBoxS[0][0];r=this._boundingBoxS[1][0];b=this._boundingBoxS[0][1];t=this._boundingBoxS[1][1];_15._updateCoordinates();_16=_15._boundingBoxS[0][0];_17=_15._boundingBoxS[1][0];_18=_15._boundingBoxS[0][1];_19=_15._boundingBoxS[1][1];_1a=(r>=_16&&l<=_17);_1b=(t>=_18&&b<=_19);return _1a&&_1b;},_relationVertexesEdges:function(_1c,_1d){var _1e,len,i,j,_1f,_20,_21,_22;_1e=com.realitybuilder.util;len=_1d.length;for(i=0;i<len;i+=1){_22=[_1d[i],_1d[(i+1)%len]];for(j=0;j<len;j+=1){_21=_1c[j];_1f=_1e.relationPointSegmentVXZ(_21,_22);if(_1f<0||_1f>0){return _1f;}}}return 0;},_isObscuredBySLO:function(_23){var _24,_25,_26;_25=this.projectedVertexesVXZ();_26=_23.projectedVertexesVXZ();if(_25===false||_26===false){return false;}_24=this._relationVertexesEdges(_26,_25);if(_24===0){_24=this._relationVertexesEdges(_25,_26);_24=-_24;}if(_24<0){return true;}else{if(_24>0){return false;}else{return false;}}},_subtractRealBlock:function(_27,_28){if(this._boundingBoxesOverlap(_27)){_27.subtract(_28);}},_subtractRealBlocks:function(_29){var _2a=this._constructionBlocks.realBlocksSorted(),i,_2b,zB=this.zB();for(i=0;i<_2a.length;i+=1){_2b=_2a[i];if(_2b.zB()<zB){break;}else{if(_2b.zB()===zB){if(this._isObscuredBySLO(_2b)){this._subtractRealBlock(_2b,_29);}}else{if(_2b.zB()>zB){this._subtractRealBlock(_2b,_29);}}}}},_renderShadow:function(){if(this.isMovable()){this._shadow.render(this._shadowColor);}else{this._shadow.clear();}},_needsToBeRendered:function(){var _2c,_2d,_2e;_2c=this._coordinatesChangedAfterLastRendering;_2d=(this._lastConstructionBlocksVersion!==this._constructionBlocks.versionOnServer());_2e=(this._lastIsStopped!==this._isStopped);return _2c||_2d||_2e;},_onRendered:function(){this._coordinatesChangedAfterLastRendering=false;this._lastIsStopped=this._isStopped;this._lastConstructionBlocksVersion=this._constructionBlocks.versionOnServer();},render:function(){var _2f,_30,_31;this._updateCoordinates();if(this._needsToBeRendered()){_2f=this._camera.sensor().newBlockCanvas();if(_2f.getContext){_30=_2f.getContext("2d");_31=this.isMovable()?this._color:this._stoppedColor;if(!com.realitybuilder.util.isFlashCanvasActive()){this._renderShadow();}com.realitybuilder.util.clearCanvas(_2f);this.inherited(arguments,[_30,_31]);this._subtractRealBlocks(_30);}this._onRendered();}},_createPendingOnServerSucceeded:function(){dojo.publish("com/realitybuilder/NewBlock/createdPendingOnServer");if(this._prerenderMode.isEnabled()){setTimeout(dojo.hitch(this,this._makeRealPrerenderedOnServer),this._prerenderMode.makeRealAfter());}},_createPendingOnServer:function(){dojo.xhrPost({url:"/rpc/create_pending",content:{"xB":this.xB(),"yB":this.yB(),"zB":this.zB(),"a":this.a()},load:dojo.hitch(this,this._createPendingOnServerSucceeded)});},_makeRealPrerenderedOnServerSucceeded:function(){dojo.publish("com/realitybuilder/ConstructionBlocks/changedOnServer");},_makeRealPrerenderedOnServer:function(){var i,_32,_33;_33=this._constructionBlocks.realBlocksSorted();i=this._prerenderMode.matchingBlockConfiguration(_33,this);if(i!==false){_32=this._prerenderMode.imageUrl(i);dojo.xhrPost({url:"/rpc/make_real_prerendered",content:{"xB":this.xB(),"yB":this.yB(),"zB":this.zB(),"a":this.a(),"imageUrl":this._prerenderMode.imageUrl(i)},load:dojo.hitch(this,this._makeRealPrerenderedOnServerSucceeded)});}else{this._makeMovable();}}});}