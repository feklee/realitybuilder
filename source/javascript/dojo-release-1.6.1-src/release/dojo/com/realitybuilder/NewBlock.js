/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["com.realitybuilder.NewBlock"]){dojo._hasResource["com.realitybuilder.NewBlock"]=true;dojo.provide("com.realitybuilder.NewBlock");dojo.require("com.realitybuilder.Block");dojo.require("com.realitybuilder.Shadow");dojo.declare("com.realitybuilder.NewBlock",com.realitybuilder.Block,{"-chains-":{constructor:"manual"},_versionOnServer:"-1",_moveSpace1B:null,_moveSpace2B:null,_buildSpace1B:null,_buildSpace2B:null,_isStopped:null,_constructionBlocks:null,_shadow:null,_camera:null,_lastPositionB:null,_lastIsStopped:null,_lastConstructionBlocksVersion:null,constructor:function(_1,_2,_3){this.inherited(arguments,[_1,_2,[0,0,0],0]);this._isStopped=false;this._constructionBlocks=_3;this._shadow=new com.realitybuilder.Shadow(this,_1,_2,_3);this._camera=_2;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},updateWithServerData:function(_4){var _5;if(!this.isInitializedWithServerData()){this._positionB=_4.initPositionB;this._a=_4.initA;_5=true;}else{_5=false;}this._moveSpace1B=_4.moveSpace1B;this._moveSpace2B=_4.moveSpace2B;this._buildSpace1B=_4.buildSpace1B;this._buildSpace2B=_4.buildSpace2B;this._versionOnServer=_4.version;if(_5){dojo.publish("com/realitybuilder/NewBlock/"+"positionAngleInitialized");}dojo.publish("com/realitybuilder/NewBlock/moveOrBuildSpaceChanged");},_collidesWithRealBlock:function(){return this._constructionBlocks.realBlocksCollideWith(this);},move:function(_6){if(!this.wouldGoOutOfRange(_6,0)){this._positionB=com.realitybuilder.util.addVectorsB(this._positionB,_6);dojo.publish("com/realitybuilder/NewBlock/movedOrRotated");}},rotate90:function(){if(!this.wouldGoOutOfRange([0,0,0],1)){this._a=(this._a+1)%4;dojo.publish("com/realitybuilder/NewBlock/movedOrRotated");}},requestMakeReal:function(){if(this.canBeMadeReal()){this._stop();this._constructionBlocks.createPendingOnServer(this);dojo.publish("com/realitybuilder/NewBlock/makeRealRequested");}},isRotatable:function(){return !this._isStopped;},isMovable:function(){return !this._isStopped;},isStopped:function(){return this._isStopped;},_stop:function(){this._isStopped=true;dojo.publish("com/realitybuilder/NewBlock/stopped");},_makeMovable:function(){this._isStopped=false;dojo.publish("com/realitybuilder/NewBlock/madeMovable");},updatePositionAndMovability:function(){var _7,_8,_9;if(this.isStopped()){_9=this._constructionBlocks.blockAt(this.positionB());if(_9){if(_9.isDeleted()||_9.isReal()){this._makeMovable();}}}this._updatePositionB();},_updatePositionB:function(){var _a,_b=this._constructionBlocks,xB=this.xB(),yB=this.yB(),_c;if(this._collidesWithRealBlock()){_c=this.zB();do{_c+=1;_a=new com.realitybuilder.Block(this._blockProperties,this._camera,[xB,yB,_c],this.a());}while(_b.realBlocksCollideWith(_a));this._positionB[2]=_c;}},wouldGoOutOfRange:function(_d,_e){var _f,_10,_11;_f=com.realitybuilder.util.addVectorsB(this.positionB(),_d);_11=(this.a()+_e)%4;_10=new com.realitybuilder.Block(this._blockProperties,this._camera,_f,_11);return (this._constructionBlocks.realBlocksCollideWith(_10)||!this._wouldBeInMoveSpace(_f));},_wouldBeInMoveSpace:function(_12){var m1B=this._moveSpace1B,m2B=this._moveSpace2B;return (_12[0]>=m1B[0]&&_12[0]<=m2B[0]&&_12[1]>=m1B[1]&&_12[1]<=m2B[1]&&_12[2]>=0&&_12[2]<=m2B[2]);},_isInBuildSpace:function(){var xB=this._positionB[0],yB=this._positionB[1],zB=this._positionB[2],b1B=this._buildSpace1B,b2B=this._buildSpace2B;return (xB>=b1B[0]&&xB<=b2B[0]&&yB>=b1B[1]&&yB<=b2B[1]&&zB>=b1B[2]&&zB<=b2B[2]);},_isAttachable:function(){return (this._constructionBlocks.realBlocksAreAttachableTo(this)||this.zB()===0);},canBeMadeReal:function(){return this._isInBuildSpace()&&this._isAttachable();},_boundingBoxesOverlap:function(_13){var l,r,b,t,_14,_15,_16,_17,_18,_19;this._updateCoordinates();l=this._boundingBoxS[0][0];r=this._boundingBoxS[1][0];b=this._boundingBoxS[0][1];t=this._boundingBoxS[1][1];_13._updateCoordinates();_14=_13._boundingBoxS[0][0];_15=_13._boundingBoxS[1][0];_16=_13._boundingBoxS[0][1];_17=_13._boundingBoxS[1][1];_18=(r>=_14&&l<=_15);_19=(t>=_16&&b<=_17);return _18&&_19;},_relationVertexesEdges:function(_1a,_1b){var _1c,len,i,j,_1d,_1e,_1f,_20;_1c=com.realitybuilder.util;len=_1b.length;for(i=0;i<len;i+=1){_20=[_1b[i],_1b[(i+1)%len]];for(j=0;j<len;j+=1){_1f=_1a[j];_1d=_1c.relationPointSegmentVXZ(_1f,_20);if(_1d<0||_1d>0){return _1d;}}}return 0;},_isObscuredBySLO:function(_21){var _22,_23,_24;_23=this.projectedVertexesVXZ();_24=_21.projectedVertexesVXZ();if(_23===false||_24===false){return false;}_22=this._relationVertexesEdges(_24,_23);if(_22===0){_22=this._relationVertexesEdges(_23,_24);_22=-_22;}if(_22<0){return true;}else{if(_22>0){return false;}else{return false;}}},_subtractRealBlock:function(_25,_26){if(this._boundingBoxesOverlap(_25)){_25.subtract(_26);}},_subtractRealBlocks:function(_27){var _28=this._constructionBlocks.realBlocksSorted(),i,_29,zB=this.zB();for(i=0;i<_28.length;i+=1){_29=_28[i];if(_29.zB()<zB){break;}else{if(_29.zB()===zB){if(this._isObscuredBySLO(_29)){this._subtractRealBlock(_29,_27);}}else{if(_29.zB()>zB){this._subtractRealBlock(_29,_27);}}}}},_renderShadow:function(){if(this.isMovable()){this._shadow.render();}else{this._shadow.clear();}},_needsToBeRendered:function(){var _2a,_2b,_2c;_2a=this._coordinatesChangedAfterLastRendering;_2b=(this._lastConstructionBlocksVersion!==this._constructionBlocks.versionOnServer());_2c=(this._lastIsStopped!==this._isStopped);return _2a||_2b||_2c;},_onRendered:function(){this._coordinatesChangedAfterLastRendering=false;this._lastIsStopped=this._isStopped;this._lastConstructionBlocksVersion=this._constructionBlocks.versionOnServer();},render:function(){var _2d,_2e,_2f;this._updateCoordinates();if(this._needsToBeRendered()){_2d=this._camera.sensor().newBlockCanvas();if(_2d.getContext){_2e=_2d.getContext("2d");_2f=this.isMovable()?"red":"white";if(!com.realitybuilder.util.isFlashCanvasActive()){this._renderShadow();}com.realitybuilder.util.clearCanvas(_2d);this.inherited(arguments,[_2e,_2f]);this._subtractRealBlocks(_2e);}this._onRendered();}}});}