/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["com.realitybuilder.NewBlock"]){dojo._hasResource["com.realitybuilder.NewBlock"]=true;dojo.provide("com.realitybuilder.NewBlock");dojo.require("com.realitybuilder.Block");dojo.require("com.realitybuilder.Shadow");dojo.declare("com.realitybuilder.NewBlock",com.realitybuilder.Block,{"-chains-":{constructor:"manual"},_versionOnServer:"-1",_buildSpace1B:null,_buildSpace2B:null,_state:null,_constructionBlocks:null,_shadow:null,_camera:null,_lastPositionB:null,_lastState:null,_lastConstructionBlocksVersion:null,constructor:function(_1,_2,_3){this.inherited(arguments,[_1,_2,[0,0,0]]);this._state=1;this._constructionBlocks=_3;this._shadow=new com.realitybuilder.Shadow(this,_1,_2,_3);this._camera=_2;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},updateWithServerData:function(_4){var _5,_6;_5=!this.isInitializedWithServerData();if(_5){this._positionB=[_4.initXB,_4.initYB,_4.initZB];_6=true;}else{_6=false;}this._buildSpace1B=[_4.buildSpace1XB,_4.buildSpace1YB,_4.buildSpace1ZB];this._buildSpace2B=[_4.buildSpace2XB,_4.buildSpace2YB,_4.buildSpace2ZB];this._versionOnServer=_4.version;if(_6){dojo.publish("com/realitybuilder/NewBlock/positionInitialized");}dojo.publish("com/realitybuilder/NewBlock/buildSpaceChanged");},collidesWithRealBlock:function(){return this._constructionBlocks.realBlocksCollideWith(this);},_viewSpaceNeedsToBeUpdated:function(){return (this._lastPositionB===null||!com.realitybuilder.util.pointsIdenticalB(this._lastPositionB,this._positionB)||this.inherited(arguments));},_onViewSpaceUpdated:function(){this._lastPositionB=dojo.clone(this._positionB);this.inherited(arguments);},move:function(_7){if(!this.wouldGoOutOfRange(_7)){this._positionB=com.realitybuilder.util.addVectorsB(this._positionB,_7);}dojo.publish("com/realitybuilder/NewBlock/moved");},isMovable:function(){return this._state===1;},isStopped:function(){return this._state===0;},stop:function(){this._state=0;dojo.publish("com/realitybuilder/NewBlock/stopped");},makeMovable:function(){this._state=1;dojo.publish("com/realitybuilder/NewBlock/madeMovable");},maxZB:function(){return this._buildSpace2B[2];},updatePositionB:function(){var _8,_9=this._constructionBlocks,xB=this.xB(),yB=this.yB(),_a;if(this.collidesWithRealBlock()){_a=this.zB();do{_a+=1;_8=new com.realitybuilder.Block(this._blockProperties,this._camera,[xB,yB,_a]);}while(_9.realBlocksCollideWith(_8));this._positionB[2]=_a;}},wouldGoOutOfRange:function(_b){var _c,_d,_e=this._constructionBlocks;_c=com.realitybuilder.util.addVectorsB(this._positionB,_b);_d=new com.realitybuilder.Block(this._blockProperties,this._camera,_c);return (_e.realBlocksCollideWith(_d)||!this._wouldBeInMoveSpace(_c));},_wouldBeInMoveSpace:function(_f){var b1B=this._buildSpace1B,b2B=this._buildSpace2B;return (_f[0]>=b1B[0]-2&&_f[0]<=b2B[0]&&_f[1]>=b1B[1]-2&&_f[1]<=b2B[1]&&_f[2]>=0&&_f[2]<=b2B[2]+1);},_isInBuildSpace:function(){var xB=this._positionB[0],yB=this._positionB[1],zB=this._positionB[2],b1B=this._buildSpace1B,b2B=this._buildSpace2B;return (xB>=b1B[0]&&xB<=b2B[0]-2&&yB>=b1B[1]&&yB<=b2B[1]-2&&zB>=b1B[2]&&zB<=b2B[2]);},_isAttachable:function(){return (this._constructionBlocks.realBlocksAreAttachableTo(this)||this.zB()===0);},canBeMadeReal:function(){return this._isInBuildSpace()&&this._isAttachable();},_boundingBoxesOverlap:function(_10){return (this._boundingBoxS[1][0]>=_10._boundingBoxS[0][0]&&this._boundingBoxS[0][0]<=_10._boundingBoxS[1][0]&&this._boundingBoxS[1][1]>=_10._boundingBoxS[0][1]&&this._boundingBoxS[0][1]<=_10._boundingBoxS[1][1]);},_isObscuredBySLO:function(_11){var i,j,_12,_13,_14,len,_15,_16,_17,_18;_18=com.realitybuilder.util;_13=this.projectedVertexesVXZ();_14=_11.projectedVertexesVXZ();if(_13===false||_14===false){return false;}len=_13.length;for(i=0;i<len;i+=1){_17=[_13[i],_13[(i+1)%len]];for(j=0;j<len;j+=1){_16=_14[j];_12=_18.relationPointSegmentVXZ(_16,_17);if(_12<0){return true;}else{if(_12>0){return false;}}}}return false;},_subtractRealBlock:function(_19,_1a){if(this._boundingBoxesOverlap(_19)){_19.subtract(_1a);}},_subtractRealBlocks:function(_1b){var _1c=this._constructionBlocks.realBlocksSorted(),i,_1d,zB=this.zB();for(i=0;i<_1c.length;i+=1){_1d=_1c[i];if(_1d.zB()<zB){break;}else{if(_1d.zB()===zB){if(this._isObscuredBySLO(_1d)){this._subtractRealBlock(_1d,_1b);}}else{if(_1d.zB()>zB){this._subtractRealBlock(_1d,_1b);}}}}},_renderShadow:function(){if(this.isMovable()){this._shadow.render();}else{this._shadow.clear();}},_needsToBeRendered:function(){var _1e,_1f,_20;_1e=this._coordinatesChangedAfterLastRendering;_1f=(this._lastConstructionBlocksVersion!==this._constructionBlocks.versionOnServer());_20=(this._lastState!==this._state);return _1e||_1f||_20;},_onRendered:function(){this._coordinatesChangedAfterLastRendering=false;this._lastState=this._state;this._lastConstructionBlocksVersion=this._constructionBlocks.versionOnServer();},render:function(){var _21,_22,_23;this._updateCoordinates();if(this._needsToBeRendered()){_21=this._camera.sensor().newBlockCanvas();if(_21.getContext){_22=_21.getContext("2d");_23=this.isMovable()?"red":"white";if(!com.realitybuilder.util.isFlashCanvasActive()){this._renderShadow();}com.realitybuilder.util.clearCanvas(_21);this.inherited(arguments,[_22,_23]);this._subtractRealBlocks(_22);}this._onRendered();}}});}