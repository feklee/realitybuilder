/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["realitybuilder.ConstructionBlocks"]){dojo._hasResource["realitybuilder.ConstructionBlocks"]=true;dojo.provide("realitybuilder.ConstructionBlocks");dojo.require("realitybuilder.ConstructionBlock");dojo.require("realitybuilder.util");dojo.declare("realitybuilder.ConstructionBlocks",null,{_versionOnServer:"-1",_construction:null,_blockProperties:null,_constructionBlockProperties:null,_blocks:null,_realBlocksSorted:null,_pendingBlocks:null,_realBlocksCanvas:null,_pendingBlocksCanvas:null,constructor:function(_1,_2,_3){this._blockProperties=_2;this._constructionBlockProperties=_3;this._blocks=[];this._realBlocksSorted=[];this._construction=_1;var _4=_1.camera().sensor();this._realBlocksCanvas=_4.realBlocksCanvas();this._pendingBlocksCanvas=_4.pendingBlocksCanvas();},blocks:function(){return this._blocks;},pendingBlocks:function(){return this._pendingBlocks;},realBlocksSorted:function(){return this._realBlocksSorted;},highestRealBlocksZB:function(){if(this._realBlocksSorted.length>0){return this._realBlocksSorted[0].zB();}else{return -1;}},realBlocksInLayer:function(zB){var _5=[],i,_6=this._realBlocksSorted,_7;for(i=0;i<_6.length;i+=1){_7=_6[i];if(_7.zB()===zB){_5.push(_7);}else{if(_7.zB()<zB){break;}}}return _5;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},_createBlockFromServerData:function(_8){var _9=this._construction.camera(),rb=realitybuilder;return new rb.ConstructionBlock(this._blockProperties,_9,_8.positionB,_8.a,this._constructionBlockProperties,_8.state,_8.timeStamp);},updateWithServerData:function(_a){this._versionOnServer=_a.version;this._blocks=dojo.map(_a.blocks,dojo.hitch(this,this._createBlockFromServerData));this._updateRealBlocksSorted();this._updatePendingBlocks();dojo.publish("realitybuilder/ConstructionBlocks/changed");},_sortByHeight:function(_b,_c){if(_b.zB()>_c.zB()){return -1;}else{if(_b.zB()<_c.zB()){return 1;}else{return 0;}}},_updateRealBlocksSorted:function(_d){var _e=dojo.filter(this._blocks,function(_f){return _f.isReal();});_e.sort(this._sortByHeight);this._realBlocksSorted=_e;},_updatePendingBlocks:function(_10){this._pendingBlocks=dojo.filter(this._blocks,function(_11){return _11.isPending();});},blockAt:function(_12){var _13=this.blocks(),_14,i;for(i=0;i<_13.length;i+=1){_14=_13[i];if(realitybuilder.util.pointsIdenticalB(_12,_14.positionB())){return _14;}}return false;},realBlocksCollideWith:function(_15){var _16=this.realBlocksSorted(),_17,i;for(i=0;i<_16.length;i+=1){_17=_16[i];if(_17.collidesWith(_15)){return true;}}return false;},realBlocksAreAttachableTo:function(_18){var _19=this.realBlocksSorted(),_1a,i;for(i=0;i<_19.length;i+=1){_1a=_19[i];if(_1a.attachableTo(_18)){return true;}}return false;},_makePendingOnServerSucceeded:function(){dojo.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_makePendingOnServerFailed:function(){dojo.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},makePendingOnServer:function(_1b,a){dojo.xhrPost({url:"/admin/rpc/make_pending",content:{"xB":_1b[0],"yB":_1b[1],"zB":_1b[2],"a":a},load:dojo.hitch(this,this._makePendingOnServerSucceeded),error:dojo.hitch(this,this._makePendingOnServerFailed)});},_deleteOnServerSucceeded:function(){dojo.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_deleteOnServerFailed:function(){dojo.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},deleteOnServer:function(_1c,a){dojo.xhrPost({url:"/admin/rpc/delete",content:{"xB":_1c[0],"yB":_1c[1],"zB":_1c[2],"a":a},load:dojo.hitch(this,this._deleteOnServerSucceeded),error:dojo.hitch(this,this._deleteOnServerFailed)});},_makeRealOnServerSucceeded:function(){dojo.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_makeRealOnServerFailed:function(){dojo.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},makeRealOnServer:function(_1d,a){dojo.xhrPost({url:"/admin/rpc/make_real",content:{"xB":_1d[0],"yB":_1d[1],"zB":_1d[2],"a":a},load:dojo.hitch(this,this._makeRealOnServerSucceeded),error:dojo.hitch(this,this._makeRealOnServerFailed)});},setBlockStateOnServer:function(_1e,a,_1f){switch(_1f){case 0:this.deleteOnServer(_1e,a);break;case 1:this.makePendingOnServer(_1e,a);break;case 2:this.makeRealOnServer(_1e,a);break;}},zBOfUpperSideOfRealBlockBelow:function(xB,yB,zB){var _20,_21,_22,bXB,bYB,bZB;_20=this._realBlocksSorted;_21=zB-1;_22=0;dojo.forEach(_20,function(b){bXB=b.xB();bYB=b.yB();bZB=b.zB();if(bZB+1<=_21&&xB>=bXB&&xB<=bXB+1&&yB>=bYB&&yB<=bYB+1&&bZB+1>_22){_22=bZB+1;}});return _22;},_renderBlocks:function(_23,_24){if(_23.getContext){var _25=_23.getContext("2d");realitybuilder.util.clearCanvas(_23);dojo.forEach(_24,function(b){b.render(_25);});}},render:function(){this._renderBlocks(this._realBlocksCanvas,this._realBlocksSorted);this._renderBlocks(this._pendingBlocksCanvas,this._pendingBlocks);}});}