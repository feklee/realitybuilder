/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


realitybuilderDojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","realitybuilder.ConstructionBlocks"],["require","realitybuilder.ConstructionBlock"],["require","realitybuilder.util"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["realitybuilder.ConstructionBlocks"]){_4._hasResource["realitybuilder.ConstructionBlocks"]=true;_4.provide("realitybuilder.ConstructionBlocks");_4.require("realitybuilder.ConstructionBlock");_4.require("realitybuilder.util");_4.declare("realitybuilder.ConstructionBlocks",null,{_versionOnServer:"-1",_construction:null,_blockProperties:null,_constructionBlockProperties:null,_blocks:null,_realBlocksSorted:null,_pendingBlocks:null,_realBlocksCanvas:null,_pendingBlocksCanvas:null,constructor:function(_7,_8,_9){this._blockProperties=_8;this._constructionBlockProperties=_9;this._blocks=[];this._realBlocksSorted=[];this._construction=_7;var _a=_7.camera().sensor();this._realBlocksCanvas=_a.realBlocksCanvas();this._pendingBlocksCanvas=_a.pendingBlocksCanvas();},blocks:function(){return this._blocks;},pendingBlocks:function(){return this._pendingBlocks;},realBlocksSorted:function(){return this._realBlocksSorted;},highestRealBlocksZB:function(){if(this._realBlocksSorted.length>0){return this._realBlocksSorted[0].zB();}else{return -1;}},realBlocksInLayer:function(zB){var _b=[],i,_c=this._realBlocksSorted,_d;for(i=0;i<_c.length;i+=1){_d=_c[i];if(_d.zB()===zB){_b.push(_d);}else{if(_d.zB()<zB){break;}}}return _b;},versionOnServer:function(){return this._versionOnServer;},isInitializedWithServerData:function(){return this._versionOnServer!=="-1";},_createBlockFromServerData:function(_e){var _f=this._construction.camera(),rb=realitybuilder;return new rb.ConstructionBlock(this._blockProperties,_f,_e.positionB,_e.a,this._constructionBlockProperties,_e.state,_e.timeStamp);},updateWithServerData:function(_10){this._versionOnServer=_10.version;this._blocks=_4.map(_10.blocks,_4.hitch(this,this._createBlockFromServerData));this._updateRealBlocksSorted();this._updatePendingBlocks();_4.publish("realitybuilder/ConstructionBlocks/changed");},_sortByHeight:function(_11,_12){if(_11.zB()>_12.zB()){return -1;}else{if(_11.zB()<_12.zB()){return 1;}else{return 0;}}},_updateRealBlocksSorted:function(_13){var tmp=_4.filter(this._blocks,function(_14){return _14.isReal();});tmp.sort(this._sortByHeight);this._realBlocksSorted=tmp;},_updatePendingBlocks:function(_15){this._pendingBlocks=_4.filter(this._blocks,function(_16){return _16.isPending();});},blockAt:function(_17){var _18=this.blocks(),_19,i;for(i=0;i<_18.length;i+=1){_19=_18[i];if(realitybuilder.util.pointsIdenticalB(_17,_19.positionB())){return _19;}}return false;},realBlocksCollideWith:function(_1a){var _1b=this.realBlocksSorted(),_1c,i;for(i=0;i<_1b.length;i+=1){_1c=_1b[i];if(_1c.collidesWith(_1a)){return true;}}return false;},realBlocksAreAttachableTo:function(_1d){var _1e=this.realBlocksSorted(),_1f,i;for(i=0;i<_1e.length;i+=1){_1f=_1e[i];if(_1f.attachableTo(_1d)){return true;}}return false;},_makePendingOnServerSucceeded:function(){_4.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_makePendingOnServerFailed:function(){_4.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},makePendingOnServer:function(_20,a){_4.xhrPost({url:"/admin/rpc/make_pending",content:{"xB":_20[0],"yB":_20[1],"zB":_20[2],"a":a},load:_4.hitch(this,this._makePendingOnServerSucceeded),error:_4.hitch(this,this._makePendingOnServerFailed)});},_deleteOnServerSucceeded:function(){_4.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_deleteOnServerFailed:function(){_4.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},deleteOnServer:function(_21,a){_4.xhrPost({url:"/admin/rpc/delete",content:{"xB":_21[0],"yB":_21[1],"zB":_21[2],"a":a},load:_4.hitch(this,this._deleteOnServerSucceeded),error:_4.hitch(this,this._deleteOnServerFailed)});},_makeRealOnServerSucceeded:function(){_4.publish("realitybuilder/ConstructionBlocks/changedOnServer");},_makeRealOnServerFailed:function(){_4.publish("realitybuilder/ConstructionBlocks/"+"changeOnServerFailed");},makeRealOnServer:function(_22,a){_4.xhrPost({url:"/admin/rpc/make_real",content:{"xB":_22[0],"yB":_22[1],"zB":_22[2],"a":a},load:_4.hitch(this,this._makeRealOnServerSucceeded),error:_4.hitch(this,this._makeRealOnServerFailed)});},setBlockStateOnServer:function(_23,a,_24){switch(_24){case 0:this.deleteOnServer(_23,a);break;case 1:this.makePendingOnServer(_23,a);break;case 2:this.makeRealOnServer(_23,a);break;}},zBOfUpperSideOfRealBlockBelow:function(xB,yB,zB){var _25,_26,_27,bXB,bYB,bZB;_25=this._realBlocksSorted;_26=zB-1;_27=0;_4.forEach(_25,function(b){bXB=b.xB();bYB=b.yB();bZB=b.zB();if(bZB+1<=_26&&xB>=bXB&&xB<=bXB+1&&yB>=bYB&&yB<=bYB+1&&bZB+1>_27){_27=bZB+1;}});return _27;},_renderBlocks:function(_28,_29){if(_28.getContext){var _2a=_28.getContext("2d");realitybuilder.util.clearCanvas(_28);_4.forEach(_29,function(b){b.render(_2a);});}},render:function(){this._renderBlocks(this._realBlocksCanvas,this._realBlocksSorted);this._renderBlocks(this._pendingBlocksCanvas,this._pendingBlocks);}});}}};});